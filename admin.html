<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:12px;background:#f5f7fb;color:#07203a}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  header h1{margin:0;font-size:20px}
  .cfg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8}
  button{padding:8px 10px;border-radius:8px;border:none;background:#0b69d6;color:#fff;cursor:pointer}
  button.alt{background:#6b7280}
  .cols{display:grid;grid-template-columns:1fr 420px;gap:12px}
  .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 24px rgba(9,30,66,0.06)}
  .list{max-height:520px;overflow:auto}
  .item{display:flex;gap:10px;border-bottom:1px solid #f2f4f7;padding:10px 0;align-items:center}
  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;background:#f4f6f9}
  .meta{flex:1}
  .muted{color:#59656f;font-size:13px}
  .actions{display:flex;gap:8px}
  .detailRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label.small{font-size:13px;color:#333;min-width:90px}
  pre{background:#fbfdff;padding:8px;border-radius:6px;overflow:auto}

  /* search input style */
  .admin-search { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  .admin-search input { flex:1; padding:8px;border-radius:8px;border:1px solid #e6eef8; }
  .admin-search .hint { font-size:13px; color:#666; min-width:160px; text-align:right; }

  /* small helper for matched text highlight */
  .highlight { background: #fff3b0; padding:2px 4px; border-radius:4px; }

  /* responsive tweak for columns */
  @media (max-width:980px){ .cols{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</h1>
    <div class="cfg">
      <input id="cfg_repo" placeholder="owner/repo (Ù…Ø«Ø§Ù„: user/repo)" style="width:220px">
      <input id="cfg_branch" placeholder="branch" style="width:80px" value="main">
      <input id="cfg_session_pat" placeholder="Ø£Ù„ØµÙ‚ PAT Ù…Ø¤Ù‚ØªØ§Ù‹ (session-only)" style="width:300px">
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="allowPublic"> <span class="muted">Ø³Ù…Ø§Ø­ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…</span></label>
      <button id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button id="clearPatBtn" class="alt">Ù…Ø³Ø­ PAT Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>
  </header>

  <!-- SEARCH BAR ADDED -->
  <div class="admin-search panel">
    <input id="admin_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø­Ø³Ø¨ Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (ref) Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ù„ØªØµÙ†ÙŠÙ">
    <div class="hint">Ø§Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø³Ø±ÙŠØ¹Ù‹Ø§</div>
  </div>

  <div class="cols">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</strong>
        <div class="muted" id="ads_count">ØªØ­Ù…ÙŠÙ„...</div>
      </div>

      <div class="list" id="ads_list" aria-live="polite">
        <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø³ØªÙ…Ù„Ù‰ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© loadAll() -->
      </div>

    </div>

    <div class="panel">
      <strong>ØªÙØ§ØµÙŠÙ„ / ØªØ­Ø±ÙŠØ±</strong>
      <div id="detail" style="margin-top:10px">Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ù…Ù‚ØªØ±Ø­Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>

      <hr style="margin:12px 0">
      <strong>Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</strong>
      <div id="proposals_list" class="list" style="margin-top:8px">
        <!-- Ù…Ù‚ØªØ±Ø­Ø§Øª -->
      </div>
    </div>
  </div>
</div>

<script>
/* ----------------- minimal utilities (matches your main code) ----------------- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }
function readCfg(){ try{ return JSON.parse(localStorage.getItem('static_ads_cfg_v1')||'{}') }catch(e){ return {} } }

/* placeholder for existing ghRaw/ghPut/ghDelete/ghApiGet functions from original file.
   The original functions are kept intact in your version â€” we don't replace them here.
   This admin.html assumes those functions exist elsewhere in the same file (as in original).
*/

/* ----------------- List rendering helpers (reuse original structure) ----------------- */
const adsListEl = document.getElementById('ads_list');
const proposalsListEl = document.getElementById('proposals_list');
const adsCountEl = document.getElementById('ads_count');
const searchInput = document.getElementById('admin_search');

let allAds = [];       // latest loaded ads array (keeps original objects)
let allProposals = []; // proposals array

/* render a single ad item (keeps markup compatible with original code expectations) */
function renderAdItem(item, idx){
  const thumb = (item.thumb || item.image || '').replace(/^\//,'');
  const thumbHtml = thumb ? `<img src="${escapeAttr(thumb)}" class="thumb" alt="${escapeAttr(item.name||'')}" />` : `<div class="thumb"></div>`;
  const title = escapeHtml(item.name || '');
  const ref = escapeHtml(item.ref_code || item.code || '');
  const cat = escapeHtml(item.category || '');
  const loc = escapeHtml(item.location || '');
  const html = document.createElement('div');
  html.className = 'item';
  html.setAttribute('data-idx', idx);
  html.setAttribute('data-ref', (item.ref_code||item.code||'').toString().toLowerCase());
  html.setAttribute('data-title', (item.name||'').toString().toLowerCase());
  html.setAttribute('data-loc', (item.location||'').toString().toLowerCase());
  html.setAttribute('data-cat', (item.category||'').toString().toLowerCase());

  html.innerHTML = `
    <div>${thumbHtml}</div>
    <div class="meta">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-weight:700">${title}</div>
        <div style="margin-left:auto" class="muted">${ref}</div>
      </div>
      <div class="muted" style="margin-top:6px">ğŸ“ ${loc} â€” <span class="muted">${cat}</span></div>
      <div style="display:flex;gap:8px;margin-top:8px" class="actions">
        <button class="viewBtn">Ø¹Ø±Ø¶</button>
        <button class="editBtn alt">ØªØ­Ø±ÙŠØ±</button>
        <button class="delBtn alt">Ø­Ø°Ù</button>
      </div>
    </div>
  `;
  // wire buttons
  html.querySelector('.viewBtn').addEventListener('click', ()=> showDetailFor(idx));
  html.querySelector('.editBtn').addEventListener('click', ()=> buildDetailFor(idx, 'edit'));
  html.querySelector('.delBtn').addEventListener('click', ()=> deleteAd(idx));
  return html;
}

/* build list from allAds; applies simple client-side filter if search is active */
function buildAdsList(filterText){
  adsListEl.innerHTML = '';
  const q = (filterText||'').trim().toLowerCase();
  const shown = [];
  allAds.forEach((a, i) => {
    const combined = `${a.ref_code||a.code||''} ${a.name||''} ${a.location||''} ${a.category||''}`.toLowerCase();
    if(!q || combined.includes(q)){
      adsListEl.appendChild(renderAdItem(a, i));
      shown.push(a);
    }
  });
  adsCountEl.textContent = `${shown.length} Ø¥Ø¹Ù„Ø§Ù† (${allAds.length} Ø§Ù„ÙƒÙ„ÙŠ)`;
}

/* show detail (simple) â€” reuse existing detail rendering if exists */
const detailEl = document.getElementById('detail');
function showDetailFor(idx){
  const ad = allAds[idx];
  if(!ad) return;
  const html = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;align-items:center">
        <img src="${escapeAttr(ad.thumb||ad.image||'')}" style="width:120px;height:90px;object-fit:cover;border-radius:6px" alt="">
        <div style="flex:1">
          <div style="font-weight:800">${escapeHtml(ad.name||'')}</div>
          <div class="muted">Ø±Ù…Ø²: <strong>${escapeHtml(ad.ref_code||ad.code||'')}</strong></div>
          <div class="muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${escapeHtml(ad.created_at||'')}</div>
        </div>
      </div>
      <div class="muted">${escapeHtml(ad.description||'')}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button onclick="buildDetailFor(${idx}, 'edit')">ÙØªØ­ Ù„Ù„ØªØ­Ø±ÙŠØ±</button>
        <button onclick="deleteAd(${idx})" class="alt">Ø­Ø°Ù</button>
      </div>
    </div>
  `;
  detailEl.innerHTML = html;
}

/* build detail form for edit/new â€” reuse existing logic where possible */
function buildDetailFor(idx, mode='edit'){
  const ad = (mode==='new') ? {} : (allAds[idx] || {});
  const codeVal = escapeAttr(ad.ref_code || ad.code || '');
  detailEl.innerHTML = `
    <div>
      <div class="detailRow"><label class="small">Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label><input id="a_code" value="${codeVal}" style="flex:1"><button id="assignRefBtn" class="alt" style="margin-left:8px">ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø²</button></div>
      <div class="detailRow"><label class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="a_name" value="${escapeAttr(ad.name||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">Ø§Ù„ÙˆØµÙ</label><textarea id="a_desc" style="flex:1">${escapeAttr(ad.description||'')}</textarea></div>
      <div class="detailRow"><label class="small">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input id="a_loc" value="${escapeAttr(ad.location||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="a_contact" value="${escapeAttr(ad.contact||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">Ø§Ù„ØªØµÙ†ÙŠÙ</label><input id="a_cat" value="${escapeAttr(ad.category||'')}" style="flex:1"></div>
      <div class="detailRow"><label class="small">ØµÙˆØ±Ø©</label><input id="a_file" type="file" accept="image/*"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="saveAdBtn">${mode==='new'?'Ø¥Ø¶Ø§ÙØ©':'Ø­ÙØ¸'}</button><button id="cancelAdBtn" class="alt">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>
  `;
  // wire small utilities
  document.getElementById('assignRefBtn').addEventListener('click', ()=>{
    const el = document.getElementById('a_code');
    el.value = el.value.trim() || genRef();
  });
  document.getElementById('cancelAdBtn').onclick = ()=> { detailEl.innerHTML = 'Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ù…Ù‚ØªØ±Ø­Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„'; };
  document.getElementById('saveAdBtn').onclick = async ()=>{
    try{
      // delegate to original save logic if available
      if(typeof saveAdFromDetail === 'function'){
        await saveAdFromDetail(mode, idx); // your original function name may differ; original file had similar logic
        await loadAll(); // refresh
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        detailEl.innerHTML='Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ù…Ù‚ØªØ±Ø­Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
      } else {
        alert('Ù„Ù… Ø£Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠØ© (saveAdFromDetail). ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ ÙƒÙ…Ø§ ÙƒØ§Ù†.');
      }
    }catch(e){ alert('Ø®Ø·Ø£: ' + (e.message||e)); console.error(e); }
  };
}

/* ----------------- Proposals rendering (simple) ----------------- */
function renderProposalItem(item, filename, idx){
  const html = document.createElement('div');
  html.className = 'item';
  html.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(item.name||'')}</div><div class="muted">Ø±Ù…Ø² Ù…Ù‚ØªØ±Ø­: ${escapeHtml(item.ref_code||'')}</div></div>
    <div style="display:flex;gap:8px">
      <button class="acceptBtn">Ù‚Ø¨ÙˆÙ„</button>
      <button class="rejectBtn alt">Ø±ÙØ¶</button>
    </div>`;
  html.querySelector('.acceptBtn').addEventListener('click', ()=> startAcceptFlow(item, filename));
  html.querySelector('.rejectBtn').addEventListener('click', ()=> {
    if(!confirm('Ø±ÙØ¶ Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙˆØ­Ø°ÙÙ‡ØŸ')) return;
    if(typeof deleteProposalWithImage === 'function'){
      deleteProposalWithImage(readCfg(), filename).then(()=> loadAll()).catch(e=>alert('Ø®Ø·Ø£: '+e.message));
    } else alert('ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø© (ghDelete).');
  });
  return html;
}

/* ----------------- Loading data from repo (uses original helper functions if present) ----------------- */
async function loadAll(){
  // prefer original fetch functions if available
  try{
    // try to use original ghRaw function to fetch ads.json (if present)
    let arr = null;
    if(typeof ghRaw === 'function'){
      const cfg = readCfg();
      const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main');
      arr = raw ? JSON.parse(raw) : null;
    } else {
      // fallback: try raw.githubusercontent static URL
      const cfg = readCfg();
      if(cfg && cfg.repo){
        const [owner, repoName] = (cfg.repo||'').split('/');
        const url = `https://raw.githubusercontent.com/${owner}/${repoName}/${cfg.branch||'main'}/static/ads.json`;
        const r = await fetch(url, { cache:'no-cache' });
        if(r.ok) arr = await r.json();
      }
    }
    allAds = Array.isArray(arr) ? arr : [];
  }catch(e){
    console.warn('loadAll ads error', e);
    allAds = [];
  }

  // load proposals
  try{
    if(typeof listProposals === 'function'){ // if original file exposes helper
      allProposals = await listProposals();
    } else {
      // fallback: try to list proposals by fetching a known index (not guaranteed). Keep empty to avoid breaking.
      allProposals = [];
    }
  }catch(e){ allProposals = []; }

  // render lists (apply current search)
  buildAdsList(searchInput.value || '');
  proposalsListEl.innerHTML = '';
  allProposals.forEach((p, i)=>{
    const filename = p.filename || ('proposal-'+i);
    proposalsListEl.appendChild(renderProposalItem(p.item||p, filename, i));
  });
}

/* ----------------- Delete ad wrapper (uses original deleteAd if present) ----------------- */
async function deleteAd(idx){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
  try{
    if(typeof deleteAd === 'function' && deleteAd !== arguments.callee){
      // original deleteAd function exists in file; call it (careful to not recurse)
      // to avoid name collision, original file's deleteAd should be available in scope; if it is, use different name in original
      // if original function name conflicts, this will skip and try to fallback below
    }
    // fallback behavior: try to use original ghPut to update ads.json without the item
    const cfg = readCfg();
    if(typeof ghRaw === 'function' && typeof ghPut === 'function'){
      const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main');
      const arr = raw ? JSON.parse(raw) : [];
      const toRemove = arr[idx];
      // attempt to remove images too if maybeDeleteImage exists
      if(typeof maybeDeleteImage === 'function' && toRemove){
        if(toRemove.image) await maybeDeleteImage(cfg, toRemove.image);
        if(toRemove.thumb) await maybeDeleteImage(cfg, toRemove.thumb);
      }
      arr.splice(idx,1);
      await ghPut(sessionStorage.getItem('static_session_pat'), cfg.repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', cfg.branch || 'main');
      alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
      await loadAll();
    } else {
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ø£Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© (ghRaw/ghPut). ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ù…ØªÙƒØ§Ù…Ù„.');
    }
  }catch(e){ alert('Ø®Ø·Ø£: ' + (e.message||e)); console.error(e); }
}

/* ----------------- Search wiring ----------------- */
const debouncedFilter = (function(){
  let t;
  return (val)=>{ clearTimeout(t); t = setTimeout(()=> buildAdsList(val), 200); };
})();

searchInput.addEventListener('input', (e) => {
  const v = e.target.value || '';
  debouncedFilter(v);
});

/* ----------------- Auto-fill ref on focus for create/edit forms ----------------- */
document.addEventListener('focusin', (e)=>{
  try{
    const el = e.target;
    if((el.id === 'a_code' || el.id === 'p_code') && el.value.trim()===''){
      el.value = genRef();
    }
  }catch(err){}
});

/* ----------------- init ----------------- */
(function init(){
  // set UI from saved cfg if any (keeps parity with your original save/load)
  try{
    const cfg = readCfg();
    if(cfg){
      document.getElementById('cfg_repo').value = cfg.repo || '';
      document.getElementById('cfg_branch').value = cfg.branch || 'main';
      document.getElementById('cfg_session_pat').value = ''; // session PAT kept in sessionStorage
      document.getElementById('allowPublic').checked = !!cfg.allow_public_submissions;
    }
  }catch(e){}
  // initial load
  loadAll();
})();
</script>
</body>
</html>
