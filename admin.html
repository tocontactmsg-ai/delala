<!-- BEGIN admin_updated.html -->
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة الإدارة</title>
  <style>
    /* minimal css (unchanged) */
    body{font-family:Segoe UI,Roboto,Arial;direction:rtl;padding:12px;background:#f7fbff;color:#1b2b3a}
    .wrap{max-width:980px;margin:0 auto}
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    .item{background:#fff;padding:10px;border-radius:8px;border:1px solid #e6eef8;display:flex;gap:10px;align-items:center}
    .thumb{width:84px;height:64px;object-fit:cover;border-radius:6px}
    .muted{color:#6b7b8c}
    .actions{margin-top:6px;display:flex;gap:6px}
    .alt{background:#eef7ff;border:1px solid #cfe9ff;padding:6px 10px;border-radius:8px}
    input,textarea,select{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    button{cursor:pointer}
    .detail{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6eef8;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>لوحة إدارة الإعلانات</h2>

    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
      <button id="loadBtn" class="alt">تحميل الإعدادات</button>
      <button id="saveCfg" class="alt">حفظ الإعداد</button>
      <button id="refreshBtn">تحديث يدوي</button>
      <div style="flex:1"></div>
      <span id="status" class="muted"></span>
    </div>

    <h3 style="margin:0 0 8px">الإعداد</h3>
    <div style="background:#fff;padding:12px;border-radius:8px;border:1px solid #e6eef8">
      <label>المستودع: <input id="cfg_repo" placeholder="owner/repo" style="width:240px"></label>
      <label>الفرع: <input id="cfg_branch" placeholder="main" style="width:120px"></label>
      <label>اسم المالك: <input id="cfg_owner" placeholder="owner" style="width:120px"></label>
      <label>اسم المستخدم (Session PAT in sessionStorage): <input id="cfg_pat" placeholder="optional"></label>
      <label style="display:block;margin-top:8px">سماح بالتحميل العام؟ <select id="cfg_public"><option value="0">لا</option><option value="1">نعم</option></select></label>
    </div>

    <h3 style="margin:12px 0 6px">الإعلانات الحالية</h3>

<!-- Admin: search bar (inserted by assistant) -->
<div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
  <input id="adminSearch" placeholder="ابحث بالعنوان أو الرمز أو الموقع" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8">
  <button id="adminClearSearch" class="alt">مسح</button>
</div>
    <div id="adsList" class="list"><div class="muted">اضغط تحميل لعرض الإعلانات</div></div>

    <div id="detail" class="detail" style="display:none"></div>

    <h3 style="margin-top:16px">طلبات المستخدمين (Proposals)</h3>
    <div id="proposals" class="list"><div class="muted">اضغط تحميل لعرض الطلبات</div></div>

  </div>

<script>
/* ---------------------- Utilities ------------------------ */
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
async function ghRaw(repo, path, branch='main'){
  try{
    const [owner, r] = (repo||'').split('/');
    if(!owner || !r) return null;
    const url = `https://raw.githubusercontent.com/${owner}/${r}/${branch}/${path}`;
    const res = await fetch(url, { cache:'no-cache' });
    if(!res.ok) return null;
    return await res.text();
  }catch(e){ return null; }
}
async function ghPut(pat, repo, path, contentBase64, message='update', branch='main'){
  // contentBase64 must be base64 encoded string already
  const [owner, r] = (repo||'').split('/');
  const api = `https://api.github.com/repos/${owner}/${r}/contents/${encodeURIComponent(path)}`;
  // attempt to get sha
  let sha = null;
  try{
    const getRes = await fetch(api + `?ref=${branch}`, { headers: { Authorization: pat ? 'token ' + pat : '' }});
    if(getRes.ok){
      const json = await getRes.json();
      if(json && json.sha) sha = json.sha;
    }
  }catch(e){}
  const body = { message, content: contentBase64, branch };
  if(sha) body.sha = sha;
  const res = await fetch(api, { method:'PUT', headers: { Authorization: pat ? 'token ' + pat : '', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!res.ok){ const parsed = await res.json().catch(()=>null); throw new Error('PUT failed: ' + (parsed && parsed.message ? parsed.message : res.statusText)); }
  return await res.json();
}

/* ---------- Admin: search + consistent ref + ads-version bump (inserted) ---------- */

// local copy of currently loaded ads for searching
let lastLoadedAds = [];

// simple universal ref generator (same pattern as index)
function genRefAdmin(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }

// update the ads_version file in the repo so public page can detect changes and invalidate caches
async function updateAdsVersion(pat, repo, branch='main'){
  try{
    const ts = new Date().toISOString();
    const content = btoa(unescape(encodeURIComponent(ts)));
    // create or update a small text file that holds the timestamp
    await ghPut(pat, repo, 'static/ads_version.txt', content, 'update ads version ' + ts, branch);
  }catch(e){
    console.warn('ads version update failed', e);
  }
}

const adsEl = document.getElementById('adsList');
const proposalsEl = document.getElementById('proposals');
const detailEl = document.getElementById('detail');
const statusEl = document.getElementById('status');

function readCfg(){
  const cfg = {};
  cfg.repo = document.getElementById('cfg_repo').value.trim();
  cfg.branch = document.getElementById('cfg_branch').value.trim() || 'main';
  cfg.owner = document.getElementById('cfg_owner').value.trim();
  cfg.allow_public_submissions = document.getElementById('cfg_public').value === '1';
  return cfg;
}

document.getElementById('loadBtn').onclick = async ()=>{
  statusEl.textContent = 'جاري التحميل...';
  try{
    const cfg = readCfg();
    sessionStorage.setItem('static_session_cfg', JSON.stringify(cfg));
    await loadAds();
    await loadProposals();
    statusEl.textContent = '';
  }catch(e){ statusEl.textContent = 'فشل التحميل: ' + e.message; }
};

document.getElementById('refreshBtn').onclick = async ()=>{ await loadAds(); await loadProposals(); }

/* ---------- Fetch / render ---------- */

async function loadAds(){
  adsEl.innerHTML = 'تحميل...';
  const cfg = readCfg();
  try{
    const raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main');
    const arr = raw ? JSON.parse(raw) : [];
    lastLoadedAds = arr;
    renderAds(arr);
  }catch(e){ console.error(e); adsEl.innerHTML = '<div class="muted">فشل جلب ads.json</div>'; }
}
function renderAds(items){
  adsEl.innerHTML = '';
  if(!items || items.length===0){ adsEl.innerHTML = '<div class="muted">لا توجد إعلانات</div>'; return; }
  items.forEach((a, idx)=>{
    const el = document.createElement('div'); el.className='item';
    const thumb = (a.thumb||a.image||'').replace(/^\//,'');
    el.innerHTML = `<img class="thumb" src="${thumb}" onerror="this.style.display='none'">
      <div style="flex:1">
        <div><strong>${escapeHtml(a.name||a.code||('ad'+idx))}</strong></div>
        <div class="muted">${escapeHtml(a.location||a.category||'')}</div>
        <div class="muted" style="margin-top:6px">${escapeHtml((a.description||'').slice(0,120))}${(a.description||'').length>120?'...':''}</div>
        <div class="actions">
          <button class="viewAdBtn">عرض</button>
          <button class="editAdBtn alt">تعديل</button>
          <button class="delAdBtn" style="background:#fff;border:1px solid #f3c2c2">حذف</button>
        </div>
      </div>
      <div style="min-width:110px;text-align:left">
        <div class="muted">الرمز</div>
        <div><strong>${escapeHtml(a.ref_code||a.code||'')}</strong></div>
      </div>`;
    const viewBtn = el.querySelector('.viewAdBtn');
    viewBtn.onclick = ()=> showAdDetail(a, idx);
    const editBtn = el.querySelector('.editAdBtn');
    editBtn.onclick = ()=> openAdModal('edit', idx, a);
    const delBtn = el.querySelector('.delAdBtn');
    delBtn.onclick = ()=> deleteAd(idx, a);
    adsEl.appendChild(el);
  });
}

// tie search UI to filtering the in-memory list
try{
  document.getElementById('adminSearch').addEventListener('input', (e)=>{
    const q = (e.target.value || '').trim().toLowerCase();
    if(!q){ renderAds(lastLoadedAds); return; }
    const filtered = lastLoadedAds.filter(a=>{
      return (a.name||'').toLowerCase().includes(q) ||
             (a.ref_code||a.code||'').toLowerCase().includes(q) ||
             (a.location||'').toLowerCase().includes(q) ||
             (a.description||'').toLowerCase().includes(q) ||
             (a.category||'').toLowerCase().includes(q);
    });
    renderAds(filtered);
  });
  document.getElementById('adminClearSearch').addEventListener('click', ()=>{
    document.getElementById('adminSearch').value = '';
    renderAds(lastLoadedAds);
  });
}catch(e){
  console.warn('admin search init failed', e);
}

/* ---------------- proposals and accept flow (unchanged, only minimal hooks added) ---------------- */

async function loadProposals(){
  proposalsEl.innerHTML = 'تحميل...';
  const cfg = readCfg();
  try{
    const raw = await ghRaw(cfg.repo, 'static/proposals.json', cfg.branch || 'main');
    const arr = raw ? JSON.parse(raw) : [];
    proposalsEl.innerHTML = '';
    if(!arr || arr.length===0){ proposalsEl.innerHTML = '<div class="muted">لا توجد طلبات</div>'; return;}
    arr.forEach((p, i)=>{
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<div style="flex:1"><strong>${escapeHtml(p.name||p.ref_code||'')}</strong><div class="muted">${escapeHtml(p.location||'')}</div></div>
        <div style="min-width:120px;text-align:left"><button class="acceptBtn">قبول</button><button class="delBtn alt">حذف</button></div>`;
      el.querySelector('.acceptBtn').onclick = ()=> confirmAccept(p, i);
      el.querySelector('.delBtn').onclick = ()=> deleteProposal(p, i);
      proposalsEl.appendChild(el);
    });
  }catch(e){ proposalsEl.innerHTML = '<div class="muted">فشل جلب الطلبات</div>'; }
}

async function confirmAccept(item, idx){
  if(!confirm('هل تريد قبول هذا الطلب؟')) return;
  try{
    const cfg = readCfg();
    const pat = sessionStorage.getItem('static_session_pat');
    let raw = await ghRaw(cfg.repo, 'static/ads.json', cfg.branch || 'main'); const arr = raw ? JSON.parse(raw) : [];
    const ad = Object.assign({}, item);
    // ensure we have consistent ref_code
    ad.ref_code = ad.ref_code || ad.code || genRefAdmin();
    // mark accepted
    ad.created_at = new Date().toISOString();
    arr.unshift(ad);
    await ghPut(pat, cfg.repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'accept proposal ' + (item.ref_code||item.filename), cfg.branch || 'main');
    try{ await updateAdsVersion(pat, cfg && cfg.repo ? cfg.repo : cfg.repo, cfg && cfg.branch ? cfg.branch : (cfg.branch||'main')); }catch(e){}
    // update mappings.json (optional)
    let rawMap = await ghRaw(cfg.repo, 'static/mappings.json', cfg.branch || 'main'); let map = rawMap ? JSON.parse(rawMap) : {};
    map[ad.ref_code] = ad.name || '';
    await ghPut(pat, cfg.repo, 'static/mappings.json', btoa(unescape(encodeURIComponent(JSON.stringify(map)))), 'update mappings', cfg.branch || 'main').catch(()=>null);
    alert('تم القبول');
    loadAll();
  }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
}

async function deleteProposal(item, idx){
  if(!confirm('حذف هذا الطلب؟')) return;
  try{
    const cfg = readCfg();
    const pat = sessionStorage.getItem('static_session_pat');
    // remove proposal file if exists
    try{ await ghPut(pat, cfg.repo, `static/proposals/${item.ref_code || item.filename}.json`, btoa(unescape(encodeURIComponent('{}'))), 'delete proposal', cfg.branch || 'main'); }catch(e){}
    alert('تم الحذف');
    loadAll();
  }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
}

/* --------------- Edit / New ad modal (only change: use genRefAdmin for admin-created codes) ---------------- */

async function openAdModal(mode='new', idx, item){
  const cfg = readCfg();
  const pat = sessionStorage.getItem('static_session_pat');
  let ad = item ? Object.assign({}, item) : {};
  detailEl.style.display = 'block';
  detailEl.innerHTML = `
    <div><label>رمز الإعــلان: <input id="a_code" value="${escapeHtml(ad.ref_code||ad.code||'')}" /></label></div>
    <div><label>العنوان: <input id="a_name" value="${escapeHtml(ad.name||'')}" /></label></div>
    <div><label>الموقع: <input id="a_loc" value="${escapeHtml(ad.location||'')}" /></label></div>
    <div><label>الوصف:<br><textarea id="a_desc">${escapeHtml(ad.description||'')}</textarea></label></div>
    <div style="margin-top:8px"><button id="saveAdBtn">حفظ</button><button id="cancelAd" class="alt">إلغاء</button></div>
  `;
  document.getElementById('cancelAd').onclick = ()=> { detailEl.style.display='none'; };
  document.getElementById('saveAdBtn').onclick = async ()=>{
    try{
      const repo = cfg.repo;
      const branch = cfg.branch || 'main';
      const pat = sessionStorage.getItem('static_session_pat');
      // build obj
      const obj = {
        const_dummy:'please_replace' // placeholder (will be removed)
      };
      // collect values into obj preserving extra data
      const computedCode = document.getElementById('a_code').value.trim() || genRefAdmin();
      const finalObj = {
        ref_code: computedCode,
        code: computedCode,
        name: document.getElementById('a_name').value.trim(),
        location: document.getElementById('a_loc').value.trim(),
        description: document.getElementById('a_desc').value.trim(),
        created_at: (new Date()).toISOString()
      };
      // load existing ads.json
      let raw = await ghRaw(repo, 'static/ads.json', branch); let arr = raw ? JSON.parse(raw) : [];
      if(mode==='new') arr.unshift(finalObj); else arr[idx] = finalObj;
      await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), mode==='new'?'add ad':'update ad', branch);
      try{ await updateAdsVersion(pat, cfg && cfg.repo ? cfg.repo : repo, cfg && cfg.branch ? cfg.branch : (branch||'main')); }catch(e){}
      alert('تم الحفظ'); loadAll(); detailEl.innerHTML='';
    }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
  };
}

/* ---------------- delete ad (calls updateAdsVersion after ghPut) ---------------- */

async function deleteAd(idx, a){
  if(!confirm('هل تريد حذف الإعلان؟')) return;
  try{
    const cfg = readCfg();
    const repo = cfg.repo;
    const branch = cfg.branch || 'main';
    const pat = sessionStorage.getItem('static_session_pat');
    let raw = await ghRaw(repo, 'static/ads.json', branch); const arr = raw ? JSON.parse(raw) : [];
    const thumb = a.thumb || a.image;
    if(thumb) await maybeDeleteImage(readCfg(), thumb);
    arr.splice(idx,1);
    await ghPut(pat, repo, 'static/ads.json', btoa(unescape(encodeURIComponent(JSON.stringify(arr)))), 'delete ad', branch);
    try{ await updateAdsVersion(pat, cfg && cfg.repo ? cfg.repo : repo, cfg && cfg.branch ? cfg.branch : (branch||'main')); }catch(e){}
    alert('تم الحذف'); loadAll();
  }catch(e){ alert('خطأ: ' + e.message); console.error(e); }
}

/* ---------------- helper functions used above (unchanged) ---------------- */

function loadAll(){ loadAds(); loadProposals(); }

async function maybeDeleteImage(cfg, imagePath){
  // best-effort deletion of an image file if uploaded in repo
  try{
    if(!cfg || !cfg.repo) return;
    // determine raw url, if exists attempt to remove by writing empty JSON (safer to keep images)
    return;
  }catch(e){}
}

/* initialize using saved session cfg if present */
try{
  const saved = JSON.parse(sessionStorage.getItem('static_session_cfg') || '{}');
  if(saved && saved.repo){
    document.getElementById('cfg_repo').value = saved.repo;
    document.getElementById('cfg_branch').value = saved.branch || 'main';
    document.getElementById('cfg_owner').value = saved.owner || '';
    document.getElementById('cfg_public').value = saved.allow_public_submissions ? '1' : '0';
  }
}catch(e){}
</script>
</body>
</html>
<!-- END admin_updated.html -->
