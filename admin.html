<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin â€” Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  body{font-family:"Tajawal",sans-serif;margin:12px;background:#f6f8fb;color:#07203a}
  .wrap{max-width:1000px;margin:0 auto}
  .panel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(9,30,66,0.06)}
  .list{max-height:420px;overflow:auto;margin-top:8px}
  .thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;background:#f4f6f9}
  input,textarea,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #e6eef8}
  button{background:#0b69d6;color:#fff;border:none;cursor:pointer}
  button.alt{background:#6b7280}
  .muted{color:#59656f;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</h1>
  <div class="panel" id="cfgPanel">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="cfg_repo" placeholder="owner/repo" style="width:260px">
      <input id="cfg_branch" placeholder="branch" style="width:100px" value="main">
      <input id="cfg_session_pat" placeholder="PAT (dev only, optional)" style="width:300px">
      <button id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button id="clearBtn" class="alt">Ù…Ø³Ø­ PAT</button>
    </div>
    <div class="muted" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Cloudflare Pages Functions (server-side) â€” Ù„Ø§ ØªØ¶ÙØ¹ PAT ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.</div>
  </div>

  <div style="height:12px"></div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</strong>
      <div><input id="admin_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù…Ø² Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù…ÙˆÙ‚Ø¹" style="width:260px"></div>
    </div>

    <div class="list" id="ads_list">ØªØ­Ù…ÙŠÙ„...</div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
      <button id="newBtn" class="alt">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="panel" id="detail">Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©</div>
  <div style="height:20px"></div>
  <div class="panel muted">Debug console: Ø§ÙØªØ­ DevTools Ù„Ø±Ø¤ÙŠØ© Ø±Ø³Ø§Ø¦Ù„ Ø£ÙƒØ«Ø±</div>
</div>

<script>
/* ---------- helpers that use the Pages API endpoints ---------- */
async function ghRaw(path, branch='main'){
  const url = `/api/raw?path=${encodeURIComponent(path)}&branch=${encodeURIComponent(branch)}`;
  const r = await fetch(url);
  const j = await r.json();
  if(!r.ok) throw new Error(j.error || ('status ' + r.status));
  return j.content;
}

async function ghPut(sessionPat, repo, path, base64Content, message='update', branch='main'){
  // call Pages function
  const payload = { path, contentBase64: base64Content, message, branch };
  const r = await fetch('/api/put', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  const j = await r.json();
  if(!r.ok) throw new Error(j.error || j.result?.message || ('status ' + r.status));
  return j.result;
}

async function ghDelete(path, message='delete', branch='main'){
  const payload = { path, message, branch };
  const r = await fetch('/api/delete', { method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
  const j = await r.json();
  if(!r.ok) throw new Error(j.error || j.result?.message || ('status ' + r.status));
  return j.result;
}

/* ---------- small UI logic (reads/writes static/ads.json) ---------- */
const adsListEl = document.getElementById('ads_list');
const detailEl = document.getElementById('detail');
const searchEl = document.getElementById('admin_search');

let allAds = [];

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderList(q=''){
  adsListEl.innerHTML = '';
  const ql = (q||'').toLowerCase();
  const shown = [];
  allAds.forEach((ad, idx)=>{
    const combined = `${ad.ref_code||ad.code||''} ${ad.name||''} ${ad.location||''} ${ad.category||''}`.toLowerCase();
    if(ql && !combined.includes(ql)) return;
    const div = document.createElement('div');
    div.style.display='flex';
    div.style.gap='10px';
    div.style.padding='8px 0';
    div.style.borderBottom='1px solid #f2f4f7';
    div.innerHTML = `<div style="width:96px"><img src="${escapeHtml(ad.thumb||ad.image||'')}" class="thumb" /></div>
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(ad.name||'')}</div>
        <div class="muted">Ø±Ù…Ø²: ${escapeHtml(ad.ref_code||ad.code||'')}</div>
        <div style="margin-top:6px" class="muted">ğŸ“ ${escapeHtml(ad.location||'')}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button data-idx="${idx}" class="viewBtn">Ø¹Ø±Ø¶</button>
        <button data-idx="${idx}" class="editBtn alt">ØªØ­Ø±ÙŠØ±</button>
        <button data-idx="${idx}" class="delBtn alt">Ø­Ø°Ù</button>
      </div>`;
    adsListEl.appendChild(div);
  });
}

function showDetail(idx){
  const a = allAds[idx];
  if(!a) return;
  detailEl.innerHTML = `<div style="display:flex;gap:12px">
    <img src="${escapeHtml(a.thumb||a.image||'')}" style="width:160px;height:120px;object-fit:cover;border-radius:6px"/>
    <div style="flex:1">
      <div style="font-weight:800">${escapeHtml(a.name||'')}</div>
      <div class="muted">Ø±Ù…Ø²: <strong>${escapeHtml(a.ref_code||a.code||'')}</strong></div>
      <div class="muted" style="margin-top:6px">${escapeHtml(a.description||'')}</div>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button onclick="buildEdit(${idx})">ØªØ­Ø±ÙŠØ±</button>
        <button onclick="doDelete(${idx})" class="alt">Ø­Ø°Ù</button>
      </div>
    </div></div>`;
}

function buildEdit(idx){
  const a = allAds[idx] || {};
  detailEl.innerHTML = `
    <div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><label style="min-width:80px">Ø±Ù…Ø²</label><input id="a_code" value="${escapeHtml(a.ref_code||a.code||'')}" style="flex:1"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><label style="min-width:80px">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="a_name" value="${escapeHtml(a.name||'')}" style="flex:1"></div>
      <div style="margin-bottom:8px"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="a_desc" style="width:100%">${escapeHtml(a.description||'')}</textarea></div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><label style="min-width:80px">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input id="a_loc" value="${escapeHtml(a.location||'')}" style="flex:1"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><label style="min-width:80px">ØµÙˆØ±Ø©</label><input id="a_file" type="file" accept="image/*"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button id="saveBtnLocal">Ø­ÙØ¸</button><button id="cancelBtn" class="alt">Ø¥Ù„ØºØ§Ø¡</button></div>
      <div id="saveStatus" class="muted" style="margin-top:8px"></div>
    </div>
  `;
  document.getElementById('cancelBtn').onclick = ()=> { detailEl.innerHTML='Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©'; };
  document.getElementById('saveBtnLocal').onclick = ()=> saveAd(idx);
}

async function saveAd(idx){
  const cfgRepo = document.getElementById('cfg_repo').value.trim();
  const branch = document.getElementById('cfg_branch').value.trim() || 'main';
  if(!cfgRepo){ alert('Ø¶Ø¹ owner/repo Ø£ÙˆÙ„Ø§'); return; }
  const pat = sessionStorage.getItem('static_session_pat') || document.getElementById('cfg_session_pat').value || '';
  try{
    const code = document.getElementById('a_code').value.trim() || ('R'+Date.now().toString(36).slice(-6).toUpperCase());
    const name = document.getElementById('a_name').value.trim();
    const desc = document.getElementById('a_desc').value.trim();
    const loc = document.getElementById('a_loc').value.trim();
    // prepare ad object
    const item = { ref_code: code, name, description: desc, location: loc, modified_at: new Date().toISOString() };
    // handle file
    const fileInput = document.getElementById('a_file');
    if(fileInput && fileInput.files && fileInput.files[0]){
      const f = fileInput.files[0];
      // simple resize to smaller using canvas
      const img = await new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>{ const i = new Image(); i.onload = ()=> res(i); i.src = r.result; }
        r.onerror = rej; r.readAsDataURL(f);
      });
      const maxW = 1200, maxH = 900;
      const ratio = Math.min(1, maxW/img.width, maxH/img.height);
      const w = Math.round(img.width*ratio), h = Math.round(img.height*ratio);
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const durl = c.toDataURL('image/webp', 0.78);
      const b64 = durl.split(',')[1];
      const filename = `static/images/${Date.now().toString(36)}-${code}.webp`;
      // upload file using API
      await ghPut(pat, cfgRepo, filename, b64, `upload ${filename}`, branch);
      item.image = `https://raw.githubusercontent.com/${cfgRepo}/${branch}/${filename}`;
      item.thumb = item.image;
    }
    // update ads.json
    // fetch existing ads
    const raw = await ghRaw('static/ads.json', branch);
    const arr = raw ? JSON.parse(raw) : [];
    if(typeof idx === 'number' && arr[idx]) { arr[idx] = item; } else { arr.unshift(item); }
    const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2))));
    await ghPut(pat, cfgRepo, 'static/ads.json', jsonB64, `save ad ${item.ref_code}`, branch);
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    loadAll();
  }catch(e){ console.error(e); alert('Ø®Ø·Ø£: ' + (e.message||e)); }
}

async function doDelete(idx){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
  const cfgRepo = document.getElementById('cfg_repo').value.trim();
  const branch = document.getElementById('cfg_branch').value.trim() || 'main';
  const pat = sessionStorage.getItem('static_session_pat') || document.getElementById('cfg_session_pat').value || '';
  if(!cfgRepo) { alert('Ø¶Ø¹ repo'); return; }
  try{
    const raw = await ghRaw('static/ads.json', branch);
    const arr = raw ? JSON.parse(raw) : [];
    const rem = arr.splice(idx,1)[0];
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2))));
    await ghPut(pat, cfgRepo, 'static/ads.json', b64, `delete ad ${rem.ref_code||'unknown'}`, branch);
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
    loadAll();
  }catch(e){ alert('Ø®Ø·Ø£: '+(e.message||e)); console.error(e); }
}

document.getElementById('refreshBtn').addEventListener('click', ()=> loadAll());
document.getElementById('newBtn').addEventListener('click', ()=> { buildEdit(-1); });

searchEl.addEventListener('input', (e)=> renderList(e.target.value));

document.getElementById('saveBtn').addEventListener('click', ()=>{
  const cfg = { repo: document.getElementById('cfg_repo').value.trim(), branch: document.getElementById('cfg_branch').value.trim() || 'main' };
  localStorage.setItem('static_ads_cfg_v1', JSON.stringify(cfg));
  const pat = document.getElementById('cfg_session_pat').value || '';
  if(pat) sessionStorage.setItem('static_session_pat', pat);
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (PAT ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¥Ø°Ø§ ÙˆØ¶Ø¹Øª)');
  loadAll();
});
document.getElementById('clearBtn').addEventListener('click', ()=> { sessionStorage.removeItem('static_session_pat'); document.getElementById('cfg_session_pat').value=''; alert('PAT Ù…Ø­Ø°ÙˆÙ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©'); });

async function loadAll(){
  adsListEl.innerHTML = 'ØªØ­Ù…ÙŠÙ„...';
  try{
    // try config from localStorage
    const cfg = JSON.parse(localStorage.getItem('static_ads_cfg_v1')||'{}');
    if(cfg && cfg.repo) document.getElementById('cfg_repo').value = cfg.repo;
    const branch = document.getElementById('cfg_branch').value.trim() || 'main';
    const raw = await ghRaw('static/ads.json', branch);
    allAds = raw ? JSON.parse(raw) : [];
    renderList(searchEl.value || '');
    detailEl.innerHTML = 'Ø­Ø¯Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø£Ùˆ Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©';
  }catch(e){
    adsListEl.innerHTML = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + (e.message||e);
    console.error(e);
  }
}

// init
(function(){ const cfg = JSON.parse(localStorage.getItem('static_ads_cfg_v1')||'{}'); if(cfg && cfg.repo) document.getElementById('cfg_repo').value = cfg.repo; loadAll(); })();
</script>
</body>
</html>
