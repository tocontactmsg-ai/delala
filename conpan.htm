<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ù…Ø´Ø±Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg: #f4f7fb;
  --bg-soft: #eef2ff;
  --surface: #ffffff;
  --surface-soft: rgba(255,255,255,0.92);
  --border-subtle: rgba(148,163,184,0.35);
  --muted: #6b7280;
  --muted-soft: #9ca3af;
  --accent: #2563eb;
  --accent-soft: #e0edff;
  --accent-strong: #0b84ff;
  --danger: #ef4444;
  --danger-soft: #fee2e2;
  --success: #16a34a;
  --shadow-soft: 0 10px 30px rgba(15,23,42,0.08);
  --shadow-strong: 0 28px 80px rgba(15,23,42,0.16);
  --radius: 16px;
}

/* RESET Ø¨Ø³ÙŠØ· */
*,
*::before,
*::after{
  box-sizing:border-box;
}
html,body{
  height:100%;
  margin:0;
  padding:0;
  font-family:'Tajawal',sans-serif;
  color:#020617;
  background:
    radial-gradient(circle at 0 0, rgba(59,130,246,0.10) 0, transparent 50%),
    radial-gradient(circle at 100% 0, rgba(14,165,233,0.10) 0, transparent 45%),
    linear-gradient(180deg,#f8fafc,#eef2ff);
}
body{
  -webkit-font-smoothing:antialiased;
}

/* LAYOUT Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
.app{
  max-width:1200px;
  margin:24px auto;
  padding:18px 14px 32px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  flex-wrap:wrap;
  margin-bottom:18px;
}

/* Ø§Ù„Ø´Ø¹Ø§Ø± */
.brand{
  display:flex;
  align-items:center;
  gap:12px;
}

.logo{
  width:52px;
  height:52px;
  border-radius:18px;
  background:
    radial-gradient(circle at 25% 0, #ffffff 0, #dbeafe 40%, #2563eb 110%);
  box-shadow:0 14px 32px rgba(15,23,42,0.32);
  display:flex;
  align-items:center;
  justify-content:center;
}

.logo-inner{
  width:38px;
  height:38px;
  border-radius:14px;
  background:linear-gradient(135deg,#0ea5e9,#1d4ed8);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 10px 26px rgba(8,47,73,0.55);
}

.logo-inner span{
  color:#fff;
  font-weight:800;
  font-size:20px;
  text-shadow:0 2px 8px rgba(15,23,42,0.7);
}

.title{
  font-size:18px;
  font-weight:800;
  color:#0f172a;
}
.title small{
  display:block;
  font-size:12px;
  margin-top:4px;
  color:var(--muted);
}

/* Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
.actions{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}

.chip{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,0.9);
  border:1px solid var(--border-subtle);
  color:#111827;
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.chip strong{
  color:var(--accent-strong);
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© */
.btn{
  border-radius:999px;
  border:1px solid transparent;
  padding:8px 12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  cursor:pointer;
  font-size:13px;
  font-weight:600;
  background:#ffffff;
  color:#0f172a;
  transition:background .15s ease, box-shadow .15s ease, transform .08s ease, border-color .15s ease;
}
.btn span{
  font-size:14px;
}
.btn:active{
  transform:scale(0.98);
}

.btn.primary{
  background:linear-gradient(135deg,#2563eb,#0b84ff);
  color:#fff;
  box-shadow:0 10px 24px rgba(37,99,235,0.40);
}
.btn.primary:hover{
  box-shadow:0 14px 30px rgba(37,99,235,0.45);
}

.btn.outline{
  background:rgba(255,255,255,0.96);
  border-color:var(--border-subtle);
}
.btn.outline:hover{
  border-color:rgba(37,99,235,0.45);
  background:#f9fafb;
}

.btn.small{
  padding:6px 10px;
  font-size:12px;
  box-shadow:none;
}

.btn.danger{
  background:linear-gradient(135deg,#f97373,#ef4444);
  color:#fff;
  box-shadow:0 10px 24px rgba(185,28,28,0.45);
}
.btn.danger:hover{
  box-shadow:0 13px 28px rgba(185,28,28,0.53);
}

/* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.main{
  margin-top:8px;
  display:grid;
  grid-template-columns:2.1fr 1.35fr;
  gap:14px;
}
@media(max-width:960px){
  .main{
    grid-template-columns:1fr;
  }
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª / Ø§Ù„Ø£Ù„ÙˆØ§Ø­ */
.panel{
  background:var(--surface-soft);
  border-radius:var(--radius);
  padding:14px 12px 14px;
  box-shadow:var(--shadow-soft);
  backdrop-filter:blur(12px);
  border:1px solid rgba(226,232,240,0.9);
}

.panel-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:6px;
  margin-bottom:10px;
}
.panel-header h2{
  margin:0;
  font-size:14px;
  font-weight:800;
  color:#0f172a;
}
.panel-header .sub{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}

/* Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
.tools{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:10px;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
.dropzone{
  border-radius:var(--radius);
  min-height:86px;
  border:1.5px dashed rgba(148,163,184,0.9);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:12px 12px;
  background:linear-gradient(135deg,rgba(255,255,255,0.98),rgba(239,246,255,0.95));
  transition:border-color .18s ease, box-shadow .18s ease, background .18s ease, transform .08s ease;
}
.dropzone--active{
  border-color:var(--accent);
  box-shadow:0 12px 26px rgba(37,99,235,0.22);
  background:linear-gradient(135deg,#e0edff,#f4f7ff);
  transform:translateY(-1px);
}

.drop-main{
  display:flex;
  align-items:center;
  gap:10px;
}

.drop-icon{
  width:40px;
  height:40px;
  border-radius:14px;
  background:radial-gradient(circle at 30% 0,#bfdbfe 0,#2563eb 30%,#1d4ed8 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#eff6ff;
  font-size:20px;
  box-shadow:0 12px 30px rgba(37,99,235,0.48);
}
.drop-text strong{
  display:block;
  font-size:13px;
  margin-bottom:2px;
}
.drop-text span{
  display:block;
  font-size:11px;
  color:var(--muted-soft);
}

.drop-actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.hidden{
  display:none;
}

/* Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± */
.filters-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
  margin-bottom:6px;
  align-items:center;
}

.search-input{
  flex:1;
  min-width:160px;
  display:flex;
  align-items:center;
  gap:8px;
  padding:7px 11px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.8);
  background:rgba(255,255,255,0.95);
  font-size:13px;
}
.search-input input{
  border:0;
  outline:none;
  font-size:13px;
  background:transparent;
  width:100%;
}
.search-input input::placeholder{
  color:#cbd5f5;
}

/* Ø²Ø± Ø§Ù„ÙÙ„ØªØ± */
.filter-tag{
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.7);
  background:rgba(255,255,255,0.97);
  color:#4b5563;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  transition:background .15s ease, border-color .15s ease, color .15s ease, transform .08s ease;
}
.filter-tag:hover{
  background:#eff6ff;
}
.filter-tag.active{
  border-color:#2563eb;
  color:#1d4ed8;
  background:#e0f2fe;
  transform:translateY(-1px);
}

/* ÙˆØµÙ ØµØºÙŠØ± */
.stats{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
  gap:10px;
  margin-top:10px;
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¹Ù„Ø§Ù† */
.card{
  background:linear-gradient(180deg,#ffffff,#fbfeff);
  border-radius:18px;
  padding:10px;
  box-shadow:0 10px 24px rgba(15,23,42,0.10);
  border:1px solid rgba(226,232,240,0.95);
  cursor:grab;
  transition:transform .14s ease, box-shadow .18s ease, border .14s ease, background .14s ease;
  position:relative;
  user-select:none;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 16px 32px rgba(15,23,42,0.18);
  border-color:rgba(129,140,248,0.75);
}
.card.dragging{
  opacity:0.60;
  transform:scale(0.98);
  border:2px dashed rgba(11,132,255,0.35);
}

/* ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.thumb{
  width:100%;
  height:160px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid rgba(11,132,255,0.04);
  background:#e5e7eb;
}

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.meta{
  margin-top:10px;
}
.name{
  font-weight:800;
  font-size:14px;
  color:#0f172a;
  margin-bottom:2px;
}
.desc{
  color:var(--muted);
  font-size:12px;
  line-height:1.5;
  height:3.5em;
  overflow:hidden;
}
.row{
  display:flex;
  gap:8px;
  align-items:center;
}

/* Ø´Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙ */
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background:#eef2ff;
  color:#2563eb;
  font-weight:700;
  font-size:11px;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.card-actions{
  display:flex;
  gap:6px;
  align-items:center;
  margin-top:10px;
}

.icon-btn{
  padding:6px 7px;
  border-radius:10px;
  border:1px solid rgba(226,232,240,0.9);
  background:#f1f5f9;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  transition:background .15s ease, box-shadow .15s ease, transform .08s ease, border-color .15s ease;
}
.icon-btn:hover{
  background:#e0edff;
  border-color:rgba(129,140,248,0.7);
}
.icon-btn span{
  pointer-events:none;
}

/* Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† */
.fab{
  position:fixed;
  left:24px;
  bottom:26px;
  padding:12px 16px;
  border-radius:999px;
  background:linear-gradient(135deg,#0ea5e9,#2563eb);
  color:#fff;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  font-size:12px;
  font-weight:700;
  box-shadow:0 18px 40px rgba(11,132,255,0.30);
  border:0;
  z-index:40;
}
.fab span{
  font-size:16px;
}

/* TOAST */
#toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:20px;
  padding:8px 12px;
  border-radius:999px;
  background:#020617;
  color:#e5e7eb;
  font-size:12px;
  box-shadow:0 12px 30px rgba(15,23,42,0.7);
  z-index:200;
  display:none;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal.open{
  display:flex;
}
.modal-dialog{
  max-width:920px;
  width:100%;
  margin:10px;
  background:#f9fafb;
  border-radius:20px;
  box-shadow:var(--shadow-strong);
  overflow:hidden;
}

/* Ø±Ø£Ø³ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-header{
  padding:10px 14px;
  background:linear-gradient(135deg,#0ea5e9,#1d4ed8);
  color:#eff6ff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.modal-header .info{
  font-size:12px;
}
.modal-header .info strong{
  display:block;
  font-size:15px;
}

/* Ø¬Ø³Ù… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-body{
  display:grid;
  grid-template-columns:1.15fr 1.6fr;
  gap:10px;
  padding:12px 12px 10px;
}
@media(max-width:820px){
  .modal-body{
    grid-template-columns:1fr;
  }
}

/* Ø¬Ø²Ø¡ Ø§Ù„ØµÙˆØ±Ø© */
.modal-img-wrap{
  background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 35%,#e5e7eb 100%);
  border-radius:16px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.modal-img-wrap img{
  max-width:100%;
  max-height:330px;
  border-radius:12px;
  box-shadow:0 16px 40px rgba(15,23,42,0.45);
}

/* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-form{
  display:grid;
  gap:8px;
}
.modal-form label{
  font-size:11px;
  color:var(--muted);
  display:block;
  margin-bottom:2px;
}
.modal-form input,
.modal-form textarea,
.modal-form select{
  width:100%;
  padding:7px 9px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,0.7);
  font-size:13px;
  font-family:'Tajawal',sans-serif;
  background:#ffffff;
  outline:none;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.modal-form input:focus,
.modal-form textarea:focus,
.modal-form select:focus{
  border-color:rgba(37,99,235,0.80);
  box-shadow:0 0 0 1px rgba(129,140,248,0.55);
  background:#f9fafb;
}
.modal-form textarea{
  min-height:80px;
  resize:vertical;
}

/* ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.modal-footer{
  padding:10px 12px;
  border-top:1px solid rgba(148,163,184,0.35);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  background:#f1f5f9;
}
.modal-footer .left{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.modal-footer .right{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  font-size:11px;
  color:var(--muted);
}

/* Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù€ aside */
aside .modal-form{
  margin-top:4px;
}
aside .modal-form input,
aside .modal-form textarea{
  background:rgba(255,255,255,0.96);
}

/* ØªØµØºÙŠØ± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media(max-width:600px){
  .title{
    font-size:16px;
  }
  .title small{
    font-size:11px;
  }
  .fab{
    left:12px;
    bottom:16px;
    padding-inline:12px;
  }
}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <div class="logo-inner"><span>Ø¯</span></div>
      </div>
      <div>
        <div class="title">
          Ù…Ø´Ø±Ù Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¯Ù„Ø§Ù„Ø©
          <small>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Ø¨Ø·Ø§Ù‚Ø§Øª PNG + ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ + ØªÙ†Ø²ÙŠÙ„ JSON Ù„Ù…Ø¬Ù„Ø¯ /ads</small>
        </div>
      </div>
    </div>
    <div class="actions">
      <div class="chip">Ø§Ù„Ø­Ø§Ù„Ø©: <strong id="count">0 Ø¥Ø¹Ù„Ø§Ù†</strong></div>
      <button class="btn outline" type="button" id="saveLocalBtn"><span>ğŸ’¾</span> Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù…Ø¤Ù‚Øª</button>
      <button class="btn primary" type="button" id="exportAllBtn"><span>ğŸ“¦</span> ØªØµØ¯ÙŠØ± ÙƒÙ„ JSON</button>
    </div>
  </header>

  <main class="main">
    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <section class="panel" aria-label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù…Ø³ÙˆØ­Ø©">
      <div class="panel-header">
        <div>
          <h2>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù…Ø³ÙˆØ­Ø©</h2>
          <div class="sub">Ø§Ø³Ø­Ø¨ Ø¨Ø·Ø§Ù‚Ø§Øª PNG (&amp; Ø§Ù„ÙƒØ±ÙˆØª) Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‡Ù†Ø§ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§</div>
        </div>
      </div>

      <div class="tools">
        <div class="dropzone" id="dropzone">
          <div class="drop-main">
            <div class="drop-icon">ğŸ“¥</div>
            <div class="drop-text">
              <strong>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø¨Ø·Ø§Ù‚Ø§Øª PNG Ù‡Ù†Ø§</strong>
              <span>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</span>
            </div>
          </div>
          <div class="drop-actions">
            <input type="file" id="fileInput" class="hidden" multiple accept="image/png,image/jpeg,image/webp" />
            <button class="btn small outline" type="button" id="scanBtn">Ù…Ø³Ø­ Ù…Ù„ÙØ§Øªâ€¦</button>
            <button class="btn small outline" type="button" id="importJsonBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <input type="file" id="jsonInput" class="hidden" multiple accept="application/json" />
          </div>
        </div>
      </div>

      <div class="filters-row">
        <div class="search-input">
          <span>ğŸ”</span>
          <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
        </div>
        <button class="filter-tag active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
        <button class="filter-tag" data-filter="with">Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ù…Ø¬Ø©</button>
        <button class="filter-tag" data-filter="without">Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>

      <div class="stats">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§ØŒ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù„ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙˆØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© ÙˆØªÙ†Ø²ÙŠÙ„ JSON.</div>

      <div id="grid" class="grid"></div>
    </section>

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©: Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ -->
    <aside class="panel" aria-label="Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯">
      <div class="panel-header">
        <div>
          <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§</h2>
          <div class="sub">Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ø«Ù… ØªÙ†Ø²ÙŠÙ„ JSON (Ù…Ø¹ ØµÙˆØ±Ø© WEBP Ø¥Ø°Ø§ Ø§Ø®ØªØ±ØªÙ‡Ø§)</div>
        </div>
      </div>

      <div class="modal-form">
        <div>
          <label>Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (ref_code)</label>
          <input id="newRef" placeholder="Ù…Ø«Ø§Ù„: RABC123">
        </div>
        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
          <input id="newTitle" placeholder="Ù…Ø«Ø§Ù„: Ù„Ø§Ø¨ØªÙˆØ¨ Ø¨Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©">
        </div>
        <div>
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="newPrice" placeholder="Ù…Ø«Ø§Ù„: 350,000 SDG">
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label>
          <input id="newPhone" placeholder="Ù…Ø«Ø§Ù„: 0912xxxxxx">
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input id="newLoc" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø®Ø±Ø·ÙˆÙ… - Ø¨Ø­Ø±ÙŠ">
        </div>
        <div>
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <input id="newCategory" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">
        </div>
        <div>
          <label>Ø§Ù„ÙˆØµÙ</label>
          <textarea id="newDesc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†"></textarea>
        </div>
        <div>
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© â€” ØªØ­ÙØ¸ ÙƒÙ€ WEBP Ø¯Ø§Ø®Ù„ JSON)</label>
          <input type="file" id="newImage" accept="image/*">
        </div>
        <div class="stats">Ù…Ù„Ø§Ø­Ø¸Ø©: index.html ÙŠÙ‚Ø±Ø£ Ø­Ù‚Ù„ <code>image</code> Ù…Ù† JSON ÙˆÙŠØ¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.</div>
        <button class="btn primary" type="button" id="newDownloadJsonBtn"><span>ğŸ“„</span> ØªÙ†Ø²ÙŠÙ„ JSON Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
      </div>
    </aside>
  </main>
</div>

<button id="fab" class="fab"><span>âš¡</span> Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª</button>

<div id="toast">Toast</div>

<!-- MODAL -->
<div id="modal" class="modal" aria-hidden="true" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
  <div class="modal-dialog">
    <div class="modal-header">
      <div class="info">
        <strong id="modalRef">â€”</strong>
        <span>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</span>
      </div>
      <button id="closeModal" class="btn small outline" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="modal-body">
      <div class="modal-img-wrap">
        <img id="modalImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© / ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" />
        <div>
          <label class="small" style="display:block;margin-bottom:4px;color:#6b7280">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (ØªØ­ÙØ¸ ÙƒÙ€ WEBP Ø¯Ø§Ø®Ù„ JSON)</label>
          <input type="file" id="modalImgInput" accept="image/*">
        </div>
        <button class="btn small outline" type="button" id="downloadImgBtn">â¬‡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <div class="stats">Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ JSON Ø³ØªØ±Ø³Ù„ ÙƒÙ€ data:image/webp;base64,... ÙˆÙŠÙ‚ÙˆÙ… index.html Ø¨Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      </div>
      <div class="modal-form">
        <div>
          <label>Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
          <input id="modalRefInput" placeholder="ÙŠØ³ØªØ®Ø¯Ù… Ø£ÙŠØ¶Ø§Ù‹ ÙƒØ§Ø³Ù… Ù…Ù„Ù JSON">
        </div>
        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
          <input id="modalTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­">
        </div>
        <div>
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="modalPrice" placeholder="Ù…Ø«Ø§Ù„: 350,000 SDG">
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label>
          <input id="modalPhone" placeholder="Ù…Ø«Ø§Ù„: 0912xxxxxx">
        </div>
        <div>
          <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
          <input id="modalLoc" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø®Ø±Ø·ÙˆÙ… - Ø¨Ø­Ø±ÙŠ">
        </div>
        <div>
          <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <input id="modalCategory" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">
        </div>
        <div>
          <label>ÙˆØµÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
          <textarea id="modalDesc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="left">
        <button class="btn primary" type="button" id="saveBtn"><span>ğŸ’¾</span> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button class="btn outline" type="button" id="downloadJsonBtn"><span>ğŸ“„</span> ØªÙ†Ø²ÙŠÙ„ JSON Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        <button class="btn danger" type="button" id="removeBtn"><span>ğŸ—‘</span> Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
      <div class="right">
        <span>1) Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</span>
        <span>2) Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§</span>
        <span>3) Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø©</span>
        <span>4) Ù†Ø²Ù‘Ù„ JSON ÙˆØ§Ø±ÙØ¹Ù‡ ÙÙŠ /ads</span>
      </div>
    </div>
  </div>
</div>

<script>
/* Ø«Ø§Ø¨ØªØ§Øª ÙˆØªÙ‡ÙŠØ¦Ø© Ø£Ø³Ø§Ø³ÙŠØ© */
const MARKER = 'ELDELALA_PAYLOAD:';
const markerBytes = new TextEncoder().encode(MARKER);
const STORAGE_KEY = 'eldelala_admin_with_webp_v1';

/* Ø¹Ù†Ø§ØµØ± DOM */
const fileInput = document.getElementById('fileInput');
const dropzone = document.getElementById('dropzone');
const scanBtn = document.getElementById('scanBtn');
const grid = document.getElementById('grid');
const countEl = document.getElementById('count');
const searchEl = document.getElementById('search');
const exportAllBtn = document.getElementById('exportAllBtn');
const importJsonBtn = document.getElementById('importJsonBtn');
const jsonInput = document.getElementById('jsonInput');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const filters = document.querySelectorAll('.filter-tag');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const modalRef = document.getElementById('modalRef');
const modalTitle = document.getElementById('modalTitle');
const modalPrice = document.getElementById('modalPrice');
const modalPhone = document.getElementById('modalPhone');
const modalLoc = document.getElementById('modalLoc');
const modalDesc = document.getElementById('modalDesc');
const modalCategory = document.getElementById('modalCategory');
const modalRefInput = document.getElementById('modalRefInput');
const modalImgInput = document.getElementById('modalImgInput');
const downloadJsonBtn = document.getElementById('downloadJsonBtn');
const saveBtn = document.getElementById('saveBtn');
const removeBtn = document.getElementById('removeBtn');
const closeModalBtn = document.getElementById('closeModal');
const downloadImgBtn = document.getElementById('downloadImgBtn');
const toast = document.getElementById('toast');
const fab = document.getElementById('fab');

/* Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ */
const newRef = document.getElementById('newRef');
const newTitle = document.getElementById('newTitle');
const newPrice = document.getElementById('newPrice');
const newPhone = document.getElementById('newPhone');
const newLoc = document.getElementById('newLoc');
const newCategory = document.getElementById('newCategory');
const newDesc = document.getElementById('newDesc');
const newImage = document.getElementById('newImage');
const newDownloadJsonBtn = document.getElementById('newDownloadJsonBtn');

let ads = [];
let currentFilter = 'all';
let selectedAdId = null;

/* HELPERs Ø¨Ø³ÙŠØ·Ø© */
function showToast(msg, ms=2000){
  toast.textContent = msg;
  toast.style.display = 'block';
  if (toast._t) clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.style.display='none', ms);
}

function uid(){
  return 'a' + Math.random().toString(36).slice(2,9);
}

/* Ù‡Ø±ÙˆØ¨ Ù†ØµÙˆØµ HTML */
function esc(s){
  return String(s || '').replace(/[&<>"\\]/g, c => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    '\\':'\\\\'
  }[c] || c));
}

/* ØªÙˆØ­ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ */
function normalize(raw){
  return {
    id: raw.id || uid(),
    ref: raw.ref_code || raw.ref || raw.code || raw.id || '',
    title: raw.name || raw.title || raw.headline || raw.fileName || '',
    price: raw.price || raw.p || '',
    phone: raw.contact || raw.phone || raw.tel || '',
    location: raw.location || raw.loc || raw.city || '',
    description: raw.description || raw.desc || raw.body || '',
    created_at: raw.created_at || new Date().toISOString(),
    imageDataUrl: raw.image || raw.thumb || raw.imageDataUrl || raw._blobUrl || '',
    category: raw.category || raw.cat || raw.type || raw.Category || 'Ø¹Ø§Ù…',
    _hasPayload: !!(raw && (raw.ref || raw.title || raw.price || raw.description))
  };
}

/* ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ */
function saveToLocal(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ ads }));
  }catch(e){
    console.warn('local save fail', e);
  }
}
function loadFromLocal(){
  try{
    const txt = localStorage.getItem(STORAGE_KEY);
    if (!txt) return;
    const data = JSON.parse(txt);
    if (data && Array.isArray(data.ads)){
      ads = data.ads.map(normalize);
    }
  }catch(e){
    console.warn('local load fail', e);
  }
}
function setCount(){
  countEl.textContent = ads.length + ' Ø¥Ø¹Ù„Ø§Ù†';
}

/* ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ dataURL Ø«Ù… WEBP Ù…Ø¶ØºÙˆØ· */
function fileOrBlobToDataUrl(fileOrBlob){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(fileOrBlob);
  });
}
async function imageFileToWebpDataUrl(file, maxW = 900, maxH = 900, quality = 0.8){
  const dataURL = await fileOrBlobToDataUrl(file);
  const img = await new Promise((resolve,reject)=>{
    const i = new Image();
    i.onload = ()=>resolve(i);
    i.onerror = reject;
    i.src = dataURL;
  });
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxW / w, maxH / h);
  const cw = Math.max(1, Math.round(w * scale));
  const ch = Math.max(1, Math.round(h * scale));
  const c = document.createElement('canvas');
  c.width = cw;
  c.height = ch;
  const ctx = c.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, 0, 0, cw, ch);
  return c.toDataURL('image/webp', quality);
}

/* ÙÙƒ Ø§Ù„Ù€ payload Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© PNG */
function base64ToUtf8(b64){
  try{
    const bin = atob(b64);
    const u8 = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(u8);
  }catch(e){
    try{
      return atob(b64);
    }catch(_){
      return null;
    }
  }
}
function findLastMarkerIndex(bytes, markerBytes){
  for (let i = bytes.length - markerBytes.length; i >= 0; i--){
    let j=0;
    for (; j<markerBytes.length; j++){
      if (bytes[i+j] !== markerBytes[j]) break;
    }
    if (j === markerBytes.length) return i;
  }
  return -1;
}
function extractBase64FromBytes(bytes, start){
  let s = '';
  for (let i=start; i<bytes.length; i++){
    const ch = String.fromCharCode(bytes[i]);
    if (/[\r\n\t ]/.test(ch)) continue;
    if (!/[A-Za-z0-9+/=]/.test(ch)) break;
    s += ch;
  }
  return s || null;
}

/* Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ù„Ù Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯ */
async function handleCardFile(file){
  try{
    const buf = await file.arrayBuffer();
    const raw = new Uint8Array(buf);
    const pos = findLastMarkerIndex(raw, markerBytes);
    let payload = null;

    if (pos >= 0){
      const start = pos + markerBytes.length;
      const b64 = extractBase64FromBytes(raw, start);
      if (b64){
        try{
          const txt = base64ToUtf8(b64);
          payload = JSON.parse(txt);
        }catch(e){}
      }
    }else{
      /* fallback: Ù„Ùˆ ØªÙ… Ø­Ù‚Ù† base64 ÙƒÙ€ data:application/json;base64,... ÙÙŠ Ø§Ù„ØªÙŠÙ„ */
      const textTail = new TextDecoder().decode(raw.slice(Math.max(0, raw.length - 4000)));
      const m = textTail.match(/data:application\/json;base64,([A-Za-z0-9+\/=\r\n]+)/);
      if (m){
        try{
          payload = JSON.parse(atob(m[1]));
        }catch(_){}
      }
    }

    const blobUrl = URL.createObjectURL(new Blob([raw], { type: file.type || 'image/png' }));

    if (payload){
      const n = normalize(payload);
      n.imageDataUrl =
        (payload.image && String(payload.image).startsWith('data:')) ? payload.image :
        (payload.imageDataUrl && String(payload.imageDataUrl).startsWith('data:')) ? payload.imageDataUrl :
        (payload.thumb && String(payload.thumb).startsWith('data:')) ? payload.thumb :
        (payload.imageDataUrl || payload.image || payload.thumb || blobUrl);

      n.location = payload.location || n.location || '';
      n.category = payload.category || payload.cat || n.category || 'Ø¹Ø§Ù…';
      n._hasPayload = true;
      n._fileName = file.name;
      ads.unshift(n);
    }else{
      const n = normalize({
        id: uid(),
        title: file.name,
        description: '',
        imageDataUrl: blobUrl,
        created_at: new Date().toISOString(),
        _blobUrl: blobUrl,
        fileName: file.name
      });
      n._hasPayload = false;
      ads.unshift(n);
    }
  }catch(e){
    console.error(e);
    showToast('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
  }
}

/* ÙØ­Øµ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù„ÙØ§Øª */
async function scanList(files){
  const arr = Array.from(files || []);
  if (!arr.length){
    showToast('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª');
    return;
  }
  showToast('Ø¬Ø§Ø±Ù ÙØ­Øµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...');
  for (let i=0;i<arr.length;i++){
    await handleCardFile(arr[i]);
  }
  saveToLocal();
  renderGrid();
  setCount();
  showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØ­Øµ');
}

/* RENDER Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
function renderGrid(){
  grid.innerHTML = '';
  const filterText = (searchEl.value || '').trim().toLowerCase();

  const items = ads.filter(a => {
    if (currentFilter === 'with' && !a._hasPayload) return false;
    if (currentFilter === 'without' && a._hasPayload) return false;
    if (filterText){
      const hay = (a.ref + ' ' + a.title + ' ' + a.location + ' ' + a.description).toLowerCase();
      if (hay.indexOf(filterText) === -1) return false;
    }
    return true;
  });

  items.forEach(a => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = a.id;

    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = a.imageDataUrl || '';
    img.alt = a.title || 'ØµÙˆØ±Ø©';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `
      <div class="name">${esc(a.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</div>
      <div class="desc">${esc(a.description || '')}</div>
      <div class="row" style="margin-top:4px">
        <span class="badge">${esc(a.category || 'Ø¹Ø§Ù…')}</span>
        <span style="margin-inline-start:auto;font-size:12px;color:${a.price ? '#16a34a' : '#9ca3af'};font-weight:700">${esc(a.price || '')}</span>
      </div>
      <div class="row" style="font-size:11px;margin-top:4px;color:var(--muted)">
        <span>${esc(a.location || '')}</span>
        <span style="margin-inline-start:auto">${esc(a.ref || '')}</span>
      </div>
    `;

    const actions = document.createElement('div');
    actions.className = 'card-actions';
    actions.innerHTML = `
      <button class="icon-btn" data-act="open" title="ÙØªØ­ ÙˆØªØ¹Ø¯ÙŠÙ„"><span>âœï¸</span></button>
      <button class="icon-btn" data-act="img" title="ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©"><span>ğŸ–¼</span></button>
      <button class="icon-btn" data-act="json" title="ØªÙ†Ø²ÙŠÙ„ JSON"><span>ğŸ“„</span></button>
    `;

    card.appendChild(img);
    card.appendChild(meta);
    card.appendChild(actions);

    card.addEventListener('click', e => {
      const act = e.target.closest('[data-act]');
      if (act){
        const actType = act.dataset.act;
        if (actType === 'open') openModalById(a.id);
        if (actType === 'img') downloadImage(a.id);
        if (actType === 'json'){
          selectedAdId = a.id;
          downloadJsonBtn.click();
        }
        e.stopPropagation();
        return;
      }
      openModalById(a.id);
    });

    /* Ø³Ø­Ø¨/Ø¥ÙÙ„Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    card.draggable = true;
    card.addEventListener('dragstart', ev => {
      ev.dataTransfer.effectAllowed = 'move';
      ev.dataTransfer.setData('text/plain', a.id);
      card.classList.add('dragging');
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      saveToLocal();
      renderGrid();
      setCount();
    });

    grid.appendChild(card);
  });

  grid.ondragover = e => {
    e.preventDefault();
    const dragging = grid.querySelector('.card.dragging');
    if (!dragging) return;
    const afterElement = getDragAfterElement(grid, e.clientY);
    if (afterElement == null){
      grid.appendChild(dragging);
    }else{
      grid.insertBefore(dragging, afterElement);
    }
    const newOrder = [...grid.children].map(el => el.dataset.id);
    ads.sort((a,b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
  };
}

/* Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§Ù† Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© */
function getDragAfterElement(container, y){
  const elements = [...container.querySelectorAll('.card:not(.dragging)')];
  let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
  elements.forEach(child => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset){
      closest = { offset, element: child };
    }
  });
  return closest.element;
}

/* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ + Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
function openModalById(adId){
  selectedAdId = adId;
  const a = ads.find(x => x.id === adId);
  if (!a) return;
  modalImg.src = a.imageDataUrl || '';
  modalRef.textContent = a.ref || a.id || 'â€”';
  modalRefInput.value = a.ref || a.id || '';
  modalTitle.value = a.title || '';
  modalPrice.value = a.price || '';
  modalPhone.value = a.phone || '';
  modalLoc.value = a.location || '';
  modalCategory.value = a.category || 'Ø¹Ø§Ù…';
  modalDesc.value = a.description || '';
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
}
function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden', 'true');
  selectedAdId = null;
}

closeModalBtn.addEventListener('click', closeModal);
modal.addEventListener('click', e => {
  if (e.target === modal) closeModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

/* Ø­ÙØ¸ Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
saveBtn.addEventListener('click', () => {
  if (!selectedAdId) return;
  const idx = ads.findIndex(x => x.id === selectedAdId);
  if (idx < 0) return;
  ads[idx].ref = modalRefInput.value.trim() || ads[idx].ref || ads[idx].id;
  ads[idx].title = modalTitle.value.trim();
  ads[idx].price = modalPrice.value.trim();
  ads[idx].phone = modalPhone.value.trim();
  ads[idx].location = modalLoc.value.trim();
  ads[idx].category = (modalCategory && modalCategory.value ? modalCategory.value.trim() : (ads[idx].category || 'Ø¹Ø§Ù…'));
  ads[idx].description = modalDesc.value.trim();
  ads[idx]._hasPayload = true;
  saveToLocal();
  renderGrid();
  setCount();
  showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
  closeModal();
});

/* Ø­Ø°Ù Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
removeBtn.addEventListener('click', () => {
  if (!selectedAdId) return;
  const idx = ads.findIndex(x => x.id === selectedAdId);
  if (idx < 0) return;
  ads.splice(idx, 1);
  saveToLocal();
  renderGrid();
  setCount();
  showToast('Ø­ÙØ°Ù Ø§Ù„Ø¹Ù†ØµØ±');
  closeModal();
});

/* ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ â†’ WEBP ÙÙŠ JSON */
modalImgInput.addEventListener('change', async (e) => {
  if (!selectedAdId) return;
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  try{
    const webp = await imageFileToWebpDataUrl(file, 900, 900, 0.8);
    const idx = ads.findIndex(x => x.id === selectedAdId);
    if (idx < 0) return;
    ads[idx].imageDataUrl = webp;
    modalImg.src = webp;
    saveToLocal();
    renderGrid();
    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (WEBP Ø¯Ø§Ø®Ù„ JSON)');
  }catch(err){
    console.error(err);
    showToast('ØªØ¹Ø°Ø± ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ WEBP', 2500);
  }finally{
    modalImgInput.value = '';
  }
});

/* ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ */
function downloadImage(id){
  const a = ads.find(x => x.id === id);
  if (!a || !a.imageDataUrl){
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
    return;
  }
  const link = document.createElement('a');
  link.href = a.imageDataUrl;
  link.download = (a.ref || a.id || 'ad') + '.png';
  document.body.appendChild(link);
  link.click();
  link.remove();
}
downloadImgBtn.addEventListener('click', () => {
  if (!selectedAdId) return;
  downloadImage(selectedAdId);
});

/* ØªÙ†Ø²ÙŠÙ„ JSON Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ */
downloadJsonBtn.addEventListener('click', () => {
  if (!selectedAdId) return;
  const idx = ads.findIndex(x => x.id === selectedAdId);
  if (idx < 0) return;
  const a = ads[idx];

  /* Ù…Ø²Ø§Ù…Ù†Ø© Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ */
  a.ref       = (modalRefInput.value || '').trim() || a.ref || a.id;
  a.title     = (modalTitle.value || '').trim();
  a.price     = (modalPrice.value || '').trim();
  a.phone     = (modalPhone.value || '').trim();
  a.location  = (modalLoc.value || '').trim();
  a.category  = (modalCategory && modalCategory.value ? modalCategory.value.trim() : (a.category || 'Ø¹Ø§Ù…'));
  a.description = (modalDesc.value || '').trim();
  a._hasPayload = true;

  const out = {
    ref_code: a.ref || a.id,
    name: a.title || '',
    description: a.description || '',
    location: a.location || '',
    price: a.price || '',
    contact: a.phone || '',
    category: a.category || 'Ø¹Ø§Ù…',
    image: a.imageDataUrl || a.image || '',
    created_at: a.created_at || a.createdAt || new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const ael = document.createElement('a');
  ael.href = url;
  ael.download = (out.ref_code || 'ad') + '.json';
  document.body.appendChild(ael);
  ael.click();
  ael.remove();
  URL.revokeObjectURL(url);

  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù JSON â€” Ø§Ø±ÙØ¹Ù‡ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ /ads ÙÙŠ GitHub.');
});

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSONØ§Øª Ø¬Ø§Ù‡Ø²Ø© */
importJsonBtn.addEventListener('click', () => jsonInput.click());
jsonInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;
  for (const f of files){
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      if (Array.isArray(data)){
        data.forEach(d => ads.push(normalize(d)));
      }else{
        ads.push(normalize(data));
      }
    }catch(err){
      console.error(err);
      showToast('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¹Ø¶ Ù…Ù„ÙØ§Øª JSON');
    }
  }
  saveToLocal();
  renderGrid();
  setCount();
});

/* ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ */
exportAllBtn.addEventListener('click', () => {
  if (!ads.length){
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  const out = ads.map(a => ({
    ref_code: a.ref || a.id,
    name: a.title || '',
    description: a.description || '',
    location: a.location || '',
    price: a.price || '',
    contact: a.phone || '',
    category: a.category || 'Ø¹Ø§Ù…',
    image: a.imageDataUrl || a.image || '',
    created_at: a.created_at || a.createdAt || new Date().toISOString()
  }));
  const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const ael = document.createElement('a');
  ael.href = url;
  ael.download = 'all_ads.json';
  document.body.appendChild(ael);
  ael.click();
  ael.remove();
  URL.revokeObjectURL(url);
  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù all_ads.json');
});

/* Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ */
saveLocalBtn.addEventListener('click', () => {
  saveToLocal();
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­');
});

/* Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ */
fab.addEventListener('click', () => {
  if (!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· (Ù„Ù† ÙŠØ¤Ø«Ø± Ø°Ù„Ùƒ Ø¹Ù„Ù‰ GitHub). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  ads = [];
  localStorage.removeItem(STORAGE_KEY);
  renderGrid();
  setCount();
  showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª');
});

/* Ø¨Ø­Ø« ÙˆÙÙ„Ø§ØªØ± */
searchEl.addEventListener('input', () => renderGrid());
filters.forEach(btn => {
  btn.addEventListener('click', () => {
    filters.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter || 'all';
    renderGrid();
  });
});

/* Ø³Ø­Ø¨/Ø¥ÙÙ„Ø§Øª Ù…Ù„ÙØ§Øª Ù…Ù† dropzone */
dropzone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => scanList(e.target.files));

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('dropzone--active');
});
dropzone.addEventListener('dragleave', e => {
  e.preventDefault();
  dropzone.classList.remove('dropzone--active');
});
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dropzone--active');
  scanList(e.dataTransfer.files);
});

/* Ø²Ø± Ù…Ø³Ø­ Ù…Ù„ÙØ§Øª (Ù†ÙØ³ ÙˆØ¸ÙŠÙØ© input) */
scanBtn.addEventListener('click', () => fileInput.click());

/* Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§ + ØµÙˆØ±Ø© WEBP */
newDownloadJsonBtn.addEventListener('click', async () => {
  try{
    const ref = (newRef.value || '').trim() || ('R' + Date.now().toString(36).slice(-6).toUpperCase());
    let imageDataUrl = '';
    const file = newImage.files && newImage.files[0];

    if (file){
      try{
        imageDataUrl = await imageFileToWebpDataUrl(file, 900, 900, 0.8);
      }catch(e){
        console.warn('failed to convert new ad image to webp', e);
      }
    }

    const out = {
      ref_code: ref,
      name: (newTitle.value || '').trim(),
      description: (newDesc.value || '').trim(),
      location: (newLoc.value || '').trim(),
      price: (newPrice.value || '').trim(),
      contact: (newPhone.value || '').trim(),
      category: (newCategory.value || '').trim() || 'Ø¹Ø§Ù…',
      image: imageDataUrl,
      created_at: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const ael = document.createElement('a');
    ael.href = url;
    ael.download = ref + '.json';
    document.body.appendChild(ael);
    ael.click();
    ael.remove();
    URL.revokeObjectURL(url);
    showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù JSON Ø¬Ø¯ÙŠØ¯ â€” Ø§Ø±ÙØ¹Ù‡ Ø¥Ù„Ù‰ /ads');
  }catch(err){
    console.error(err);
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ JSON', 2500);
  }
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
loadFromLocal();
renderGrid();
setCount();
</script>
</body>
</html>
