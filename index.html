<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الدلالة — إعلانات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f7fbff;color:#0b1320;line-height:1.4}
  .container{max-width:1100px;margin:10px auto;padding:10px}
  header{background:#0078d7;color:#fff;padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
  .brand .title{font-size:20px;font-weight:900}
  /* Mobile-friendly nav: collapse into a toggle on small screens */
  .menu-toggle{display:none;background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button[aria-current="true"]{background:#fff;color:#0078d7;border:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;align-items:center}
  input, textarea, select{padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;font-size:15px;background:#fff}
  .btn{background:#0078d7;color:#fff;padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn.alt{background:#6b7280}
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 26px rgba(11,19,32,0.06);display:flex;flex-direction:column;transition:transform .12s}
  .card:hover{transform:translateY(-6px)}
  .media{height:180px;background:#f0f4f8;display:flex;align-items:center;justify-content:center;position:relative}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .body{padding:10px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:700;font-size:16px}
  .desc{color:#334155;font-size:13px;max-height:3.2em;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;align-items:center;margin-top:auto;flex-wrap:wrap}
  .badge{background:#eef8ff;color:#0078d7;padding:6px 8px;border-radius:999px;font-weight:700}
  .small{font-size:13px;color:#333}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:999}
  .modal.open{display:flex}
  .modalCard{background:#fff;border-radius:12px;max-width:920px;width:96%;max-height:92vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .modalTop{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
  .modalMedia{width:420px;max-width:100%;min-width:260px;background:#f4f6f9;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;gap:8px;padding:8px}
  .modalMedia img{width:100%;height:auto;object-fit:contain;border-radius:8px}
  .thumbRow{display:flex;gap:8px;overflow-x:auto;padding-top:6px}
  .thumbRow img{width:64px;height:48px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent}
  .thumbRow img.selected{border-color:#0b84ff}
  .modalBody{flex:1;display:flex;flex-direction:column;gap:8px}
  .detailsList{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .detailsItem{background:#fbfdff;padding:10px;border-radius:8px;border:1px solid #eef6ff}
  @media(max-width:820px){
    .modalTop{flex-direction:column}
    .modalMedia{width:100%}
    .detailsList{grid-template-columns:1fr}
  }

  /* Hide builder-only artifacts on the main page and small previews */
  .tiny-preview, img.small-thumb, .thumbRow.small { display:none !important; }
  /* additional selectors that visual builders sometimes inject */
  .visual-builder, .vb, .builder-preview, .built-card, .editor-only { display:none !important; }

  /* Accessibility & touch targets */
  button, .btn, input[type="button"], input[type="submit"]{touch-action:manipulation}

  /* Small screens adjustments */
  @media(max-width:560px){
    .brand .title{font-size:18px}
    header{padding:8px}
    .menu-toggle{display:block}
    nav{display:none;width:100%;flex-direction:column}
    nav.open{display:flex}
    .controls{gap:6px}
    .media{height:160px}
  }

  /* Prevent main from showing heavy builder visuals by default */
  #previewCard, #adminPanel, #adminBtn { display:none !important; }

</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="brand"><div class="title">الدلالة</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="menu-toggle" id="menuToggle" aria-label="قائمة">☰</button>
      <nav aria-label="واجهة" id="mainNav">
        <button data-target="home" class="nav-btn" aria-current="true">الرئيسية</button>
        <button data-target="send" class="nav-btn">أرسل إعلانك</button>
        <button data-target="privacy" class="nav-btn">سياسة الخصوصية</button>
      </nav>
    </div>
  </header>
  <div class="controls" role="search" aria-label="بحث وتحكم">
    <div style="flex:1;min-width:140px"><input id="q" type="search" placeholder="ابحث بالعنوان أو الرمز أو الموقع"></div>
    <div style="width:170px"><select id="catFilter"><option value="">كل الاقسام</option></select></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refresh" class="btn alt">⟳ تحديث</button>
      <div id="count" class="small" aria-live="polite">تحميل...</div>
    </div>
  </div>

  <main>
    <section id="home" aria-live="polite">
      <div id="grid" class="grid" role="list" aria-label="قائمة الإعلانات"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px" class="small">لا توجد إعلانات</div>
      <button id="loadMore" class="loadMore" style="display:none">عرض المزيد</button>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h2>لتقديم طلب موافقة علي اعلان : </h2>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="اسم الإعلان">
          <input id="f_price" placeholder="السعر">
          <textarea id="f_desc" placeholder="وصف الإعلان" rows="4"></textarea>
          <input id="f_loc" placeholder="الموقع">
          <input id="f_contact" placeholder="رقم التواصل">
          <input id="f_cat" placeholder="التصنيف">
          <div><input id="f_file" type="file" accept="image/*"></div>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="agree" />
            <span class="small">أقر أن البيانات صحيحة وأوافق على شروط النشر</span>
          </label>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="btn">بدء</button>
            <div id="submitStatus" class="small"></div>
          </div>
          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>رمز الإعلان الخاص بك:</div>
            <div class="refBox" style="margin-top:6px">
              <div id="refCode" class="refCode" style="background:#f0f9ff;padding:6px 12px;border-radius:10px;color:#0078d7;font-weight:800"></div>
              <a id="openWa" class="small" target="_blank" style="margin-left:8px;color:#0078d7;display:none"></a>
              <button id="downloadEmbedded" class="btn alt" style="margin-left:8px;display:none">تحميل البطاقة</button>
            </div>
          </div>
          <div id="fallbackJson" style="display:none;margin-top:8px">
            <div class="small">لن يتم نشر اعلانك مالم ترسل لنا البطاقة. بعد التحميل يمكنك أن تجد البطاقة في المستندات.</div>
          </div>
          <div id="previewCard" class="subCard" style="display:none">
            <div id="previewCanvasWrap"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="privacy" style="display:none">
      <div class="panel">
        <h3>سياسة الخصوصية</h3>
        <div style="white-space:pre-wrap;background:#fff;padding:12px;border-radius:8px;border:1px solid #eef6ff;margin-top:8px">
باستخدامك لموقع الدلالة فأنت توافق على هذه الشروط... (المتبقي كما في الأصل)
        </div>
      </div>
    </section>
  </main>
</div>


<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard" role="document" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div id="modalTitle" style="font-weight:800;font-size:18px"></div>
        <div id="modalMeta" class="small" style="margin-top:6px"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="refBox">
          <div id="modalRef" class="refCode"></div>
          <button id="modalCopy" class="copyBtn">نسخ الرمز</button>
        </div>
        <button id="modalClose" class="btn alt">إغلاق</button>
      </div>
    </div>

    <div class="modalTop">
      <div class="modalMedia" id="modalMedia">
        <img id="modalMainImg" src="" alt="صورة الإعلان" style="display:none" />
      </div>

      <div class="modalBody">
        <div id="modalDescription" class="fullDesc"></div>
        <div class="detailsList">
          <div class="detailsItem"><strong>الموقع</strong><div id="modalLoc" class="muted"></div></div>
          <div class="detailsItem"><strong>التصنيف</strong><div id="modalCat" class="badge"></div></div>
          <div class="detailsItem"><strong>السعر</strong><div id="modalPrice" class="price"></div></div>
          <div class="detailsItem"><strong>التواصل</strong><div id="modalContact" class="muted"></div></div>
        </div>
      </div>
    </div>

    <div class="modalFooter" style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div style="display:flex;gap:8px;align-items:center">
        <a id="modalWhats" class="btn" target="_blank">مشاركة عبر WhatsApp</a>
        <a id="modalCall" class="btn alt" style="display:none" href="#">اتصال</a>
        <button id="modalDownloadCard" class="btn" style="display:none">⬇ تنزيل البطاقة</button>
      </div>
      <div class="small muted">ملاحظة: تأكد من صحة المعلومات بنفسك.</div>
    </div>
  </div>
</div>

<script>
/* Utilities */
const CFG_KEY = 'static_ads_cfg_v1';
const CACHE_KEY = 'static_ads_cache_v1';
const MARKER = 'ELDELALA_PAYLOAD:';

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c]||c)); }
function debounce(fn,t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }

let ads = []; // in-memory
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const countEl = document.getElementById('count');
const loadMoreBtn = document.getElementById('loadMore');

/* Mobile nav toggle */
const menuToggle = document.getElementById('menuToggle');
const mainNav = document.getElementById('mainNav');
menuToggle && menuToggle.addEventListener('click', ()=>{ mainNav.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', mainNav.classList.contains('open')); });

/* Navigation */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('main > section').forEach(s=> s.style.display='none');
    document.getElementById(btn.dataset.target).style.display='block';
    document.querySelectorAll('.nav-btn').forEach(n=>n.removeAttribute('aria-current'));
    btn.setAttribute('aria-current','true');
    // close mobile nav automatically
    if(mainNav && mainNav.classList.contains('open')) mainNav.classList.remove('open');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

/* Render grid */
function renderGrid(list){
  grid.innerHTML='';
  list = list || [];
  if(!list.length){ document.getElementById('noitems').style.display='block'; countEl.textContent='0 إعلان'; return; }
  document.getElementById('noitems').style.display='none';
  list.forEach(a=>{
    const el = document.createElement('div'); el.className='card';
    const thumb = a.thumb || a._blobUrl || '';
    // ensure images are lazy-loaded and small previews are not shown on main page
    const mediaHtml = thumb ? `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(a.name||'')}" loading="lazy">` : `<div class="noimg small">لا صورة</div>`;
    el.innerHTML = `<div class="media">${mediaHtml}</div>
      <div class="body"><div class="title">${escapeHtml(a.name||'')}</div>
      <div class="desc">${escapeHtml(a.description||'')}</div>
      <div class="meta"><div class="badge">${escapeHtml(a.category||'عام')}</div><div style="margin-left:auto" class="small">${escapeHtml(a.ref_code||'')}</div></div></div>`;
    el.addEventListener('click', ()=> openDetails(a));
    grid.appendChild(el);
  });
  countEl.textContent = list.length + ' إعلان';
}

/* Modal refs (unchanged) */
const modal = document.getElementById('modal');
const modalMainImg = document.getElementById('modalMainImg');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalRef = document.getElementById('modalRef');
const modalDescription = document.getElementById('modalDescription');
const modalLoc = document.getElementById('modalLoc');
const modalCat = document.getElementById('modalCat');
const modalPrice = document.getElementById('modalPrice');
const modalContact = document.getElementById('modalContact');
const modalWhats = document.getElementById('modalWhats');
const modalCall = document.getElementById('modalCall');
const modalDownloadCard = document.getElementById('modalDownloadCard');
const modalClose = document.getElementById('modalClose');
modalClose.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });

function openDetails(item){
  modalTitle.textContent = item.name || 'بدون عنوان';
  modalMeta.textContent = `رمز: ${item.ref_code||''}`;
  modalRef.textContent = item.ref_code||'';
  modalDescription.textContent = item.description||'-';
  modalLoc.textContent = item.location||'-';
  modalCat.textContent = item.category||'عام';
  modalPrice.textContent = item.price || '-';
  modalContact.textContent = item.contact || '-';

  if(item._blobUrl){
    modalMainImg.src = item._blobUrl;
    modalMainImg.style.display = 'block';
  } else if(item.thumb){
    modalMainImg.src = item.thumb;
    modalMainImg.style.display = 'block';
  } else {
    modalMainImg.src = '';
    modalMainImg.style.display = 'none';
  }

  if(item.contact && item.contact.trim()){
    modalCall.style.display = 'inline-block';
    const phoneDigits = (item.contact.match(/[+0-9][0-9() \\ -]{4,}/) || [])[0] || item.contact;
    modalCall.href = 'tel:' + phoneDigits.replace(/\s+/g,'').replace(/[^+0-9]/g,'');
  } else modalCall.style.display = 'none';

  modalWhats.href = `https://wa.me/?text=${encodeURIComponent((item.name || '') + ' - ' + (window.location.href.split('#')[0] + '#ad-' + (item.ref_code||'')))}`;
  modalWhats.target = '_blank';

  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}

function applyFiltersAndRender(){
  const q = (qEl && qEl.value || '').trim().toLowerCase();
  const cat = (catFilter && catFilter.value || '').trim();
  let out = ads.slice();

  if(cat){ out = out.filter(a => (a.category||'').toString() === cat); }
  if(q){ out = out.filter(a => { const hay = ((a.name || '') + ' ' + (a.description||'') + ' ' + (a.location||'') + ' ' + (a.ref_code||'')).toLowerCase(); return hay.indexOf(q) !== -1; }); }

  out.sort((A,B) => { const aCat = (A.category || '').toString().localeCompare((B.category || '').toString(), 'ar'); if(aCat !== 0) return aCat; return (A.name || '').toString().localeCompare((B.name || '').toString(), 'ar'); });

  // Only render a compact subset on the main page to avoid showing builder visuals
  const compact = out.map(x=>({ ref_code: x.ref_code, name: x.name, price: x.price, description: x.description, location: x.location, category: x.category, thumb: x.thumb, _blobUrl: x._blobUrl }));
  renderGrid(compact);
}

renderGrid([]);

/* The rest of the original scripts (image embedding, form handling, loading ads JSON) are preserved but slightly trimmed for clarity. */

async function loadAdsJson(){
  try{
    const r = await fetch('./ads.json', {cache:'no-cache'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const raw = await r.json();
    const arr = Array.isArray(raw) ? raw : (raw.ads || raw.items || []);
    ads = arr.map(it => {
      const thumb = it.thumb || it.image || it.imageDataUrl || '';
      return {
        ref_code: it.ref || it.ref_code || it.id || '',
        name: it.title || it.name || it.headline || '',
        price: it.price || it.amount || '',
        description: it.description || it.desc || it.body || '',
        location: it.location || it.city || it.loc || '',
        contact: it.phone || it.contact || it.tel || '',
        category: (it.category || it.cat || it.type || it.Category || '').toString().trim() || 'عام',
        thumb: (typeof thumb === 'string' && thumb.startsWith('data:')) ? thumb : (it.imageDataUrl && it.imageDataUrl.startsWith('data:') ? it.imageDataUrl : ''),
        _fileName: it._fileName || ''
      };
    });

    try{
      const cats = [...new Set(ads.map(a=>a.category||'عام'))];
      cats.sort((a,b)=> a.toString().localeCompare(b.toString(), 'ar'));
      const cf = document.getElementById('catFilter');
      if(cf) cf.innerHTML = '<option value="">كل الاقسام</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }catch(e){ console.warn('category populate', e); }

    if(qEl){ qEl.addEventListener('input', debounce(()=>applyFiltersAndRender(), 220)); }
    if(catFilter){ catFilter.addEventListener('change', ()=>applyFiltersAndRender()); }
    const refresh = document.getElementById('refresh');
    if(refresh) refresh.addEventListener('click', ()=>{ loadAdsJson(); });

    applyFiltersAndRender();
  }catch(err){
    console.error('loadAdsJson failed', err);
    if(document.getElementById('noitems')) document.getElementById('noitems').style.display='block';
    if(document.getElementById('count')) document.getElementById('count').textContent='0 إعلان';
  }
}
window.addEventListener('load', ()=>{ setTimeout(()=>loadAdsJson(), 50); });

</script>

</body>
</html>
