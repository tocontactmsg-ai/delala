<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© | Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</title>
<link rel="icon" type="image/png" href="/favicon.ico">

<meta name="description" content="Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ." />

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">

<style>
  /* --- CORE STYLES --- */
  :root {
    --primary: #0078d7;
    --bg: #f7fbff;
    --text: #0b1320;
    --white: #ffffff;
    --accent: #ffcc00;
  }
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:var(--bg);color:var(--text);line-height:1.5;padding-bottom: 80px;}
  .container{max-width:1100px;margin:0 auto;padding:12px}
  
  /* HEADER */
  header{background:var(--primary);color:var(--white);padding:12px;border-radius:0 0 14px 14px;box-shadow:0 4px 20px rgba(0,120,215,0.25);margin-bottom:16px;position:sticky;top:0;z-index:50;}
  header .brand{display:flex;align-items:center;justify-content:space-between;}
  .brand .title{font-size:22px;font-weight:900;letter-spacing:-0.5px}
  
  /* NAVIGATION */
  nav{display:flex;gap:8px;}
  nav button{
    background:rgba(255,255,255,0.15);color:#fff;border:none;
    padding:8px 14px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:700;
    transition: all 0.2s;
  }
  nav button:hover, nav button.active{background:#fff;color:var(--primary);transform:scale(1.05);}

  /* CONTROLS (Search & Filter) */
  .controls{display:grid;grid-template-columns:1fr 140px;gap:10px;margin-bottom:16px;}
  @media(max-width:480px){ .controls{grid-template-columns:1fr;} }
  
  input, select, textarea{
    padding:12px;border-radius:12px;border:1px solid #e6eef8;width:100%;
    font-size:15px;background:#fff;outline:none;transition:0.2s;
  }
  input:focus, select:focus, textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,120,215,0.1);}
  
  /* GRID & CARDS */
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px}
  .card{
    background:#fff;border-radius:16px;overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,0.04);transition:transform .2s, box-shadow .2s;
    cursor:pointer;position:relative;border:1px solid #f0f4f8;
  }
  .card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,0.08);}
  
  .media{height:200px;background:#f1f5f9;position:relative;overflow:hidden;}
  .media img{width:100%;height:100%;object-fit:cover;transition:0.3s;}
  .card:hover .media img{transform:scale(1.03);}
  
  .body{padding:14px;}
  .card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;}
  .price{font-weight:800;color:#059669;font-size:16px;}
  .cat-badge{font-size:11px;background:#eff6ff;color:var(--primary);padding:4px 8px;border-radius:8px;font-weight:700;}
  
  .title{font-weight:800;font-size:16px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .loc{font-size:12px;color:#64748b;display:flex;align-items:center;gap:4px;}
  
  /* BUTTONS */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;
    background:var(--primary);color:#fff;padding:12px 20px;
    border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:14px;
    text-decoration:none;transition:0.2s;width:100%;
  }
  .btn:active{transform:scale(0.98);}
  .btn.red{background:#ef4444;}
  .btn.green{background:#10b981;}
  .btn.orange{background:#f59e0b;}
  .btn:disabled{opacity:0.6;cursor:not-allowed;}

  /* SECTIONS */
  main > section{display:none;animation: fadeIn 0.3s ease-in-out;}
  main > section.active{display:block;}
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

  /* ADMIN PANEL STYLES */
  #adminLogin{text-align:center;padding:40px 20px;}
  .admin-dashboard{background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.05);padding:16px;margin-top:20px;}
  .admin-tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #f1f5f9;padding-bottom:10px;}
  .tab-btn{background:none;border:none;padding:8px 16px;cursor:pointer;color:#64748b;font-weight:700;}
  .tab-btn.active{color:var(--primary);border-bottom:2px solid var(--primary);margin-bottom:-12px;}
  
  .admin-list .card{flex-direction:row;display:flex;height:auto;margin-bottom:12px;padding:8px;}
  .admin-list .media{width:80px;height:80px;border-radius:8px;flex-shrink:0;}
  .admin-list .body{padding:0 12px;flex:1;}
  .admin-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .mini-btn{padding:6px 10px;border-radius:8px;font-size:12px;border:none;cursor:pointer;color:white;display:flex;align-items:center;gap:4px;}
  
  /* MODAL */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,0.8);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px;backdrop-filter:blur(4px);}
  .modal.open{display:flex;}
  .modal-card{background:#fff;width:100%;max-width:600px;border-radius:20px;overflow:hidden;display:flex;flex-direction:column;max-height:90vh;}
  .modal-img-box{background:#000;height:300px;display:flex;align-items:center;justify-content:center;}
  .modal-img-box img{max-width:100%;max-height:100%;}
  .modal-content{padding:20px;overflow-y:auto;}
  .modal-footer{padding:16px;background:#f8fafc;display:flex;gap:10px;}
  
  /* EDIT MODAL SPECIFIC */
  #editModal .modal-card{max-height:95vh;}

  /* UTILS */
  .hidden{display:none !important;}
  .spinner{width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-left:8px;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="brand">
      <div class="title" onclick="tryAdmin()">Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</div>
      <nav>
        <button onclick="nav('home')" class="active" id="btn-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button onclick="nav('send')" id="btn-send">Ø£Ø¹Ù„Ù†</button>
      </nav>
    </div>
  </header>

  <div id="msgBox" style="display:none;padding:12px;border-radius:12px;margin-bottom:16px;color:white;font-weight:bold;text-align:center;"></div>

  <main>
    <!-- HOME SECTION -->
    <section id="home" class="active">
      <div class="controls">
        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙŠØ§Ø±Ø©ØŒ Ø¹Ù‚Ø§Ø±..." oninput="filterAds()">
        <select id="catFilter" onchange="filterAds()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
          <option value="Ø³ÙŠØ§Ø±Ø§Øª">Ø³ÙŠØ§Ø±Ø§Øª</option>
          <option value="Ø¹Ù‚Ø§Ø±Ø§Øª">Ø¹Ù‚Ø§Ø±Ø§Øª</option>
          <option value="Ù‡ÙˆØ§ØªÙ">Ù‡ÙˆØ§ØªÙ</option>
          <option value="Ø£Ø«Ø§Ø«">Ø£Ø«Ø§Ø«</option>
          <option value="Ø®Ø¯Ù…Ø§Øª">Ø®Ø¯Ù…Ø§Øª</option>
          <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      
      <div id="loader" style="text-align:center;padding:40px;color:#64748b;">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...
      </div>
      
      <div id="grid" class="grid"></div>
    </section>

    <!-- SEND AD SECTION -->
    <section id="send">
      <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.05);">
        <h2 style="margin-top:0;">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h2>
        <form id="adForm" onsubmit="submitAd(event)">
          <!-- Using same inputs as Edit Modal for consistency -->
          <div style="display:grid;gap:12px;">
            <div>
              <label style="font-size:13px;font-weight:700;color:#64748b">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
              <input type="text" id="f_title" required placeholder="Ù…Ø«Ø§Ù„: ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§ 2020">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label style="font-size:13px;font-weight:700;color:#64748b">Ø§Ù„Ø³Ø¹Ø± (SDG)</label>
                <input type="text" id="f_price" required placeholder="Ù…Ø«Ø§Ù„: 5000000">
              </div>
              <div>
                <label style="font-size:13px;font-weight:700;color:#64748b">Ø§Ù„Ù‚Ø³Ù…</label>
                <select id="f_cat" required>
                  <option value="Ø³ÙŠØ§Ø±Ø§Øª">Ø³ÙŠØ§Ø±Ø§Øª</option>
                  <option value="Ø¹Ù‚Ø§Ø±Ø§Øª">Ø¹Ù‚Ø§Ø±Ø§Øª</option>
                  <option value="Ù‡ÙˆØ§ØªÙ">Ù‡ÙˆØ§ØªÙ</option>
                  <option value="Ø£Ø«Ø§Ø«">Ø£Ø«Ø§Ø«</option>
                  <option value="Ø®Ø¯Ù…Ø§Øª">Ø®Ø¯Ù…Ø§Øª</option>
                  <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>
            </div>

            <div>
              <label style="font-size:13px;font-weight:700;color:#64748b">Ø§Ù„ÙˆØµÙ</label>
              <textarea id="f_desc" rows="4" required placeholder="ÙˆØµÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†..."></textarea>
            </div>

            <div>
              <label style="font-size:13px;font-weight:700;color:#64748b">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨)</label>
              <input type="tel" id="f_phone" required placeholder="0912345678">
            </div>

            <div>
              <label style="font-size:13px;font-weight:700;color:#64748b">ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</label>
              <input type="file" id="f_img" accept="image/*" required style="padding:8px;">
              <div style="font-size:11px;color:#ef4444;margin-top:4px;">* Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>
            </div>

            <button type="submit" class="btn" id="submitBtn">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin">
      <div id="adminLogin">
        <h3>ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="max-width:300px;text-align:center;margin-bottom:12px;">
        <button onclick="loginAdmin()" class="btn" style="max-width:300px;">Ø¯Ø®ÙˆÙ„</button>
      </div>

      <div id="adminDash" class="hidden">
        <div class="admin-dashboard">
          <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchAdminTab('pending')">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="tab-btn" onclick="switchAdminTab('active')">âœ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</button>
          </div>
          <div id="adminList" class="admin-list"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- ITEM MODAL (VIEW) -->
<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-card">
    <div class="modal-img-box">
      <img id="m_img" src="" alt="">
    </div>
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
        <span id="m_price" class="price"></span>
        <span id="m_cat" class="cat-badge"></span>
      </div>
      <h2 id="m_title" style="margin:0 0 12px 0;"></h2>
      <p id="m_desc" style="white-space:pre-wrap;color:#334155;font-size:15px;"></p>
      <div style="margin-top:20px;padding-top:10px;border-top:1px solid #eee;">
        <small style="color:#94a3b8">ğŸ“ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† â€¢ <span id="m_date"></span></small>
      </div>
    </div>
    <div class="modal-footer">
      <a id="m_wa" href="#" target="_blank" class="btn green">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
      <button onclick="closeModal()" class="btn" style="background:#e2e8f0;color:#334155;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL (ADMIN) -->
<div id="editModal" class="modal">
    <div class="modal-card">
        <div style="padding:16px;background:#f8fafc;border-bottom:1px solid #e2e8f0;font-weight:bold;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</div>
        <div class="modal-content">
            <input type="hidden" id="e_id">
            <input type="hidden" id="e_sheet"> <!-- To know if Pending or Active -->
            
            <label style="font-size:12px;color:#64748b;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" id="e_title" style="margin-bottom:10px;">
            
            <label style="font-size:12px;color:#64748b;">Ø§Ù„Ø³Ø¹Ø±</label>
            <input type="text" id="e_price" style="margin-bottom:10px;">
            
            <label style="font-size:12px;color:#64748b;">Ø§Ù„Ù‚Ø³Ù…</label>
            <select id="e_cat" style="margin-bottom:10px;">
                <option value="Ø³ÙŠØ§Ø±Ø§Øª">Ø³ÙŠØ§Ø±Ø§Øª</option>
                <option value="Ø¹Ù‚Ø§Ø±Ø§Øª">Ø¹Ù‚Ø§Ø±Ø§Øª</option>
                <option value="Ù‡ÙˆØ§ØªÙ">Ù‡ÙˆØ§ØªÙ</option>
                <option value="Ø£Ø«Ø§Ø«">Ø£Ø«Ø§Ø«</option>
                <option value="Ø®Ø¯Ù…Ø§Øª">Ø®Ø¯Ù…Ø§Øª</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
            
            <label style="font-size:12px;color:#64748b;">Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="text" id="e_phone" style="margin-bottom:10px;">
            
            <label style="font-size:12px;color:#64748b;">Ø§Ù„ÙˆØµÙ</label>
            <textarea id="e_desc" rows="5"></textarea>
        </div>
        <div class="modal-footer">
            <button onclick="saveEdit()" class="btn green">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button onclick="document.getElementById('editModal').classList.remove('open')" class="btn red">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script>
// ================= CONFIGURATION =================
// ğŸ›‘ REPLACE THIS URL WITH YOUR NEW DEPLOYED GOOGLE SCRIPT URL ğŸ›‘
const API_URL = "REPLACE_WITH_YOUR_DEPLOYED_WEB_APP_URL"; 
// =================================================

let allAds = [];
let pendingAds = [];
let isAdmin = false;
let currentAdminTab = 'pending';

// --- NAVIGATION ---
function nav(id){
  document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  if(document.getElementById('btn-'+id)) document.getElementById('btn-'+id).classList.add('active');
  window.scrollTo(0,0);
}

// --- DATA FETCHING ---
async function loadAds(forceAdmin = false) {
  const loader = document.getElementById('loader');
  if(loader) loader.style.display = 'block';
  
  const type = forceAdmin ? 'admin_read' : 'read';
  const pass = document.getElementById('adminPass').value;
  
  try {
    let url = `${API_URL}?action=${type}`;
    if(forceAdmin) url += `&password=${encodeURIComponent(pass)}`;
    
    // Add a cache-buster to prevent browser caching for immediate updates
    url += `&_t=${Date.now()}`; 
    
    const res = await fetch(url);
    const data = await res.json();
    
    if(data.error) {
      // Replaced alert() with console.error and message box
      console.error(data.error);
      if(forceAdmin) showMsg('red', data.error);

      // If it's the public read and it fails, just show a message.
      if(!forceAdmin) loader.innerHTML = "ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.";
      return;
    }

    if(forceAdmin) {
      allAds = data.active.reverse();
      pendingAds = data.pending.reverse();
      renderAdminList(currentAdminTab);
      document.getElementById('adminLogin').classList.add('hidden');
      document.getElementById('adminDash').classList.remove('hidden');
      isAdmin = true;
      showMsg('success', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    } else {
      allAds = data.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by Date (latest first)
      renderGrid(allAds);
      loader.style.display = 'none';
    }
  } catch(e) {
    console.error(e);
    if(!forceAdmin) loader.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.";
  }
}

// --- RENDERING ---
function renderGrid(list) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  
  if(list.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    return;
  }

  list.forEach(item => {
    const el = document.createElement('div');
    el.className = 'card';
    const imgUrl = item.image || 'https://via.placeholder.com/300x200?text=No+Image';
    
    el.innerHTML = `
      <div class="media"><img src="${imgUrl}" loading="lazy" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=Image+Load+Failed';"></div>
      <div class="body">
        <div class="card-top">
           <div class="price">${Number(item.price).toLocaleString()} SDG</div>
           <div class="cat-badge">${item.category}</div>
        </div>
        <div class="title">${item.title}</div>
        <div class="loc">ğŸ“ ${new Date(item.date).toLocaleDateString('ar-EG')}</div>
      </div>
    `;
    el.onclick = () => openModal(item);
    grid.appendChild(el);
  });
}

function filterAds() {
  const q = document.getElementById('search').value.toLowerCase();
  const cat = document.getElementById('catFilter').value;
  
  const filtered = allAds.filter(a => {
    const matchText = (a.title + a.description).toLowerCase().includes(q);
    const matchCat = cat ? a.category === cat : true;
    return matchText && matchCat;
  });
  renderGrid(filtered);
}

// --- SUBMISSION LOGIC ---
async function submitAd(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  const fileInput = document.getElementById('f_img');
  
  if(!fileInput.files[0]) {
    showMsg('red', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© <div class="spinner"></div>';
  
  try {
    const base64Img = await compressImage(fileInput.files[0]);
    const payload = {
      title: document.getElementById('f_title').value,
      price: document.getElementById('f_price').value,
      category: document.getElementById('f_cat').value,
      description: document.getElementById('f_desc').value,
      phone: document.getElementById('f_phone').value,
      image: base64Img,
      action: 'submit'
    };

    const res = await fetch(https://script.google.com/macros/s/AKfycbxiAcvd4w2DDzhZWEoPdf4OUikRbhttly8F4bI_WaBimjzJwcxi4KCEIiODGpDFqVJNQg/exec, {
      method: 'POST',
      mode: 'no-cors', // Must use no-cors with Apps Script POST
      headers: {'Content-Type': 'text/plain'},
      body: JSON.stringify(payload)
    });
    
    // Apps Script POST returns opaque response in no-cors, cannot check status
    // We assume success and move on
    
    showMsg('success', 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!');
    document.getElementById('adForm').reset();
    nav('home');

  } catch(err) {
    showMsg('red', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†';
  }
}

// --- IMAGE COMPRESSION ---
function compressImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.6));
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
  });
}

// --- ADMIN LOGIC ---
let clickCount = 0;
function tryAdmin(){
  clickCount++;
  if(clickCount === 5) {
    nav('admin');
    clickCount = 0;
  }
}
// Check hash for admin login (optional but helpful)
if(window.location.hash === '#admin') nav('admin');

function loginAdmin() {
  loadAds(true);
}

function switchAdminTab(tab) {
  currentAdminTab = tab;
  document.querySelectorAll('.admin-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  // Find the button that was clicked or corresponds to the tab
  const btnText = tab === 'pending' ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø±' : 'Ø§Ù„Ù†Ø´Ø·Ø©';
  const btn = Array.from(document.querySelectorAll('.admin-tabs .tab-btn')).find(b => b.textContent.includes(btnText));
  if (btn) btn.classList.add('active');
  renderAdminList(tab);
}

function renderAdminList(type) {
  const list = type === 'pending' ? pendingAds : allAds;
  const container = document.getElementById('adminList');
  container.innerHTML = '';
  
  if(list.length === 0) {
    container.innerHTML = '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p>';
    return;
  }

  list.forEach(item => {
    const el = document.createElement('div');
    el.className = 'card';
    
    // Admin Action Buttons
    let buttons = '';
    
    // 1. Edit Button (Always available)
    buttons += `<button onclick="openEditModal('${item.id}', '${type}')" class="mini-btn orange">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>`;
    
    // 2. Pending Specific (Approve)
    if(type === 'pending') {
        buttons += `<button onclick="adminAct('${item.id}', 'approve', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')" class="mini-btn green">âœ… Ù†Ø´Ø±</button>`;
    } 
    // 3. Active Specific (Bump to Top)
    else {
        buttons += `<button onclick="adminAct('${item.id}', 'bump', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø£Ø¹Ù„Ù‰ØŸ')" class="mini-btn" style="background:#8b5cf6">â¬†ï¸ Ø±ÙØ¹</button>`;
    }
    
    // 4. Delete (Always available)
    buttons += `<button onclick="adminAct('${item.id}', 'delete', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')" class="mini-btn red">ğŸ—‘ Ø­Ø°Ù</button>`;

    // 5. Contact Link
    buttons += `<a href="https://wa.me/${item.phone}" target="_blank" class="mini-btn" style="background:#25D366">ğŸ“</a>`;

    el.innerHTML = `
      <div class="media"><img src="${item.image}" onerror="this.onerror=null; this.src='https://via.placeholder.com/80x80?text=No+Image';"></div>
      <div class="body">
        <div style="font-weight:bold">${item.title}</div>
        <div style="font-size:12px">${Number(item.price).toLocaleString()} SDG - ${item.category}</div>
        <div class="admin-actions">${buttons}</div>
      </div>
    `;
    container.appendChild(el);
  });
}

// Replaced confirm() with a custom message box for demonstration
function adminAct(id, action, message) {
    // This is a direct replacement for confirm(), usually handled by a custom modal UI.
    // For this environment, we use a simple alert as a placeholder for a custom UI modal.
    if (!window.confirm(message)) { 
        return;
    }
    sendAdminRequest({ action, id });
    loadAds(true); 
}

// --- EDIT FEATURE ---
function openEditModal(id, type) {
    const list = type === 'pending' ? pendingAds : allAds;
    const item = list.find(x => x.id === id);
    if(!item) return;

    document.getElementById('e_id').value = item.id;
    document.getElementById('e_sheet').value = type === 'pending' ? 'Pending' : 'Active';
    document.getElementById('e_title').value = item.title;
    document.getElementById('e_price').value = item.price;
    document.getElementById('e_cat').value = item.category;
    document.getElementById('e_phone').value = item.phone;
    document.getElementById('e_desc').value = item.description;

    document.getElementById('editModal').classList.add('open');
}

async function saveEdit() {
    const payload = {
        action: 'edit',
        id: document.getElementById('e_id').value,
        sheetName: document.getElementById('e_sheet').value,
        title: document.getElementById('e_title').value,
        price: document.getElementById('e_price').value,
        category: document.getElementById('e_cat').value,
        phone: document.getElementById('e_phone').value,
        description: document.getElementById('e_desc').value
    };
    
    document.getElementById('editModal').classList.remove('open');
    await sendAdminRequest(payload);
    
    // Reload the list after saving
    loadAds(true);
}

async function sendAdminRequest(data) {
  const pass = document.getElementById('adminPass').value;
  data.password = pass;
  
  showMsg('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...');
  
  try {
