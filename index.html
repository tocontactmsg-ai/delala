<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f7fbff;color:#0b1320;line-height:1.4}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .brand{display:flex;flex-direction:column}
  .brand .title{font-size:24px;font-weight:900;letter-spacing:0.5px}
  .brand .tagline{font-size:13px;opacity:0.95}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button[aria-current="true"]{background:#fff;color:#0078d7;border:0}

  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;align-items:center}
  .controls .search{flex:1;min-width:180px}
  input[type="text"], input[type="search"], select, textarea{padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;font-size:15px;background:#fff}
  .btn{background:#0078d7;color:#fff;padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn.alt{background:#6b7280}
  .small{font-size:13px;color:#333}

  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 26px rgba(11,19,32,0.06);display:flex;flex-direction:column;height:100%;transition:transform .12s,box-shadow .12s}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(11,19,32,0.09)}
  .media{height:220px;background:#f0f4f8;display:flex;align-items:center;justify-content:center;cursor:zoom-in;position:relative}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .media .noimg{padding:12px;color:#7b8794}
  .body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:700;font-size:17px;line-height:1.15}
  .desc{color:#334155;font-size:14px;max-height:3.2em;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;align-items:center;margin-top:auto;flex-wrap:wrap}
  .badge{background:#eef8ff;color:#0078d7;padding:6px 8px;border-radius:999px;font-weight:700;direction:ltr}
  .price{background:#fffbeb;color:#b45309;padding:6px 8px;border-radius:8px;font-weight:800;direction:ltr}
  .muted{color:#6b7280;font-size:13px}
  .actions{display:flex;gap:8px}
  .link-like{background:transparent;border:0;color:#0078d7;cursor:pointer;padding:6px}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:999}
  .modal.open{display:flex}
  .modalCard{background:#fff;border-radius:12px;max-width:920px;width:96%;max-height:92vh;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
  .modalTop{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .modalMedia{width:320px;max-width:42%;min-width:220px;background:#f4f6f9;border-radius:10px;overflow:hidden}
  .modalMedia img{width:100%;height:100%;object-fit:cover;display:block}
  .modalBody{flex:1;display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px}
  .fullDesc{white-space:pre-wrap;background:#fbfdff;padding:10px;border-radius:8px}
  .modalFooter{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .copyBtn{background:#eef6ff;border:1px solid #cfe9ff;padding:8px;border-radius:8px;color:#0078d7;cursor:pointer}

  @media (max-width:600px){ .modalTop{flex-direction:column} .modalMedia{width:100%;max-width:100%} }

  .loadMore{display:block;margin:14px auto;padding:10px 14px;border-radius:10px;border:1px solid #e6eef8;background:#fff;cursor:pointer}
  .skeleton{background:linear-gradient(90deg,#f2f6fb,#eef5ff,#f2f6fb);background-size:200% 100%;animation:shimmer 1.6s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .refBox{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .refCode{background:#f0f9ff;padding:6px 12px;border-radius:10px;color:#0078d7;font-weight:800;letter-spacing:0.8px}

  .adminBtn, .adminPanel { display: none !important; }
  body.admin-visible .adminBtn, body.admin-visible .adminPanel { display: block !important; }

  .adminBtn{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;z-index:1200}
  .adminPanel{position:fixed;right:18px;bottom:70px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.15);z-index:1200;width:320px;max-width:calc(100% - 40px);display:none}
  .adminPanel.open{display:block}
  .adminPanel input, .adminPanel select{width:100%;margin-bottom:8px}
  .adminRow{display:flex;gap:8px}
  .adminNote{font-size:12px;color:#666;margin-top:6px}

  .subCard{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef6ff;box-shadow:0 6px 20px rgba(6,20,40,0.02);margin-top:12px}

  /* small responsive tweaks */
  @media (max-width:420px){
    header{padding:10px}
    .brand .title{font-size:20px}
    .media{height:180px}
  }
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div class="brand">
      <div class="title">Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</div>
    
    </div>

    <nav aria-label="ÙˆØ§Ø¬Ù‡Ø©">
      <button data-target="home" class="nav-btn" aria-current="true">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button data-target="send" class="nav-btn">Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</button>
     
    </nav>
  </header>

  <div class="controls" role="search" aria-label="Ø¨Ø­Ø« ÙˆØªØ­ÙƒÙ…">
    <div class="search" style="min-width:180px">
      <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
    </div>
    <div style="width:200px">
      <select id="catFilter"><option value="">ÙƒÙ„ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…</option></select>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refresh" class="btn alt">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
      <div id="count" class="small" aria-live="polite">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <main>
    <section id="home" aria-live="polite">
      <div id="grid" class="grid" role="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
      <button id="loadMore" class="loadMore" style="display:none">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h3>Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</h3>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
          <input id="f_price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 12000 Ø±ÙŠØ§Ù„)" type="text">
          <textarea id="f_desc" placeholder="ÙˆØµÙ" rows="4"></textarea>
          <input id="f_loc" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <input id="f_contact" placeholder="ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø±Ù‚Ù…/ÙˆØ§ØªØ³Ø§Ø¨/Ø¥ÙŠÙ…ÙŠÙ„)">
          <input id="f_cat" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø§Øª, Ø¹Ù‚Ø§Ø±...)">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="f_file" type="file" accept="image/*">
          </div>

          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="agree" />
            <span class="small">Ø£Ù‚Ø± Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© ÙˆØ£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ù†Ø´Ø±</span>
          </label>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„ </button>
            <div id="submitStatus" class="small"></div>
          </div>

          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</div>
            <div class="refBox" style="margin-top:6px">
              <div id="refCode" class="refCode"></div>
              <button id="copyRef" class="copyBtn">Ù†Ø³Ø®</button>
              <a id="openWa" class="small" target="_blank" style="margin-left:8px;color:#0078d7"></a>
              <button id="downloadEmbedded" class="btn alt" style="margin-left:8px;display:none">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (PNG)</button>
            </div>
          </div>

          <div id="fallbackJson" style="display:none;margin-top:8px">
            <div class="small">Ù„Ù†Ø´Ø± Ø§Ø¹Ù„Ø§Ù†Ùƒ Ø§Ø±Ø³Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</div>
            <textarea id="fallbackArea" rows="6" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eef6ff;background:#fff;margin-top:8px"></textarea>
          </div>

          <div id="previewCard" class="subCard" style="display:none">
            <div id="previewCanvasWrap"></div>
            <div class="small muted" style="margin-top:8px">Ù‚Ù… Ø¨Ø§Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ø°Ø§ Ø§Ø±Ø¯Øª Ù†Ø´Ø± Ø§Ù„Ø§Ø¹Ù„Ø§Ù†</div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard" role="document" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div id="modalTitle" style="font-weight:800;font-size:18px"></div>
        <div id="modalMeta" class="small muted" style="margin-top:6px"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="refBox">
          <div id="modalRef" class="refCode"></div>
          <button id="modalCopy" class="copyBtn">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</button>
        </div>
        <button id="modalClose" class="btn alt">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="modalTop">
      <div class="modalMedia" id="modalMedia"><div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div></div>

      <div class="modalBody">
        <div id="modalDescription" class="fullDesc"></div>
        <div class="row">
          <div class="field"><div class="small">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div id="modalLoc" class="muted"></div></div>
          <div class="field"><div class="small">Ø§Ù„ØªØµÙ†ÙŠÙ</div><div id="modalCat" class="badge"></div></div>
          <div class="field"><div class="small">Ø§Ù„Ø³Ø¹Ø±</div><div id="modalPrice" class="price"></div></div>
        </div>
        <div class="row">
          <div class="field"><div class="small">Ø§Ù„ØªÙˆØ§ØµÙ„</div><div id="modalContact" class="muted"></div></div>
          <div class="field"><div class="small">Ù…Ø±Ø³Ù„ Ø¨ØªØ§Ø±ÙŠØ®</div><div id="modalCreated" class="muted"></div></div>
        </div>

        <div id="adminEditHint" style="display:none;margin-top:8px" class="small muted"></div>
      </div>
    </div>

    <div class="modalFooter">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <a id="modalWhats" class="btn" target="_blank">Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± WhatsApp</a>
        <button id="modalCopyContact" class="btn alt" style="display:none">Ù†Ø³Ø® Ø§Ù„ØªÙˆØ§ØµÙ„</button>
        <button id="modalEdit" class="btn" style="display:none">ØªØ­Ø±ÙŠØ± (Ù…Ø³Ø¤ÙˆÙ„)</button>
        <button id="modalFallback" class="btn alt" style="display:none">Ø¹Ø±Ø¶ JSON Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·</button>
      </div>
      <div class="small muted">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ§ÙƒØ¯ Ø¨Ù†ÙØ³Ùƒ Ù…Ù† ÙƒÙ„ Ù…Ø§ÙŠØªÙ… Ø§Ù„Ø§Ø¹Ù„Ø§Ù† Ø¹Ù†Ù‡ .</div>
    </div>
  </div>
</div>

<button id="adminBtn" class="adminBtn">ğŸ”§ Admin</button>
<div id="adminPanel" class="adminPanel" aria-hidden="true"></div>

<script>
/* ---------------------- Utilities ---------------------- */
const CFG_KEY = 'static_ads_cfg_v1';
const CACHE_KEY = 'static_ads_cache_v1';
const WA_NUMBER = '249964147954';
const PAGE_SIZE = 12;
const MARKER = 'ELDELALA_PAYLOAD:';

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]||c)); }
function debounce(fn,t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }
function readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }
function saveCfg(cfg){ const c=Object.assign({},cfg); delete c.session_pat; delete c.pat; localStorage.setItem(CFG_KEY, JSON.stringify(c)); }
function setSessionPat(v){ if(v){ sessionStorage.setItem('static_session_pat', v); } else { sessionStorage.removeItem('static_session_pat'); } updateAdminUi(); }
function getSessionPat(){ return sessionStorage.getItem('static_session_pat') || null; }
function clearSessionPat(){ setSessionPat(null); }

/* ------------------ ghPut (unchanged) ------------------ */
async function ghPut(pat, repo, path, base64content, message, branch='main', maxRetries=4){ 
  if(!pat) throw new Error('PAT required for write');
  const [owner, repoName] = (repo||'').split('/');
  if(!owner || !repoName) throw new Error('invalid repo');
  const apiBase = `https://api.github.com/repos/${owner}/${repoName}/contents/${encodeURIComponent(path)}`;
  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };
  for(let attempt=1; attempt<=maxRetries; attempt++){
    let sha = undefined;
    try{
      const metaResp = await fetch(apiBase + `?ref=${encodeURIComponent(branch)}`, { headers });
      if(metaResp.status === 200){ const metaJson = await metaResp.json(); sha = metaJson.sha; }
      else if(metaResp.status === 404) sha = undefined;
      else if(metaResp.status === 401 || metaResp.status === 403) throw new Error('PAT invalid or missing permission');
    }catch(e){ if(attempt === maxRetries) throw e; }
    const body = { message, content: base64content, branch };
    if(sha) body.sha = sha;
    const putResp = await fetch(apiBase, { method: 'PUT', headers, body: JSON.stringify(body) });
    const text = await putResp.text();
    let parsed = null; try{ parsed = JSON.parse(text); }catch(e){ parsed = null; }
    if(putResp.ok) return parsed;
    const errMsg = (parsed && parsed.message) ? parsed.message.toLowerCase() : (text||'').toLowerCase();
    if((putResp.status===409 || putResp.status===422 || errMsg.includes('does not match') || errMsg.includes('sha')) && attempt < maxRetries){
      await new Promise(r=>setTimeout(r, 250 * attempt));
      continue;
    }
    if(putResp.status===401 || putResp.status===403) throw new Error('PUT failed: PAT invalid or missing permission: ' + (parsed && parsed.message ? parsed.message : putResp.status));
    throw new Error('PUT failed: ' + (parsed && parsed.message ? parsed.message : text));
  }
}

/* ------------------ Image optimize (unchanged helper) ------------------ */
async function optimizeImageFile(file, conf){
  const { maxWidth, maxHeight, quality, outputType } = conf;
  const dataUrl = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxWidth/w, maxHeight/h);
  const tw = Math.round(w * scale), th = Math.round(h * scale);
  const canvas = document.createElement('canvas'); canvas.width = tw; canvas.height = th;
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img,0,0,tw,th);
  await new Promise(r=>setTimeout(r,8));
  const blob = await new Promise(res=>canvas.toBlob(res, outputType, quality));
  const base64 = await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.readAsDataURL(blob); });
  return { blob, base64, size: blob.size };
}

/* ------------------ Visual builder (QR D-style, PNG output) ------------------ */
async function buildVisualAndDataURL(file, data, opts = { compact: true }) {
  // D-style: large QR occupying ~50% of the right panel. Output as PNG (safe for WhatsApp as document)
  const compact = !!opts.compact;
  const W = compact ? 1400 : 2000;
  const H = compact ? 900 : 1333;
  const cv = document.createElement('canvas'); cv.width = W; cv.height = H;
  const ctx = cv.getContext('2d');

  // layout measurements
  const pad = Math.round(W * 0.04);
  const gap = Math.round(W * 0.02);
  const photoW = Math.round(W * 0.60);
  const rightX = pad + photoW + gap;
  const rightW = W - rightX - pad;
  const photoH = H - pad * 2;
  const radius = 18;

  // white background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, W, H);

  // photo area card
  ctx.fillStyle = '#f7fafc';
  roundRect(ctx, pad, pad, photoW, photoH, radius);
  ctx.fill();

  // load original image file into an Image
  const dataUrl = await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); });
  const img = await new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = dataUrl; });

  // draw image cover inside the photo card (center-crop)
  const imgScale = Math.max(photoW / img.width, photoH / img.height);
  const dw = Math.round(img.width * imgScale);
  const dh = Math.round(img.height * imgScale);
  const dx = pad + Math.round((photoW - dw) / 2);
  const dy = pad + Math.round((photoH - dh) / 2);
  clipRoundRect(ctx, pad, pad, photoW, photoH, radius);
  ctx.drawImage(img, dx, dy, dw, dh);
  ctx.restore();

  // right panel background and thin divider
  ctx.fillStyle = '#ffffff';
  roundRect(ctx, rightX, pad, rightW, photoH, 12);
  ctx.fill();
  ctx.fillStyle = '#eef6ff';
  ctx.fillRect(rightX, pad + 10, 6, photoH - 20);

  // right panel content start
  const innerRightX = rightX + rightW - 22;
  let cursorY = pad + 60;

  // reference
  ctx.fillStyle = '#0b84ff';
  ctx.font = (compact ? 'bold 36px Tajawal, system-ui' : 'bold 52px Tajawal, system-ui');
  ctx.textAlign = 'right';
  ctx.fillText(data.ref_code || ('R' + Date.now().toString(36).slice(-6).toUpperCase()), innerRightX, cursorY);

  // decorative underline
  cursorY += 14;
  ctx.strokeStyle = '#e6f4ff'; ctx.lineWidth = 6;
  ctx.beginPath(); ctx.moveTo(innerRightX - 260, cursorY); ctx.lineTo(innerRightX, cursorY); ctx.stroke();

  // title
  cursorY += (compact ? 44 : 58);
  ctx.fillStyle = '#0b1220';
  ctx.font = (compact ? '700 26px Tajawal, system-ui' : '700 34px Tajawal, system-ui');
  wrapTextRTL(ctx, data.name || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)', innerRightX, cursorY, rightW - 44, (compact ? 30 : 38));
  cursorY += (compact ? 70 : 92);

  // small friendly phrase
  ctx.fillStyle = '#0b84ff';
  ctx.font = (compact ? '650 22px Tajawal, system-ui' : '900 26px Tajawal, system-ui');
  ctx.fillText('Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù„Ø§Ù„Ø©', innerRightX, cursorY);
  cursorY += (compact ? 36 : 46);

  // D-style QR: large card occupying about 50% of right panel height
  // compute QR size to visually dominate but leave margins
  const qrSize = Math.min(rightW - 60, Math.round(photoH * 0.5));
  const qrX = rightX + Math.round((rightW - qrSize) / 2);
  const qrY = cursorY;

  // background card for QR (rounded, with subtle shadow look)
  const qrPad = 12;
  const qrCardX = qrX - qrPad;
  const qrCardY = qrY - qrPad;
  const qrCardW = qrSize + qrPad * 2;
  const qrCardH = qrSize + qrPad * 2 + 42; // leave space for caption

  // card gradient
  const g = ctx.createLinearGradient(qrCardX, qrCardY, qrCardX + qrCardW, qrCardY + qrCardH);
  g.addColorStop(0, '#ffffff');
  g.addColorStop(1, '#f6fbff');
  ctx.fillStyle = g;
  roundRect(ctx, qrCardX, qrCardY, qrCardW, qrCardH, 16);
  ctx.fill();

  // slight border
  ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(11,132,255,0.08)';
  roundRect(ctx, qrCardX, qrCardY, qrCardW, qrCardH, 16); ctx.stroke();

  // prepare QR payload text (Arabic short message)
  const qrText = `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø±Ù…Ø²: ${data.ref_code || ''} \\n${data.name || ''} \\nØªÙˆØ§ØµÙ„: ${data.contact || ''}`;

  // use api.qrserver to create QR PNG; colored dark accent to match brand
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(qrText)}&color=0B84FF&bgcolor=ffffff`; 

  // draw QR image (load crossOrigin to avoid tainting when possible)
  await new Promise((res, rej) => {
    const qimg = new Image();
    qimg.crossOrigin = 'anonymous';
    qimg.onload = () => {
      // center QR into card
      ctx.drawImage(qimg, qrX, qrY, qrSize, qrSize);

      // add decorative accent: large translucent rounded frame
      ctx.lineWidth = Math.max(6, Math.round(qrSize * 0.03));
      ctx.strokeStyle = 'rgba(11,132,255,0.14)';
      roundRect(ctx, qrX - 8, qrY - 8, qrSize + 16, qrSize + 16, 18); ctx.stroke();

      // overlay a light brand gradient square behind center area to create 'cover' feeling
      const centerGrad = ctx.createLinearGradient(qrX, qrY, qrX + qrSize, qrY + qrSize);
      centerGrad.addColorStop(0, 'rgba(11,132,255,0.06)');
      centerGrad.addColorStop(1, 'rgba(11,132,255,0.00)');
      ctx.fillStyle = centerGrad;
      roundRect(ctx, qrX, qrY, qrSize, qrSize, 10); ctx.fill();

      // caption centered below QR
      ctx.textAlign = 'center';
      ctx.fillStyle = '#334155';
      ctx.font = (compact ? '600 14px Tajawal, system-ui' : '600 16px Tajawal, system-ui');
    
      res();
    };
    qimg.onerror = (e) => { console.warn('QR load failed', e); res(); };
    qimg.src = qrUrl;
  });

  // final footer note RTL
  ctx.fillStyle = '#94a3b8';
  ctx.font = (compact ? '500 10px Tajawal, system-ui' : '400 14px Tajawal, system-ui');
  ctx.textAlign = 'right';
  ctx.fillText(' ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ø§ÙŠ Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ùˆ Ø´ÙƒÙˆÙŠ', innerRightX, pad + photoH - 18);

  // produce PNG blob (safe to send as WhatsApp document preserving trailing bytes)
  const blob = await new Promise(res => cv.toBlob(res, 'image/png'));
  const dataURLFinal = await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob); });
  return { blob, dataURL: dataURLFinal, canvas: cv };

  // helpers
  function wrapTextRTL(ctx, text, x, y, maxWidth, lineHeight) {
    const words = String(text || '').split(' ');
    let line = '';
    let curY = y;
    for (let i = 0; i < words.length; i++) {
      const testLine = (line ? (words[i] + ' ' + line) : words[i]);
      const metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && line) {
        ctx.fillText(line, x, curY);
        line = words[i];
        curY += lineHeight;
      } else {
        line = testLine;
      }
    }
    if (line) ctx.fillText(line, x, curY);
    return curY;
  }
  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }
  function clipRoundRect(ctx, x, y, w, h, r) {
    ctx.save();
    roundRect(ctx, x, y, w, h, r);
    ctx.clip();
  }
}

/* ----------------- embed helpers ----------------- */
function jsonToBase64String(obj){
  const json = JSON.stringify(obj);
  const utf8 = unescape(encodeURIComponent(json));
  return btoa(utf8);
}
async function blobToUint8(blob){
  const ab = await blob.arrayBuffer();
  return new Uint8Array(ab);
}
async function embedJsonInImageBlob(imageBlob, payloadObj){
  const origBytes = await blobToUint8(imageBlob);
  const markerBytes = new TextEncoder().encode(MARKER);
  const b64 = jsonToBase64String(payloadObj);
  const b64Bytes = new TextEncoder().encode(b64);
  const out = new Uint8Array(origBytes.length + markerBytes.length + b64Bytes.length);
  out.set(origBytes,0);
  out.set(markerBytes, origBytes.length);
  out.set(b64Bytes, origBytes.length + markerBytes.length);
  return new Blob([out], { type: imageBlob.type || 'image/png' });
}

/* ------------------ Public UI + submission flow ------------------ */
let ads = [];
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const countEl = document.getElementById('count');
const loadMoreBtn = document.getElementById('loadMore');

let showing = 0;

function showSkeleton(){ grid.innerHTML=''; for(let i=0;i<6;i++){ const sk=document.createElement('div'); sk.className='card'; sk.innerHTML = `<div class="media skeleton"></div><div class="body"><div class="skeleton" style="height:18px;width:60%;border-radius:6px"></div><div style="height:12px"></div><div class="skeleton" style="height:12px;width:100%;border-radius:6px"></div></div>`; grid.appendChild(sk);} }

async function loadAds(){
  try{
    showSkeleton();
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if(cached && (Date.now() - cached.t < 30_000) && cached.data){ ads = cached.data; renderGrid(ads); buildCategories(); countEl.textContent = `${ads.length} Ø¥Ø¹Ù„Ø§Ù†`; return; }
    const paths = ['./static/ads.json','./ads.json','/static/ads.json'];
    let items = null;
    for(const p of paths){ try{ const res = await fetch(p, { cache:'no-cache' }); if(!res.ok) continue; items = await res.json(); break; }catch(e){ continue; } }
    if(!items){ grid.innerHTML = '<div style="padding:16px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>'; countEl.textContent='0 Ø¥Ø¹Ù„Ø§Ù†'; return; }
    ads = Array.isArray(items) ? items : [];
    ads.sort((a,b)=> (new Date(b.created_at||0)) - (new Date(a.created_at||0)));
    localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), data: ads }));
    renderGrid(ads); buildCategories(); countEl.textContent = `${ads.length} Ø¥Ø¹Ù„Ø§Ù†`;
  }catch(e){ console.error(e); grid.innerHTML = '<div style="padding:16px">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>'; }
}

function renderGrid(list){
  grid.innerHTML = '';
  showing = Math.min(PAGE_SIZE, list.length);
  if(!list.length){ document.getElementById('noitems').style.display='block'; loadMoreBtn.style.display='none'; countEl.textContent='0 Ø¥Ø¹Ù„Ø§Ù†'; return; }
  document.getElementById('noitems').style.display='none';
  appendCards(list.slice(0, showing));
  loadMoreBtn.style.display = list.length > showing ? 'block' : 'none';
}

function appendCards(chunk){
  const frag = document.createDocumentFragment();
  chunk.forEach(a=>{
    const el = document.createElement('div'); el.className='card'; el.setAttribute('role','listitem');
    const thumb = (a.thumb || a.image || '').replace(/^\//,'');
    const mediaHtml = thumb ? `<img src="${escapeHtml(thumb)}" loading="lazy" alt="${escapeHtml(a.name||'')}" />` : `<div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div>`;
    const cat = a.category || 'Ø¹Ø§Ù…';
    const ref = escapeHtml(a.ref_code||a.code||'');
    const contactDisplay = escapeHtml(a.contact || '-');
    const priceDisplay = a.price ? `<div class="price">${escapeHtml(a.price)}</div>` : '';
    el.innerHTML = `<div class="media">${mediaHtml}</div>
      <div class="body"><div class="title">${escapeHtml(a.name||'')}</div>
      <div class="desc">${escapeHtml(a.description||'')}</div>
      <div class="meta"><div class="badge">${escapeHtml(cat)}</div><div class="muted">ğŸ“ ${escapeHtml(a.location||'')}</div><div style="margin-left:auto" class="muted">${ref}</div></div>
      <div class="meta" style="margin-top:8px;justify-content:space-between;align-items:center;">
        <div class="small">Ø§Ù„ØªÙˆØ§ØµÙ„: <span class="muted contact-text">${contactDisplay}</span></div>
        <div style="display:flex;gap:6px;align-items:center;">
          ${priceDisplay}
          <button class="link-like copy-contact" type="button" title="Ù†Ø³Ø® Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„">Ù†Ø³Ø®</button>
        </div>
      </div></div>`;
    frag.appendChild(el);

    const img = el.querySelector('img'); if(img) img.addEventListener('error', ()=> img.style.display='none');
    el.addEventListener('click', (e)=>{
      if(e.target && e.target.classList && e.target.classList.contains('copy-contact')) return;
      openDetails(a);
    });

    const copyBtn = el.querySelector('.copy-contact');
    if(copyBtn){
      copyBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const contact = (a.contact || '').trim();
        if(!contact){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù„Ù„Ù†Ø³Ø®'); return; }
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(contact).then(()=>{ alert('Ù†Ø³Ø®: ' + contact); }).catch(()=>{ fallbackCopyPrompt(contact); });
        } else fallbackCopyPrompt(contact);
      });
    }
  });
  grid.appendChild(frag);
}

function fallbackCopyPrompt(text){ window.prompt('Ø§Ù†Ø³Ø® Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ctrl+C):', text); }

loadMoreBtn.addEventListener('click', ()=>{ const remaining = ads.slice(showing, showing + PAGE_SIZE); appendCards(remaining); showing += remaining.length; loadMoreBtn.style.display = showing < ads.length ? 'block' : 'none'; });
function buildCategories(){ const s=new Set(); ads.forEach(a=> a.category && s.add(a.category)); catFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>'; Array.from(s).sort().forEach(c=>{ const o=document.createElement('option'); o.value=c; o.innerText=c; catFilter.appendChild(o); }); }

document.getElementById('refresh').addEventListener('click', ()=>{ localStorage.removeItem(CACHE_KEY); loadAds(); });
document.getElementById('q').addEventListener('input', debounce(()=> filterList(), 250));
catFilter.addEventListener('change', ()=> filterList());

/* ---------------- Details modal & edit ------------------ */
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalMeta=document.getElementById('modalMeta');
const modalMedia=document.getElementById('modalMedia');
const modalDescription=document.getElementById('modalDescription');
const modalLoc=document.getElementById('modalLoc');
const modalCat=document.getElementById('modalCat');
const modalContact=document.getElementById('modalContact');
const modalCreated=document.getElementById('modalCreated');
const modalRef=document.getElementById('modalRef');
const modalCopy=document.getElementById('modalCopy');
const modalWhats=document.getElementById('modalWhats');
const modalEdit=document.getElementById('modalEdit');
const modalFallback=document.getElementById('modalFallback');
const modalCopyContact=document.getElementById('modalCopyContact');
const adminEditHint=document.getElementById('adminEditHint');
const modalPrice=document.getElementById('modalPrice');

let currentItem=null;

function openDetails(item){
  currentItem=item;
  modalTitle.textContent=item.name||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  modalMeta.textContent=`Ø±Ù…Ø²: ${item.ref_code||item.code||''}`;
  modalRef.textContent=item.ref_code||item.code||'';
  modalDescription.textContent=item.description||'-';
  modalLoc.textContent=item.location||'-';
  modalCat.textContent=item.category||'Ø¹Ø§Ù…';
  modalContact.textContent=item.contact||'-';
  modalCreated.textContent=item.created_at? new Date(item.created_at).toLocaleString(): '-';
  modalPrice.textContent = item.price || '-';
  modalMedia.innerHTML='';
  const imgPath=item.image||item.thumb||'';
  if(imgPath){
    const img=document.createElement('img'); img.src=imgPath.replace(/^\//,''); img.alt=item.name||'';
    img.addEventListener('error', ()=> modalMedia.innerHTML='<div class=\"noimg small\">Ù„Ø§ ØµÙˆØ±Ø©</div>');
    img.addEventListener('click', ()=> window.open(img.src,'_blank'));
    modalMedia.appendChild(img);
  } else modalMedia.innerHTML='<div class=\"noimg small\">Ù„Ø§ ØµÙˆØ±Ø©</div>';
  modalWhats.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø±Ø¨Ù…Ø§ ÙŠÙ‡Ù…Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø§Ù„Ø±Ù…Ø² ${modalRef.textContent}`)}`;
  modalCopy.onclick = ()=> navigator.clipboard?.writeText(modalRef.textContent).then(()=> alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=> fallbackCopyPrompt(modalRef.textContent));
  modalCopyContact.style.display = 'inline-block';
  modalCopyContact.onclick = ()=> {
    const contact = (item.contact||'').trim();
    if(!contact) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù„Ù„Ù†Ø³Ø®');
    if(navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(contact).then(()=> alert('Ù†Ø³Ø®: ' + contact)).catch(()=> fallbackCopyPrompt(contact));
    else fallbackCopyPrompt(contact);
  };

  if(adminAvailable()){
    modalEdit.style.display='inline-block';
    modalEdit.onclick = ()=> openEditModal(item);
    modalFallback.style.display='inline-block';
    modalFallback.onclick = ()=> alert(JSON.stringify(item,null,2));
    adminEditHint.style.display='none';
  } else {
    modalEdit.style.display='none';
    modalFallback.style.display='none';
    adminEditHint.style.display='block';
    adminEditHint.textContent = 'Ø§Ù†Øª Ø§ÙŠØ¶Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø¹Ù„Ø§Ù† Ø¹Ù„ÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù„Ø§Ù„Ø©';
  }

  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
document.getElementById('modalClose').addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); currentItem=null; }

/* ---------------- Submission flow (updated) ------------------ */
const submitBtn = document.getElementById('submitBtn');
const submitStatus = document.getElementById('submitStatus');
const afterSubmit = document.getElementById('afterSubmit');
const refCodeEl = document.getElementById('refCode');
const fallbackArea = document.getElementById('fallbackArea');
const fallbackBox = document.getElementById('fallbackJson');
const openWa = document.getElementById('openWa');
const downloadEmbeddedBtn = document.getElementById('downloadEmbedded');
const previewCard = document.getElementById('previewCard');
const previewCanvasWrap = document.getElementById('previewCanvasWrap');

let lastEmbeddedBlobUrl = null;
let lastEmbeddedBlob = null;
let lastRef = null;

async function downscalePngBlob(blob, maxW=1100, maxH=700){
  const dataUrl = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxW / w, maxH / h);
  const cw = Math.max(200, Math.round(w * scale));
  const ch = Math.max(200, Math.round(h * scale));
  const c = document.createElement('canvas'); c.width = cw; c.height = ch;
  const ctx = c.getContext('2d'); ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, 0, 0, cw, ch);
  return await new Promise(res=>c.toBlob(res, 'image/png'));
}

submitBtn.addEventListener('click', async ()=>{
  if(submitBtn.disabled) return;
  const name = document.getElementById('f_name').value.trim();
  const price = document.getElementById('f_price').value.trim();
  const desc = document.getElementById('f_desc').value.trim();
  const contact = document.getElementById('f_contact').value.trim();
  const agree = document.getElementById('agree').checked;
  if(!agree){ alert('ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); return; }
  if(!name && !desc){ alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ø£Ùˆ ÙˆØµÙÙ‹Ø§ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†'); return; }
  if(!contact){ if(!confirm('Ù„Ù… ØªØ¯Ø®Ù„ ÙˆØ³ÙŠÙ„Ø© ØªÙˆØ§ØµÙ„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆØ§ØµÙ„ØŸ')) return; }
  submitBtn.disabled = true; submitStatus.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯...';

  const ref = genRef();
  lastRef = ref;
  const payload = {
    ref_code: ref,
    name: name,
    price: price,
    description: desc,
    location: document.getElementById('f_loc').value.trim(),
    contact: contact,
    category: document.getElementById('f_cat').value.trim(),
    created_at: new Date().toISOString()
  };

  refCodeEl.textContent = payload.ref_code; afterSubmit.style.display='block';

  const file = document.getElementById('f_file').files[0];

  try{
    if(!file){
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¶Ù…ÙŠÙ†');
      submitBtn.disabled = false; submitStatus.textContent='Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      return;
    }
    const { blob: visualBlob, dataURL, canvas } = await buildVisualAndDataURL(file, payload, { compact:true });

    previewCanvasWrap.innerHTML = '';
    const imgEl = document.createElement('img'); imgEl.style.width='100%'; imgEl.style.display='block';
    imgEl.src = dataURL;
    previewCanvasWrap.appendChild(imgEl);
    previewCard.style.display='block';

    try{
      const opt = await optimizeImageFile(file, { maxWidth:1600, maxHeight:1200, quality:0.78, outputType:'image/webp' });
      payload.image = `data:image/webp;base64,${opt.base64}`;
      payload.thumb = payload.image;
    }catch(e){
      const fr = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
      payload.image = fr;
      payload.thumb = fr;
    }

    const smallPng = await downscalePngBlob(visualBlob, 1100, 700);
    const embedded = await embedJsonInImageBlob(smallPng, payload);
    lastEmbeddedBlob = embedded;
    if(lastEmbeddedBlobUrl) { URL.revokeObjectURL(lastEmbeddedBlobUrl); lastEmbeddedBlobUrl = null; }
    lastEmbeddedBlobUrl = URL.createObjectURL(embedded);
    downloadEmbeddedBtn.style.display = 'inline-block';
  // store the final PNG blob
lastEmbeddedBlob = embedded;

// enable button
downloadEmbeddedBtn.style.display = 'inline-block';

// always regenerate the onclick AFTER blob exists
downloadEmbeddedBtn.onclick = function () {
    if (!lastEmbeddedBlob) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„");
        return;
    }

    const url = URL.createObjectURL(lastEmbeddedBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = payload.ref_code + "_eldelala.png";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
    }, 1500);
};


   const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ø±ÙŠØ¯ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ù…Ø²: ${payload.ref_code}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${payload.name || '-'}\nØ§Ù„Ø³Ø¹Ø±: ${payload.price || '-'}\nÙˆØ³Ø§Ù‚ÙˆÙ… Ø¨ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶Ù…Ù‘Ù† (${payload.ref_code}_eldelala.png) ÙƒÙ€ 'Ù…Ø³ØªÙ†Ø¯' Ù„ØªØ£ÙƒÙŠØ¯ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.`;
    const waUrl = `https://wa.me/${+24998615193}?text=${encodeURIComponent(msg)}`;
    openWa.href = waUrl; openWa.textContent = 'ÙØªØ­ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ù„Ù ÙƒÙ…Ø³ØªÙ†Ø¯)';
    window.open(waUrl, '_blank');

    fallbackBox.style.display = 'none';

    const cfg = readCfg() || {};
    const sessionPat = getSessionPat();
    if((cfg.pat || sessionPat) && cfg.repo && cfg.allow_public_submissions){
      submitStatus.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹...';
      const writeCfg = Object.assign({}, cfg);
      if(!writeCfg.pat) writeCfg.pat = sessionPat;
      try{
        if(payload.image && payload.image.indexOf('data:image/webp;base64,')===0){
          const b64 = payload.image.split(',')[1];
          const safe = (file.name||'image').replace(/[^a-z0-9.\-_]/ig,'_').slice(0,120);
          const fullName = `${payload.ref_code}-${safe}.webp`;
          await ghPut(writeCfg.pat, writeCfg.repo, `static/proposals_images/${fullName}`, b64, `proposal image ${fullName}`, writeCfg.branch || 'main');
          payload.image = `static/proposals_images/${fullName}`;
        }
        const payloadBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        await ghPut(writeCfg.pat, writeCfg.repo, `static/proposals/${payload.ref_code}.json`, payloadBase64, `proposal ${payload.ref_code}`, writeCfg.branch || 'main');
        submitStatus.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹';
        localStorage.removeItem(CACHE_KEY);
        await loadAds();
      }catch(e){
        console.warn('repo upload failed', e);
        submitStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ';
        fallbackBox.style.display='block';
        fallbackArea.value = JSON.stringify(payload,null,2);
      }
    } else {
      submitStatus.textContent = 'Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ â€” Ø£Ù†Ø²Ù„ Ø§Ù„Ù…Ù„Ù ÙˆØ£Ø±Ø³Ù„Ù‡ Ø¹Ø¨Ø± WhatsApp ÙƒÙ…Ø³ØªÙ†Ø¯';
      fallbackBox.style.display='block';
      fallbackArea.value = JSON.stringify(payload,null,2);
    }
  }catch(err){
    console.error(err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ' + (err.message || err));
    submitStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯';
    fallbackBox.style.display='block';
    fallbackArea.value = JSON.stringify(payload,null,2);
  } finally {
    submitBtn.disabled = false;
  }
});

/* ---------------- Admin panel logic (simple open admin.html) ---------------- */
// safe admin opener â€” won't throw if element is missing
const openAdminEl = document.getElementById('openAdmin') || document.getElementById('adminBtn');
if (openAdminEl) {
  openAdminEl.addEventListener('click', () => { window.open('admin.html','_blank'); });
}


function adminAvailable(){ const cfg = readCfg(); return !!((cfg.repo && cfg.branch) && (cfg.pat || getSessionPat())); }

/* ---------------- init ---------------- */
(function init(){ // navigation basic
  const navBtns = document.querySelectorAll('.nav-btn');
  const sections = { home: document.getElementById('home'), send: document.getElementById('send') };
  navBtns.forEach(b=>b.addEventListener('click', ()=>{ for(const k in sections) sections[k].style.display='none'; sections[b.dataset.target].style.display='block'; navBtns.forEach(n=>n.removeAttribute('aria-current')); b.setAttribute('aria-current','true'); window.scrollTo({top:0,behavior:'smooth'}); }));
  loadAds();
})();
</script>
</body>
</html>
