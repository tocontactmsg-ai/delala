<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</title>
    <style>
        /* ======================================================== */
        /* CSS: Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨ØªØµÙ…ÙŠÙ…Ùƒ Ø§Ù„Ø®Ø§Øµ) */
        /* ======================================================== */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            text-align: right;
            direction: rtl;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }

        header {
            background-color: #333;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filters input, .filters select, .filters button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            flex-grow: 1;
        }

        .filters button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filters button:hover {
            background-color: #0056b3;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        #cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† */
        .ad-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .ad-card:hover {
            transform: translateY(-5px);
        }

        .ad-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .ad-details {
            padding: 15px;
        }

        .ad-details h3 {
            margin-top: 0;
            color: #333;
        }

        .ad-details p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
        }

        .ad-details .price {
            font-weight: bold;
            color: #28a745;
            font-size: 1.2em;
            margin-top: 10px;
        }
        
        .loading-message, .error-message, .no-results {
            grid-column: 1 / -1; /* ØªØ¬Ø¹Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ£Ø®Ø° Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: #6c757d;
        }

        .error-message {
             color: #dc3545;
             font-weight: bold;
        }
        
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Ø³ÙˆÙ‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</h1>
            <p>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheet</p>
        </header>

        <div class="filters">
            <input type="text" id="qEl" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹..." />
            <select id="catFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
                </select>
            <button id="refresh">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div id="cards-container">
            <div class="loading-message">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ...</div>
        </div>
    </div>

    <script>
        // ğŸ’¡ Ù…Ù‡Ù…: Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· Apps Script Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…ØªÙ‡
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx2bZn1CetxnvURF4R1P216TsseHzRKM_pGpXLaDPbS9eJMhneJjmeeBOrpQmJmROas/exec'; 

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        let allAds = []; // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        let window.ads = []; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© (Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        const cardsContainer = document.getElementById('cards-container');
        const qEl = document.getElementById('qEl');
        const catFilter = document.getElementById('catFilter');

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ£Ø®ÙŠØ± ØªÙ†ÙÙŠØ° Ø§Ù„ÙÙ„ØªØ±Ø© (Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©)
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        /* -------------------------------------------------------- */
        /* 1. Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Create Card)                */
        /* -------------------------------------------------------- */
        function createAdCard(ad) {
            // Ù†Ø³ØªØ®Ø¯Ù… Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ ÙÙŠ Sheet (Name, Description, Price, Image_URL, Location, Contact, Category)
            const card = document.createElement('div');
            card.className = 'ad-card';

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const imageUrl = ad.Image_URL && ad.Image_URL.startsWith('http') ? ad.Image_URL : 'https://via.placeholder.com/300x200?text=No+Image';

            card.innerHTML = `
                <img src="${imageUrl}" alt="${ad.Name}" loading="lazy" />
                <div class="ad-details">
                    <h3>${ad.Name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù…'}</h3>
                    <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${ad.Location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                    <p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${ad.Description ? ad.Description.substring(0, 70) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                    <p class="price">${ad.Price || 'Ù„Ù„ØªÙØ§ÙˆØ¶'}</p>
                    <p><strong>Ù„Ù„ØªÙˆØ§ØµÙ„:</strong> <a href="https://wa.me/${ad.Contact || '971501234567'}" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨</a></p>
                </div>
            `;
            return card;
        }

        /* -------------------------------------------------------- */
        /* 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© (Render Ads)                   */
        /* -------------------------------------------------------- */
        function renderAds(adsToRender) {
            cardsContainer.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙˆÙŠØ©

            if (adsToRender.length === 0) {
                cardsContainer.innerHTML = '<div class="no-results">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</div>';
                return;
            }

            adsToRender.forEach(ad => {
                cardsContainer.appendChild(createAdCard(ad));
            });
        }

        /* -------------------------------------------------------- */
        /* 3. Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± (Apply Filters)                    */
        /* -------------------------------------------------------- */
        function applyFiltersAndRender() {
            const query = qEl.value.toLowerCase().trim();
            const category = catFilter.value;

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… allAds Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
            const filteredAds = allAds.filter(ad => {
                const matchesQuery = !query || 
                                     (ad.Name && ad.Name.toLowerCase().includes(query)) ||
                                     (ad.Description && ad.Description.toLowerCase().includes(query)) ||
                                     (ad.Location && ad.Location.toLowerCase().includes(query));

                const matchesCategory = !category || 
                                        (ad.Category && ad.Category.trim() === category);
                
                return matchesQuery && matchesCategory;
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø¹Ø±Ø¶
            window.ads = filteredAds;
            renderAds(filteredAds);
        }

        /* -------------------------------------------------------- */
        /* 4. Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ¦Ø© (Populate Categories)            */
        /* -------------------------------------------------------- */
        function populateCategories(adsData) {
            const categories = new Set();
            adsData.forEach(ad => {
                if (ad.Category && ad.Category.trim()) {
                    categories.add(ad.Category.trim());
                }
            });

            catFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            
            Array.from(categories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                catFilter.appendChild(option);
            });
        }

        /* -------------------------------------------------------- */
        /* 5. Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Apps Script (Load Data)       */
        /* -------------------------------------------------------- */
        async function loadAdsFromGoogleSheet() {
            cardsContainer.innerHTML = '<div class="loading-message">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...</div>';

            try {
                const response = await fetch(WEB_APP_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                allAds = data; 

                // Ù…Ù„Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ¦Ø§Øª
                populateCategories(allAds);
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ù„Ø£Ù†Ù†Ø§ Ù†Ø±ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
                applyFiltersAndRender(); 
                
            } catch (error) {
                console.error('Error loading ads from Google Sheet:', error);
                cardsContainer.innerHTML = '<div class="error-message">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Apps Script ÙŠØ¹Ù…Ù„ Ø¨ØµÙ„Ø§Ø­ÙŠØ© (Anyone).</div>';
            }
        }


        /* -------------------------------------------------------- */
        /* 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners)                       */
        /* -------------------------------------------------------- */

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', loadAdsFromGoogleSheet); 

        // Ø±Ø¨Ø· Ø§Ù„ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙ†ÙŠÙ
        if(qEl){
            qEl.addEventListener('input', debounce(applyFiltersAndRender, 300));
        }

        if(catFilter){
            catFilter.addEventListener('change', applyFiltersAndRender);
        }

        // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const refreshBtn = document.getElementById('refresh');
        if(refreshBtn){
            refreshBtn.addEventListener('click', loadAdsFromGoogleSheet);
        }

    </script>
</body>
</html>
