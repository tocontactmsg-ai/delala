<!-- BEGIN index_updated.html -->
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>الصفحة الرئيسية - إعلانات</title>
  <style>
    body{font-family:Segoe UI,Roboto,Arial;direction:rtl;padding:12px;background:#f9fbff;color:#163041}
    .wrap{max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{background:#fff;border-radius:8px;padding:10px;border:1px solid #e6eef8}
    .thumb{width:100%;height:160px;object-fit:cover;border-radius:6px}
    .muted{color:#6b7b8c}
    input,select,button{padding:8px;border-radius:8px;border:1px solid #e6eef8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>اعلانات</h1>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <input id="search" placeholder="ابحث عن إعلان..." style="flex:1">
      <button id="refresh">تحديث</button>
      <div style="min-width:140px;text-align:left"><span id="count" class="muted">0 إعلان</span></div>
    </div>
    <div id="grid" class="grid"></div>
    <div id="skeleton" style="display:none">...</div>
  </div>

<script>
/* ---------- Helpers (unchanged except for added fetchRemoteAdsVersion) ---------- */

const CACHE_KEY = 'static_ads_cache_v1';
const cfgKey = 'static_ads_cfg_v1';

function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function ghRaw(repo, path, branch='main'){
  try{
    const [owner, r] = (repo||'').split('/');
    if(!owner || !r) return null;
    const url = `https://raw.githubusercontent.com/${owner}/${r}/${branch}/${path}`;
    const res = await fetch(url, { cache:'no-cache' });
    if(!res.ok) return null;
    return await res.text();
  }catch(e){ return null; }
}

// fetch the repo's ads_version timestamp (raw text file). Returns ISO string or null
async function fetchRemoteAdsVersion(repo, branch='main'){
  try{
    const parts = (repo||'').split('/');
    if(parts.length<2) return null;
    const owner = parts[0], repoName = parts[1];
    const url = `https://raw.githubusercontent.com/${owner}/${repoName}/${branch}/static/ads_version.txt`;
    const r = await fetch(url, { cache:'no-cache' });
    if(!r.ok) return null;
    const txt = await r.text();
    return txt.trim() || null;
  }catch(e){ return null; }
}

/* ---------- Load / cache logic (modified to compare remote ads_version) ---------- */

const grid = document.getElementById('grid');
const searchEl = document.getElementById('search');
const refreshBtn = document.getElementById('refresh');
const countEl = document.getElementById('count');

function showSkeleton(){ grid.innerHTML=''; for(let i=0;i<6;i++){ const c=document.createElement('div'); c.className='card muted'; c.style.height='200px'; c.textContent='جاري التحميل...'; grid.appendChild(c); } }

let ads = [];

async function loadAds(){
  try{
    showSkeleton();

    // Check cache validity + remote version to allow immediate invalidation
    const cachedRaw = localStorage.getItem(CACHE_KEY) || 'null';
    const cachedObj = JSON.parse(cachedRaw);
    let cached = cachedObj && cachedObj.data ? cachedObj : null;

    // if we have repo info saved, try fetching remote ads_version and compare
    let remoteVersion = null;
    try{
      const cfg = JSON.parse(localStorage.getItem('static_ads_cfg_v1') || '{}');
      if(cfg && cfg.repo){
        remoteVersion = await fetchRemoteAdsVersion(cfg.repo, cfg.branch || 'main');
      }
    }catch(e){ remoteVersion = null; }

    // if cached and not stale and versions match (or no remote version), use cache
    if(cached && (Date.now() - cached.t < 30_000) ){
      if(!remoteVersion || remoteVersion === (cached.version || null)){
        ads = cached.data;
        renderGrid(ads);
        buildCategories();
        countEl.textContent = `${ads.length} إعلان`;
        return;
      }
      // else remote version differs -> fall through to reload
    }

    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if(cached && (Date.now() - cached.t < 30_000) && cached.data){ ads = cached.data; renderGrid(ads); buildCategories(); countEl.textContent = `${ads.length} إعلان`; return; }
    const paths = ['./static/ads.json','./ads.json','/static/ads.json'];
    let items = null;
    for(const p of paths){ try{ const res = await fetch(p, { cache:'no-cache' }); if(!res.ok) continue; items = await res.json(); break; }catch(e){ continue; } }
    if(!items){ grid.innerHTML = '<div style="padding:16px">لا توجد إعلانات.</div>'; countEl.textContent='0 إعلان'; return; }
    ads = Array.isArray(items) ? items : [];
    ads.sort((a,b)=> (new Date(b.created_at||0)) - (new Date(a.created_at||0)));
    // try to also fetch remote version and store it with cache
let storeVersion = null;
try{ const cfg = JSON.parse(localStorage.getItem('static_ads_cfg_v1') || '{}'); if(cfg && cfg.repo) storeVersion = await fetchRemoteAdsVersion(cfg.repo, cfg.branch || 'main'); }catch(e){ storeVersion = null; }
localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), data: ads, version: storeVersion }))
    renderGrid(ads);
    buildCategories();
    countEl.textContent = `${ads.length} إعلان`;
  }catch(e){ console.error(e); grid.innerHTML = '<div style="padding:16px">فشل تحميل الإعلانات</div>'; countEl.textContent='0 إعلان'; }
}

function renderGrid(items){
  grid.innerHTML = '';
  items.forEach(a=>{
    const el = document.createElement('div'); el.className='card';
    const img = (a.thumb||a.image||'').replace(/^\//,'');
    el.innerHTML = `<img class="thumb" src="${img}" onerror="this.style.display='none'">
      <h4>${escapeHtml(a.name||a.code||'')}</h4>
      <div class="muted">${escapeHtml(a.location||a.category||'')}</div>
      <p>${escapeHtml((a.description||'').slice(0,120))}${(a.description||'').length>120?'...':''}</p>
      <div style="text-align:left"><small class="muted">#${escapeHtml(a.ref_code||a.code||'')}</small></div>`;
    grid.appendChild(el);
  });
}

/* ---------- search/filter ---------- */
searchEl.addEventListener('input', ()=>{
  const q = (searchEl.value||'').toLowerCase().trim();
  if(!q){ renderGrid(ads); countEl.textContent = `${ads.length} إعلان`; return; }
  const filtered = ads.filter(a=>{
    return (a.name||'').toLowerCase().includes(q) || (a.ref_code||a.code||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q) || (a.description||'').toLowerCase().includes(q);
  });
  renderGrid(filtered);
  countEl.textContent = `${filtered.length} إعلان`;
});
refreshBtn.onclick = loadAds;

/* ---------- submission code (left unchanged) ---------- */

document.addEventListener('DOMContentLoaded', ()=>{ loadAds(); });
</script>
</body>
</html>
<!-- END index_updated.html -->
