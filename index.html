<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>الدلالة — سوق إلكتروني</title>
<style>
  :root{--primary:#0078d7;--muted:#6b7280}
  body{font-family:'Tajawal',sans-serif;margin:0;padding:12px;background:#f7fbff;color:#0b1320;direction:rtl}
  .container{max-width:1100px;margin:0 auto}
  header{background:var(--primary);color:#fff;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
  .controls{display:flex;gap:8px;margin:12px 0}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eef8}
  .btn{background:var(--primary);color:#fff;padding:10px;border-radius:8px;border:none;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .card{background:#fff;border-radius:12px;padding:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06);cursor:pointer}
  .media{height:200px;background:#eef5ff;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .media img{width:100%;height:100%;object-fit:cover}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:999}
  .modal.open{display:flex}
  .modal-card{background:#fff;padding:14px;border-radius:12px;max-width:900px;width:100%}
</style>
</head>
<body>
<div class="container">
  <header><div style="font-weight:900">الدلالة</div><div class="small">سوق إلكتروني</div></header>

  <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start">
    <div>
      <div class="controls">
        <input id="q" placeholder="ابحث بالعنوان أو الرمز أو الموقع" style="flex:1"/>
        <select id="cat" style="width:180px"><option value="">كل الأقسام</option></select>
        <button id="refreshBtn" class="btn">تحديث</button>
      </div>
      <div id="grid" class="grid"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px">لا توجد إعلانات</div>
    </div>

    <aside style="background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06)">
      <h3>أنشر إعلانك</h3>
      <input id="f_ref" placeholder="الرمز (اختياري)" />
      <input id="f_name" placeholder="اسم الإعلان" />
      <input id="f_price" placeholder="السعر" />
      <input id="f_loc" placeholder="الموقع" />
      <input id="f_contact" placeholder="رقم التواصل" />
      <input id="f_cat" placeholder="التصنيف" />
      <textarea id="f_desc" placeholder="الوصف" rows="4"></textarea>
      <input id="f_file" type="file" accept="image/*" />
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px"><input type="checkbox" id="agree"/> أوافق على شروط النشر</label>
      <div style="margin-top:8px;display:flex;gap:8px"><button id="submitBtn" class="btn">إرسال</button><div id="submitStatus"></div></div>
    </aside>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true"><div class="modal-card"><div style="display:flex;justify-content:space-between;align-items:center"><div><h3 id="mTitle"></h3><div id="mRef"></div></div><button id="modalClose" class="btn">إغلاق</button></div><div style="display:flex;gap:12px;margin-top:12px"><div style="flex:1"><img id="mImg" style="max-width:100%;display:none"/></div><div style="flex:1"><div id="mDesc" style="white-space:pre-wrap"></div><div style="margin-top:12px"><div id="mPrice" style="font-weight:800;color:#047857"></div><div id="mLoc" style="color:var(--muted)"></div><div id="mContact" style="color:var(--muted)"></div></div></div></div></div></div>

<script>
  // TODO: set this after you deploy Apps Script (Web App) below
  const APPS_SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbyakkKafGPpaie62jwBdjySdAjkndbkm6NJLgj5hcCgvsTY0BFEFQ0W2kv0xZcb5HW4jg/exec'; // e.g. 'https://script.google.com/macros/s/AKfycb.../exec'
  const APPS_FETCH_URL = APPS_SCRIPT_BASE + '?action=fetchPublished';
  const APPS_POST_URL = APPS_SCRIPT_BASE;

  let ads = [];

  function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

  async function loadAds(){
    const grid = document.getElementById('grid'); grid.innerHTML = 'تحميل...';
    try {
      const res = await fetch(APPS_FETCH_URL, { cache:'no-store' });
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      if (data.status === 'success' && Array.isArray(data.ads)) {
        ads = data.ads;
        updateCategoryFilter();
        applyFilters();
      } else {
        ads = [];
        grid.innerHTML = '';
        document.getElementById('noitems').style.display = 'block';
      }
    } catch (e) {
      grid.innerHTML = '';
      document.getElementById('noitems').textContent = 'خطأ في تحميل الإعلانات';
      document.getElementById('noitems').style.display = 'block';
      console.error(e);
    }
  }

  function updateCategoryFilter(){
    const sel = document.getElementById('cat');
    const cats = Array.from(new Set(ads.map(a=>a.category||'عام'))).sort();
    sel.innerHTML = '<option value="">كل الأقسام</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  }

  function applyFilters(){
    const q = (document.getElementById('q').value||'').trim().toLowerCase();
    const cat = (document.getElementById('cat').value||'').trim();
    let out = ads.slice();
    if (cat) out = out.filter(a => (a.category||'') === cat);
    if (q) out = out.filter(a => ((a.name||'') + ' ' + (a.description||'') + ' ' + (a.location||'') + ' ' + (a.ref_code||'')).toLowerCase().includes(q));
    renderGrid(out);
  }

  function renderGrid(list){
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    if (!list.length) { document.getElementById('noitems').style.display='block'; return; }
    document.getElementById('noitems').style.display='none';
    list.forEach(a=>{
      const el = document.createElement('div'); el.className = 'card';
      const imgHtml = a.imageBase64 ? `<img src="${a.imageBase64}" alt="" style="width:100%;height:200px;object-fit:cover">` : '<div style="padding:10px;color:var(--muted)">لا توجد صورة</div>';
      el.innerHTML = `<div class="media">${imgHtml}</div><div style="padding-top:8px"><div style="font-weight:800">${escapeHtml(a.name||'')}</div><div style="color:var(--muted)">${escapeHtml((a.description||'').slice(0,140))}</div><div style="margin-top:8px;display:flex;justify-content:space-between"><div style="color:#047857">${escapeHtml(a.price||'')}</div><div style="color:var(--muted)">${escapeHtml(a.ref_code||'')}</div></div></div>`;
      el.onclick = ()=>openDetails(a);
      grid.appendChild(el);
    });
  }

  function openDetails(item){
    document.getElementById('mTitle').textContent = item.name || '';
    document.getElementById('mRef').textContent = 'رمز: ' + (item.ref_code || '');
    document.getElementById('mDesc').textContent = item.description || '';
    document.getElementById('mPrice').textContent = item.price || '';
    document.getElementById('mLoc').textContent = item.location || '';
    document.getElementById('mContact').textContent = item.contact || '';
    const img = document.getElementById('mImg');
    if (item.imageBase64) { img.src = item.imageBase64; img.style.display = 'block'; } else img.style.display = 'none';
    document.getElementById('modal').classList.add('open');
  }
  document.getElementById('modalClose').addEventListener('click', ()=>{ document.getElementById('modal').classList.remove('open'); });

  // Submission handling (convert file to base64 if any)
  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    const agree = document.getElementById('agree').checked;
    if (!agree) return alert('يرجى الموافقة على شروط النشر.');
    const name = document.getElementById('f_name').value.trim();
    if (!name) return alert('أدخل اسم الإعلان.');
    const ref = document.getElementById('f_ref').value.trim() || ('REF' + Date.now().toString(36).slice(-6).toUpperCase());
    const price = document.getElementById('f_price').value.trim();
    const desc = document.getElementById('f_desc').value.trim();
    const loc = document.getElementById('f_loc').value.trim();
    const contact = document.getElementById('f_contact').value.trim();
    const category = document.getElementById('f_cat').value.trim();

    const fileEl = document.getElementById('f_file');
    let imageBase64 = '';
    if (fileEl.files && fileEl.files[0]) {
      const file = fileEl.files[0];
      imageBase64 = await fileToBase64(file);
    }

    const payload = {
      action: 'submitAd',
      ref_code: ref,
      name: name,
      price: price,
      description: desc,
      location: loc,
      contact: contact,
      category: category,
      imageBase64: imageBase64
    };

    document.getElementById('submitStatus').textContent = 'جاري الإرسال...';
    try {
      const r = await fetch(APPS_POST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (j.status === 'success') {
        document.getElementById('submitStatus').textContent = 'تم الإرسال للمراجعة.';
        // clear form
        document.getElementById('f_name').value = '';
        document.getElementById('f_price').value = '';
        document.getElementById('f_desc').value = '';
        document.getElementById('f_file').value = '';
      } else {
        document.getElementById('submitStatus').textContent = 'خطأ: ' + (j.message || 'لم يتم الإرسال');
      }
    } catch (e) {
      document.getElementById('submitStatus').textContent = 'خطأ في الاتصال: ' + e.message;
    }
  });

  function fileToBase64(file) {
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  document.getElementById('q').addEventListener('input', debounce(applyFilters, 250));
  document.getElementById('cat').addEventListener('change', applyFilters);
  document.getElementById('refreshBtn').addEventListener('click', loadAds);

  function debounce(fn,t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }

  window.addEventListener('load', async ()=>{ if (APPS_SCRIPT_BASE.indexOf('PUT_YOUR')!==-1) { document.getElementById('grid').innerHTML = '<div style="padding:12px;color:#6b7280">ضع APPS_SCRIPT_BASE في index.html ثم أعد تحميل الصفحة</div>'; return; } await loadAds(); });
</script>
</body>
</html>
