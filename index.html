<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الدلالة — إعلانات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f7fbff;color:#0b1320;line-height:1.4}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:14px;box-shadow:0 12px 40px rgba(0,120,215,0.35);margin-bottom:16px}
  header .brand{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .brand .title{font-size:24px;font-weight:900}
  nav[aria-label="واجهة"]{display:flex;gap:8px;flex-wrap:wrap}
  nav[aria-label="واجهة"] button{
    background:rgba(255,255,255,0.12);
    color:#fff;
    border:1px solid rgba(255,255,255,0.4);
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
  }
  nav[aria-label="واجهة"] button[aria-current="true"]{
    background:#fff;
    color:#0078d7;
    border-color:#fff;
  }
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;align-items:center}
  input, textarea, select{
    padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;font-size:15px;background:#fff
  }
  textarea{min-height:80px;resize:vertical}
  .btn{background:#0078d7;color:#fff;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-size:14px}
  .btn.alt{background:#6b7280}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.09);display:flex;flex-direction:column;transition:transform .12s;cursor:pointer}
  .card:hover{transform:translateY(-4px)}
  .media{height:220px;background:#f0f4f8;display:flex;align-items:center;justify-content:center;position:relative}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:700;font-size:16px}
  .desc{font-size:13px;color:#4b5563;max-height:3.6em;overflow:hidden}
  .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#6b7280}
  .badge{background:#eff6ff;color:#1d4ed8;padding:4px 8px;border-radius:999px;font-size:11px}
  .price{font-weight:700;color:#047857}
  footer{font-size:12px;color:#6b7280;text-align:center;margin-top:18px}
  .small{font-size:12px}
  .muted{color:#6b7280}
  .panel{background:#fff;border-radius:14px;padding:12px;box-shadow:0 8px 24px rgba(15,23,42,0.08);margin-top:8px}
  .subCard{background:#0f172a;color:#e5e7eb;border-radius:14px;padding:10px;margin-top:10px}
  .refBox{background:#eff6ff;border-radius:10px;padding:6px 8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .refCode{font-family:monospace;font-size:14px}
  .fullDesc{white-space:pre-wrap;font-size:14px;color:#111827}
  .detailsList{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
  .detailsItem{background:#f9fafb;border-radius:10px;padding:6px 8px;font-size:13px}
  .detailsItem strong{display:block;font-size:11px;color:#6b7280;margin-bottom:2px}
  main > section{display:none}
  main > section.active{display:block}
  .modal{position:fixed;inset:0;background:rgba(15,23,42,0.6);display:none;align-items:center;justify-content:center;z-index:999;padding:12px}
  .modal[aria-hidden="false"]{display:flex}
  .modalCard{background:#fff;border-radius:18px;max-width:900px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 18px 40px rgba(15,23,42,0.5);display:flex;flex-direction:column}
  .modalMain{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);gap:12px;padding:12px}
  .modalImage{background:#020617;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .modalImage img{max-width:100%;max-height:360px;display:block}
  .modalFooter{padding:10px 12px;border-top:1px solid #e5e7eb;background:#f9fafb;font-size:12px;color:#6b7280;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .modalActions{display:flex;gap:8px;flex-wrap:wrap}
  @media(max-width:720px){
    .modalMain{grid-template-columns:1fr}
    .modalImage{order:-1}
    .detailsList{grid-template-columns:1fr}
  }

  /* Hide the tiny preview floating artifacts if any */
  .tiny-preview, img.small-thumb, .thumbRow.small { display:none !important; }
</style>

<!-- Mobile-cleanup & builder artifact hide -->
<style>
.visual-builder, .vb, .builder-preview, .built-card, .editor-only,
.tiny-preview, .small-thumb, .thumbRow.small, #previewCard, #adminPanel, #adminBtn,
[class*="builder"], [id*="builder"], [class*="visual"], [id*="visual"], .preview-only {
  display:none !important;
  visibility:hidden !important;
  height:0 !important;
  width:0 !important;
  overflow:hidden !important;
  opacity:0 !important;
}
body > .visual-builder, body > .vb, body > .builder-preview { display:none !important; }
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div class="brand">
      <div class="title">الدلالة</div>
      <nav aria-label="واجهة">
        <button type="button" class="nav-btn" data-target="home" aria-current="true">الرئيسية</button>
        <button type="button" class="nav-btn" data-target="send">أرسل إعلانك</button>
        <button type="button" class="nav-btn" data-target="privacy">سياسة الخصوصية</button>
      </nav>
    </div>
  </header>

  <div class="controls" id="listControls" role="search" aria-label="بحث وتحكم">
    <div style="flex:1;min-width:180px"><input id="q" type="search" placeholder="ابحث بالعنوان أو الرمز أو الموقع"></div>
    <div style="width:200px"><select id="catFilter"><option value="">كل الاقسام</option></select></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refresh" class="btn alt">⟳ تحديث</button>
      <div id="count" class="small" aria-live="polite">تحميل...</div>
    </div>
  </div>

  <main>
    <section id="home" class="active" aria-live="polite">
      <div id="grid" class="grid" role="list" aria-label="قائمة الإعلانات"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px" class="small">لا توجد إعلانات</div>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h2>لتقديم طلب موافقة علي اعلان : </h2>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="اسم الإعلان">
          <input id="f_price" placeholder="السعر">
          <textarea id="f_desc" placeholder="وصف الإعلان" rows="4"></textarea>
          <input id="f_loc" placeholder="الموقع">
          <input id="f_contact" placeholder="رقم التواصل">
          <input id="f_cat" placeholder="التصنيف">
          <div><input id="f_file" type="file" accept="image/*"></div>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="agree" />
            <span class="small">أقر أن البيانات صحيحة وأوافق على شروط النشر</span>
          </label>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="btn">بدء</button>
            <div id="submitStatus" class="small"></div>
          </div>
          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>رمز الإعلان الخاص بك:</div>
            <div class="refBox" style="margin-top:6px">
              <div id="refCode" class="refCode" style="background:#fff;padding:4px 12px;border-radius:10px;color:#0078d7;font-weight:800"></div>
              <a id="openWa" class="small" target="_blank" style="margin-left:8px;color:#0078d7;display:none"></a>
              <button id="downloadEmbedded" class="btn alt" style="margin-left:8px;display:none">تحميل البطاقة</button>
            </div>
          </div>
          <div id="fallbackJson" style="display:none;margin-top:8px">
            <div class="small">لن يتم نشر اعلانك مالم ترسل لنا البطاقة. بعد التحميل يمكنك أن تجد البطاقة في المستندات.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="privacy" style="display:none">
      <div class="panel">
        <h3>سياسة الخصوصية</h3>
        <div style="white-space:pre-wrap;background:#fff;padding:12px;border-radius:8px;border:1px solid #eef6ff;margin-top:8px" class="small muted">
باستخدامك لموقع الدلالة فأنت توافق على هذه الشروط:
- الموقع يعرض إعلانات مقدمة من مستخدمين ولا يتحمل مسؤولية صحة المعلومات.
- يجب عليك التأكد بنفسك من هوية البائع/المشتري قبل أي تعامل مالي.
- لا نقوم بتخزين بياناتك الحساسة في قاعدة بيانات عامة من خلال هذه الصفحة الثابتة.
- قد يتم تطوير النظام لاحقاً بإضافة لوحة تحكم أو نظام خلفي، وعندها سيتم تحديث سياسة الخصوصية.
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>الدلالة — تأكد دائماً من صحة المعلومات بنفسك قبل التعامل.</div>
  </footer>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard" role="document" aria-labelledby="modalTitle">
    <div style="padding:10px 12px;border-bottom:1px solid #e5e7eb">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div id="modalTitle" style="font-weight:800;font-size:18px"></div>
          <div id="modalMeta" class="small" style="margin-top:6px"></div>
          <div id="modalRef" class="small" style="margin-top:4px;font-weight:800;color:#1d4ed8"></div>
        </div>
        <button id="modalClose" class="btn alt" type="button">إغلاق</button>
      </div>
    </div>
    <div class="modalMain">
      <div class="modalImage">
        <img id="modalMainImg" src="" alt="" style="max-width:100%;max-height:100%;display:none" />
      </div>

      <div class="modalBody">
        <div id="modalDescription" class="fullDesc"></div>
        <div class="detailsList">
          <div class="detailsItem"><strong>الموقع</strong><div id="modalLoc" class="muted"></div></div>
          <div class="detailsItem"><strong>التصنيف</strong><div id="modalCat" class="badge"></div></div>
          <div class="detailsItem"><strong>السعر</strong><div id="modalPrice" class="price"></div></div>
          <div class="detailsItem"><strong>التواصل</strong><div id="modalContact" class="muted"></div></div>
        </div>
      </div>
    </div>

    <div class="modalFooter">
      <div class="modalActions">
        <a id="modalWhats" class="btn" target="_blank" rel="noopener">مشاركة عبر WhatsApp</a>
        <a id="modalCall" class="btn alt" style="display:none" href="#">اتصال</a>
        <button id="modalDownloadCard" class="btn alt" type="button" style="display:none">تحميل البطاقة</button>
      </div>
      <div class="small muted">ملاحظة: تأكد من صحة المعلومات بنفسك.</div>
    </div>
  </div>
</div>

<script>
const GITHUB_OWNER  = '';
const GITHUB_REPO   = '';
const GITHUB_BRANCH = '';
const ADS_DIR       = '';
const CACHE_BUSTER  = '';

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]||c)); }
function debounce(fn,t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }

const listControls = document.getElementById('listControls');
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.dataset.target;
    document.querySelectorAll('main > section').forEach(s=> s.classList.remove('active'));
    document.getElementById(target).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(n=>n.removeAttribute('aria-current'));
    btn.setAttribute('aria-current','true');
    listControls.style.display = (target === 'home') ? 'flex' : 'none';
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

let ads = [];
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const countEl = document.getElementById('count');

function renderGrid(list){
  grid.innerHTML='';
  list = list || [];
  if(!list.length){ document.getElementById('noitems').style.display='block'; countEl.textContent='0 إعلان'; return; }
  document.getElementById('noitems').style.display='none';
  list.forEach(a=>{
    const el = document.createElement('div'); el.className='card';
    const thumb = a.thumb || a._blobUrl || '';
    const mediaHtml = thumb ? `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(a.name||'')}">` : `<div class="noimg small">لا صورة</div>`;
    el.innerHTML = `<div class="media">${mediaHtml}</div>
      <div class="body"><div class="title">${escapeHtml(a.name||'')}</div>
      <div class="desc">${escapeHtml(a.description||'')}</div>
      <div class="meta"><div class="badge">${escapeHtml(a.category||'عام')}</div><div style="margin-left:auto" class="price">${escapeHtml(a.price||'')}</div></div>
      <div class="meta"><div class="small">${escapeHtml(a.location||'')}</div><div class="small">${escapeHtml(a.ref_code||'')}</div></div></div>`;
    el.addEventListener('click', ()=> openDetails(a));
    grid.appendChild(el);
  });
  countEl.textContent = list.length + ' إعلان';
}

/* Modal references */
const modal = document.getElementById('modal');
const modalMainImg = document.getElementById('modalMainImg');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalRef = document.getElementById('modalRef');
const modalDescription = document.getElementById('modalDescription');
const modalLoc = document.getElementById('modalLoc');
const modalCat = document.getElementById('modalCat');
const modalPrice = document.getElementById('modalPrice');
const modalContact = document.getElementById('modalContact');
const modalWhats = document.getElementById('modalWhats');
const modalCall = document.getElementById('modalCall');
const modalClose = document.getElementById('modalClose');
const modalDownloadCard = document.getElementById('modalDownloadCard');

function closeModal(){
  modal.setAttribute('aria-hidden','true');
  modal.classList.remove('open');
}
modalClose.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

function openDetails(item){
  modalTitle.textContent = item.name || 'بدون عنوان';
  modalMeta.textContent = `رمز: ${item.ref_code||''}`;
  modalRef.textContent = item.ref_code||'';
  modalDescription.textContent = item.description||'-';
  modalLoc.textContent = item.location||'-';
  modalCat.textContent = item.category||'عام';
  modalPrice.textContent = item.price || '-';
  modalContact.textContent = item.contact || '-';

  if(item._blobUrl){
    modalMainImg.src = item._blobUrl;
    modalMainImg.style.display = 'block';
  } else if(item.thumb){
    modalMainImg.src = item.thumb;
    modalMainImg.style.display = 'block';
  } else {
    modalMainImg.src = '';
    modalMainImg.style.display = 'none';
  }

  if(item.contact && item.contact.trim()){
    modalCall.style.display = 'inline-block';
    const phoneDigits = (item.contact.match(/[+0-9][0-9() \-]{4,}/) || [])[0] || item.contact;
    modalCall.href = 'tel:' + phoneDigits.replace(/\s+/g,'').replace(/[^+0-9]/g,'');
  } else modalCall.style.display = 'none';

  if(window.lastEmbeddedBlob && window.lastRef === (item.ref_code||'')){
    modalDownloadCard.style.display = 'inline-block';
    modalDownloadCard.onclick = function(e){
      e.stopPropagation();
      const url = URL.createObjectURL(window.lastEmbeddedBlob);
      const a = document.createElement('a'); a.href = url; a.download = (item.ref_code||'card') + '_eldelala.png';
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
    };
  } else if(item._blobUrl){
    modalDownloadCard.style.display = 'inline-block';
    modalDownloadCard.onclick = function(e){
      e.stopPropagation();
      const a = document.createElement('a'); a.href = item._blobUrl; a.download = (item.ref_code||'card') + '_image.png';
      document.body.appendChild(a); a.click(); a.remove();
    };
  } else modalDownloadCard.style.display = 'none';

  modalWhats.href = `https://wa.me/?text=${encodeURIComponent((item.name || '') + ' - ' + (window.location.href.split('#')[0] + '#ad-' + (item.ref_code||'')))}`;
  modalWhats.target = '_blank';

  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}

function applyFiltersAndRender(){
  const q = (qEl && qEl.value || '').trim().toLowerCase();
  const cat = (catFilter && catFilter.value || '').trim();
  let out = ads.slice();

  if(cat){
    out = out.filter(a => (a.category||'').toString() === cat);
  }

  if(q){
    out = out.filter(a => {
      const hay = ((a.name || '') + ' ' + (a.description||'') + ' ' + (a.location||'') + ' ' + (a.ref_code||'')).toLowerCase();
      return hay.indexOf(q) !== -1;
    });
  }

  out.sort((A,B) => {
    const aCat = (A.category || '').toString().localeCompare((B.category || '').toString(), 'ar');
    if(aCat !== 0) return aCat;
    return (A.name || '').toString().localeCompare((B.name || '').toString(), 'ar');
  });

  renderGrid(out);
}

renderGrid([]);

function openAdFromHash(){
  try{
    const hash = window.location.hash;
    if(!hash || !hash.startsWith('#ad-')) return;
    const ref = decodeURIComponent(hash.slice(4)).trim();
    if(!ref) return;
    const item = ads.find(a => (a.ref_code || '') === ref);
    if(item){
      try{
        document.querySelectorAll('main > section').forEach(s => s.classList.remove('active'));
        const home = document.getElementById('home');
        if(home) home.classList.add('active');
        const controls = document.getElementById('listControls');
        if(controls) controls.style.display = 'flex';
      }catch(e){}
      openDetails(item);
    }
  }catch(e){
    console.warn('openAdFromHash error', e);
  }
}

async function jsonToBase64String(obj){
  const json = JSON.stringify(obj);
  const utf8 = unescape(encodeURIComponent(json));
  return btoa(utf8);
}
async function blobToUint8(blob){
  const ab = await blob.arrayBuffer();
  return new Uint8Array(ab);
}
const MARKER = 'ELDELALA_PAYLOAD:';
async function embedJsonInImageBlob(imageBlob, payloadObj){
  const origBytes = await blobToUint8(imageBlob);
  const markerBytes = new TextEncoder().encode(MARKER);
  const b64 = await jsonToBase64String(payloadObj);
  const b64Bytes = new TextEncoder().encode(b64);
  const out = new Uint8Array(origBytes.length + markerBytes.length + b64Bytes.length);
  out.set(origBytes,0);
  out.set(markerBytes, origBytes.length);
  out.set(b64Bytes, origBytes.length + markerBytes.length);
  return new Blob([out], { type: imageBlob.type || 'image/png' });
}
async function imageFileToBaseDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function createPlaceholderImageBlob(){
  const c = document.createElement('canvas');
  c.width = 900;
  c.height = 600;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#e5f0ff';
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle = '#111827';
  ctx.font = 'bold 40px Tajawal, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('الدلالة', c.width/2, c.height/2 - 10);
  ctx.font = '20px Tajawal, sans-serif';
  ctx.fillText('إعلان بدون صورة', c.width/2, c.height/2 + 30);
  const dataURL = c.toDataURL('image/png');
  const bin = atob(dataURL.split(',')[1]);
  const len = bin.length;
  const u8 = new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
  return new Blob([u8], {type:'image/png'});
}
function createRefCardCanvas(baseImg, payload){
  const W = 900;
  const H = 1100;
  const canvas = document.createElement('canvas');
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#f5f8ff');
  grad.addColorStop(1,'#e8f5ff');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);

  const cardX = 60;
  const cardY = 60;
  const cardW = W - 120;
  const cardH = H - 120;
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  const r = 30;
  ctx.moveTo(cardX+r, cardY);
  ctx.lineTo(cardX+cardW-r, cardY);
  ctx.quadraticCurveTo(cardX+cardW, cardY, cardX+cardW, cardY+r);
  ctx.lineTo(cardX+cardW, cardY+cardH-r);
  ctx.quadraticCurveTo(cardX+cardW, cardY+cardH, cardX+cardW-r, cardY+cardH);
  ctx.lineTo(cardX+r, cardY+cardH);
  ctx.quadraticCurveTo(cardX, cardY+cardH, cardX, cardY+cardH-r);
  ctx.lineTo(cardX, cardY+r);
  ctx.quadraticCurveTo(cardX, cardY, cardX+r, cardY);
  ctx.closePath();
  ctx.fill();

  const imgMargin = 40;
  const imgAreaX = cardX + imgMargin;
  const imgAreaY = cardY + imgMargin;
  const imgAreaW = cardW - imgMargin*2;
  const imgAreaH = 550;
  const ratio = Math.min(imgAreaW / baseImg.width, imgAreaH / baseImg.height);
  const drawW = baseImg.width * ratio;
  const drawH = baseImg.height * ratio;
  const dx = imgAreaX + (imgAreaW - drawW)/2;
  const dy = imgAreaY + (imgAreaH - drawH)/2;

  ctx.save();
  ctx.beginPath();
  const ir = 26;
  ctx.moveTo(imgAreaX+ir, imgAreaY);
  ctx.lineTo(imgAreaX+imgAreaW-ir, imgAreaY);
  ctx.quadraticCurveTo(imgAreaX+imgAreaW, imgAreaY, imgAreaX+imgAreaW, imgAreaY+ir);
  ctx.lineTo(imgAreaX+imgAreaW, imgAreaY+imgAreaH-ir);
  ctx.quadraticCurveTo(imgAreaX+imgAreaW, imgAreaY+imgAreaH, imgAreaX+imgAreaW-ir, imgAreaY+imgAreaH);
  ctx.lineTo(imgAreaX+ir, imgAreaY+imgAreaH);
  ctx.quadraticCurveTo(imgAreaX, imgAreaY+imgAreaH, imgAreaX, imgAreaY+imgAreaH-ir);
  ctx.lineTo(imgAreaX, imgAreaY+ir);
  ctx.quadraticCurveTo(imgAreaX, imgAreaY, imgAreaX+ir, imgAreaY);
  ctx.closePath();
  ctx.clip();
  ctx.drawImage(baseImg, dx, dy, drawW, drawH);
  ctx.restore();

  const refText = payload.ref_code || '';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#111827';
  ctx.font = 'bold 52px Tajawal, sans-serif';
  ctx.fillText(refText, W/2, imgAreaY + imgAreaH + 120);
  ctx.fillStyle = '#4b5563';
  ctx.font = '24px Tajawal, sans-serif';
  ctx.fillText('نشكرك علي استخدامك موقع الدلالة', W/2, imgAreaY + imgAreaH + 170);

  return canvas;
}
async function canvasToPngBlob(canvas){
  return new Promise((resolve,reject)=>{
    if(canvas.toBlob){
      canvas.toBlob(b => b ? resolve(b) : reject(new Error('toBlob null')), 'image/png');
    }else{
      try{
        const dataURL = canvas.toDataURL('image/png');
        const bin = atob(dataURL.split(',')[1]);
        const len = bin.length;
        const u8 = new Uint8Array(len);
        for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
        resolve(new Blob([u8],{type:'image/png'}));
      }catch(e){ reject(e); }
    }
  });
}

(function(){
  const submitBtn = document.getElementById('submitBtn');
  const submitStatus = document.getElementById('submitStatus');
  const afterSubmit = document.getElementById('afterSubmit');
  const refCodeEl = document.getElementById('refCode');
  const downloadEmbeddedBtn = document.getElementById('downloadEmbedded');
  const openWa = document.getElementById('openWa');
  const f_name = document.getElementById('f_name');
  const f_price = document.getElementById('f_price');
  const f_desc = document.getElementById('f_desc');
  const f_loc = document.getElementById('f_loc');
  const f_contact = document.getElementById('f_contact');
  const f_cat = document.getElementById('f_cat');
  const f_file = document.getElementById('f_file');
  const agree = document.getElementById('agree');
  const previewCanvasWrap = document.getElementById('previewCanvasWrap');
  const fallbackBox = document.getElementById('fallbackJson');

  let lastEmbeddedBlob = null;
  let lastRef = null;
  window.lastEmbeddedBlob = null;
  window.lastRef = null;

  if(!previewCanvasWrap){
    const p = document.createElement('div');
    p.id = 'previewCard';
    p.className='subCard';
    p.innerHTML = '<div class="small" style="margin-bottom:6px">معاينة البطاقة:</div><div id="previewCanvasWrap"></div>';
    const panel = document.querySelector('#send .panel > div');
    if(panel) panel.appendChild(p);
  }

  function showStatus(msg,isError=false){
    submitStatus.textContent = msg;
    submitStatus.style.color = isError ? '#b45309' : '#0b84ff';
  }

  submitBtn && submitBtn.addEventListener('click', async ()=>{
    try{
      if(submitBtn.disabled) return;
      submitBtn.disabled = true;
      showStatus('جارٍ تجهيز الإعلان...');

      if(!f_name.value || f_name.value.trim().length < 2){
        showStatus('الرجاء إدخال اسم للإعلان', true);
        submitBtn.disabled = false;
        return;
      }
      if(!agree.checked){
        showStatus('يجب الموافقة على الشروط', true);
        submitBtn.disabled = false;
        return;
      }

      const ref = genRef();
      refCodeEl.textContent = ref;
      afterSubmit.style.display = 'block';
      downloadEmbeddedBtn.style.display = 'none';
      if(openWa) openWa.style.display = 'none';
      fallbackBox.style.display = 'none';

      const payload = {
        ref_code: ref,
        name: f_name.value.trim(),
        price: f_price.value.trim(),
        description: f_desc.value.trim(),
        location: f_loc.value.trim(),
        contact: f_contact.value.trim(),
        category: f_cat.value.trim(),
        created_at: new Date().toISOString()
      };

      let fileBlob;
      if(f_file.files && f_file.files[0]){
        fileBlob = f_file.files[0];
      } else {
        fileBlob = await createPlaceholderImageBlob();
      }

      const baseDataURL = await imageFileToBaseDataURL(fileBlob);
      const baseImg = await new Promise((resolve,reject)=>{
        const i = new Image();
        i.onload = ()=>resolve(i);
        i.onerror = reject;
        i.src = baseDataURL;
      });

      const canvas = createRefCardCanvas(baseImg, payload);
      const pngBlob = await canvasToPngBlob(canvas);
      const dataUrl = canvas.toDataURL('image/png');

      if(previewCanvasWrap){
        previewCanvasWrap.innerHTML='';
        const imgEl = document.createElement('img');
        imgEl.src = dataUrl;
        imgEl.style.width='100%';
        imgEl.style.borderRadius='12px';
        previewCanvasWrap.appendChild(imgEl);
        const pc = document.getElementById('previewCard');
        if(pc) pc.style.display='block';
      }

      const embedded = await embedJsonInImageBlob(pngBlob, payload);
      lastEmbeddedBlob = embedded;
      lastRef = ref;
      window.lastEmbeddedBlob = embedded;
      window.lastRef = ref;

      downloadEmbeddedBtn.style.display='inline-block';
      downloadEmbeddedBtn.onclick = function(){
        const url = URL.createObjectURL(embedded);
        const a = document.createElement('a');
        a.href = url;
        a.download = ref + '_eldelala.png';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);

        if(openWa){
          openWa.style.display='inline-block';
          const base = window.location.href.split('#')[0];
          const adLink = base + '#ad-' + ref;
          openWa.textContent = 'فتح WhatsApp لإرسال البطاقة';
          openWa.href = 'https://wa.me/?text=' + encodeURIComponent(
            `مرحباً، أود نشر إعلان برمز: ${ref}\n${payload.name}\n${payload.price}\n${adLink}\nسأرفق البطاقة (${ref}_eldelala.png).`
          );
        }
      };

      showStatus('تم إنشاء البطاقة — يمكنك الآن تحميلها.');
      fallbackBox.style.display = 'block';
    }catch(err){
      console.error(err);
      showStatus('حدث خطأ أثناء الإنشاء.', true);
    }finally{
      submitBtn.disabled = false;
    }
  });
})();

async function loadAdsJson(){
  try{
    const r = await fetch('./ads.json', {cache:'no-cache'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const raw = await r.json();
    const arr = Array.isArray(raw) ? raw : (raw.ads || raw.items || []);
    ads = arr.map(it => {
      const thumb = it.thumb || it.image || it.imageDataUrl || '';
      return {
        ref_code: it.ref || it.ref_code || it.id || '',
        name: it.title || it.name || it.headline || '',
        price: it.price || it.amount || '',
        description: it.description || it.desc || it.body || '',
        location: it.location || it.city || it.loc || '',
        contact: it.phone || it.contact || it.tel || '',
        category: (it.category || it.cat || it.type || it.Category || '').toString().trim() || 'عام',
        thumb: (typeof thumb === 'string' && thumb.startsWith('data:')) ? thumb : (it.imageDataUrl && it.imageDataUrl.startsWith('data:') ? it.imageDataUrl : ''),
        _fileName: it._fileName || ''
      };
    });

    try{
      const cats = [...new Set(ads.map(a=>a.category||'عام'))];
      cats.sort((a,b)=> a.toString().localeCompare(b.toString(), 'ar'));
      const cf = document.getElementById('catFilter');
      if(cf) cf.innerHTML = '<option value="">كل الاقسام</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }catch(e){ console.warn('category populate', e); }

    if(qEl){
      qEl.addEventListener('input', debounce(()=>applyFiltersAndRender(), 220));
    }
    if(catFilter){
      catFilter.addEventListener('change', ()=>applyFiltersAndRender());
    }
    const refresh = document.getElementById('refresh');
    if(refresh) refresh.addEventListener('click', ()=>{ loadAdsJson(); });

    applyFiltersAndRender();
    openAdFromHash();
  }catch(err){
    console.error('loadAdsJson failed', err);
    if(document.getElementById('noitems')) document.getElementById('noitems').style.display='block';
    if(document.getElementById('count')) document.getElementById('count').textContent='0 إعلان';
  }
}
window.addEventListener('load', ()=>{ setTimeout(()=>loadAdsJson(), 50); });
window.addEventListener('hashchange', ()=>{ openAdFromHash(); });
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    const selectors = [
      '.visual-builder', '.vb', '.builder-preview', '.built-card', '.editor-only',
      '.tiny-preview', '.small-thumb', '.thumbRow.small', '#previewCard.debug-only', '#adminPanel', '#adminBtn',
      '[class*="builder"]', '[id*="builder"]', '[class*="visual"]', '[id*="visual"]',
      '.preview-only', '.vb-toolbar', '.editor-toolbar', '.builder-toolbar', '[data-builder]'
    ];
    selectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(n=>{
        if(n.id === 'previewCard' || n.id === 'previewCanvasWrap') return;
        if(n.closest('#send')) return;
        try{
          const rect = n.getBoundingClientRect();
          if(rect.width < 16 && rect.height < 16){
            n.remove();
          } else {
            const parent = n.parentNode;
            while(n.firstChild) parent.insertBefore(n.firstChild, n);
            n.remove();
          }
        } catch(e) { n.remove(); }
      });
    });

    const allImgs = Array.from(document.querySelectorAll('img'));
    const seen = new Map();
    allImgs.forEach(img=>{
      const key = (img.getAttribute('src') || '') + '|' + (img.getAttribute('alt')||'');
      if(seen.has(key)){
        if((img.naturalWidth && img.naturalWidth < 120) || img.width < 120) img.remove();
      } else {
        seen.set(key, img);
      }
    });

    document.querySelectorAll('img').forEach(img=>{
      if((img.width && img.width < 80) || (img.naturalWidth && img.naturalWidth < 80)) {
        img.setAttribute('data-builder-thumb','true');
      }
    });

    document.querySelectorAll('[style*="builder"], [style*="preview"]').forEach(n=>n.remove());

  } catch(e){ console.warn('cleanup script error', e); }
});
</script>

</body>
</html>
