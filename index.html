<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ุงูุฏูุงูุฉ | ุณูู ุฅููุชุฑููู ููุจูุน ูุงูุดุฑุงุก ูู ุงูุณูุฏุงู</title>
<link rel="icon" type="image/png" href="/favicon.ico">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-VFM8VZCQY6');
</script>

  <meta name="description" content="ุงูุฏูุงูุฉ โ ูุนุฑุถ ูุณูู ูุชููุฒ ููุดุฑ ููุชุงุจุนุฉ ุงูุฅุนูุงูุงุช ุงููุจูุจุฉ ุจุณูููุฉ ููุณุฑ ูู ุงูุณูุฏุงู . ุงูุดุฑ ุฅุนูุงูู ุจุณูููุฉ ูุชูุงุตู ูุน ุงููุดุชุฑูู ูู ููุทูุชู ูุจุงุดุฑุฉ , ูุชุนุฉ ูุณูููุฉ ูู ุงูุนุฑุถ ูุงูุทูุจ ,ููุท ุนุจุฑ ุงููุงุชุณุงุจ ููููู ุชูุฏูู ุทูุจ ุงุนูุงู ูุงุฐุง ุชูุช ุงูููุงููุฉ ุณูุนุฑุถ ุงุนูุงูู ุนูู ุงูููุงููู ูู ุงูุฒูุงุฑ." />
<link rel="canonical" href="https://eldelala.com/" />
<link rel="icon" type="image/png" href="/favicon.ico">

<meta property="og:type" content="website" />
<meta property="og:title" content="ุงูุฏูุงูุฉ โ ุงุนูู ุจุจุณุงุทุฉ ูุณูููุฉ" />
<meta property="og:description" content="ุณูู ุฅููุชุฑููู ููุจูุน ูุงูุดุฑุงุก ุฏุงุฎู ุงูุณูุฏุงู โ ุงูุฏูุงูุฉ" />
<meta property="og:url" content="https://eldelala.com/" />
<meta property="og:image" content="https://eldelala.com/logo-1200x630.png" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="ุงูุฏูุงูุฉ โ ุณูู ุฅููุชุฑููู ููุจูุน ูุงูุดุฑุงุก ุฏุงุฎู ุงูุณูุฏุงู โ ุงูุฏูุงูุฉ" />
<meta name="twitter:description" content="ุณูู ุฅููุชุฑููู ููุจูุน ูุงูุดุฑุงุก ุฏุงุฎู ุงูุณูุฏุงู โ ุงูุฏูุงูุฉ" />
<meta name="twitter:image" content="https://eldelala.com/logo-800x418.png" />


<link rel="preload" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet"></noscript>

<style>
  /* --- ุงูุชุตููู ูู index (1).html --- */
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f7fbff;color:#0b1320;line-height:1.4}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:14px;box-shadow:0 12px 40px rgba(0,120,215,0.35);margin-bottom:16px}
  header .brand{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .brand .title{font-size:24px;font-weight:900}
  nav[aria-label="ูุงุฌูุฉ"]{display:flex;gap:8px;flex-wrap:wrap}
  nav[aria-label="ูุงุฌูุฉ"] button{
    background:rgba(255,255,255,0.12);
    color:#fff;
    border:1px solid rgba(255,255,255,0.4);
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
    transition: background 0.2s;
  }
  nav[aria-label="ูุงุฌูุฉ"] button:hover{
     background:rgba(255,255,255,0.25);
  }
  nav[aria-label="ูุงุฌูุฉ"] button[aria-current="true"]{
    background:#fff;
    color:#0078d7;
    border-color:#fff;
  }
  /* ุฃุฏูุงุช ุงูุชุญูู (ุงูุจุญุซ ูุงูููุชุฑุฉ) */
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;align-items:center}
  input, textarea, select{
    padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;font-size:15px;background:#fff
  }
  textarea{min-height:80px;resize:vertical}
  .btn{background:#0078d7;color:#fff;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-size:14px;text-decoration:none;display:inline-block;text-align:center;}
  button.btn.alt#modalClose { background: #dc2626; } 
  .btn.alt{background:green }
  button.btn#modalShare { background: #5271ff; }
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  /* ุงูุดุจูุฉ ูุงูุจุทุงูุงุช (Grid & Cards) */
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.06);cursor:pointer;display:flex;flex-direction:column;min-height:360px}
  .card:hover{box-shadow:0 10px 30px rgba(15,23,42,0.1);transform:translateY(-2px)}
  .card .media{height:160px;overflow:hidden;background:#f0f4f8;display:flex;align-items:center;justify-content:center}
  .card .media img{width:100%;height:100%;object-fit:cover;transition:transform 0.4s}
  .card:hover .media img{transform:scale(1.05)}
  .card .body{padding:14px;flex-grow:1;display:flex;flex-direction:column}
  .card .title{font-size:16px;font-weight:700;margin-bottom:6px;color:#0078d7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .card .desc{font-size:13px;color:#556;margin-bottom:10px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;flex-grow:1}
  .card .meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;flex-wrap:wrap;gap:4px}
  .card .badge{background:#e0f7fa;color:#00bcd4;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .card .price{font-size:15px;font-weight:900;color:#28a745}
  .card .small{font-size:11px;color:#999}
  .count-bar{text-align:center;font-size:14px;color:#555;padding:10px 0;margin-top:10px}
  
  /* ุชุตููู ุงูู Modal (ูุงูุฐุฉ ุงูุชูุงุตูู) */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,0.6);display:none;align-items:center;justify-content:center;z-index:999;padding:12px} 
  .modal[aria-hidden="false"]{display:flex}
  .modalCard{background:#fff;border-radius:12px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 12px 30px rgba(0,0,0,0.3);position:relative}
  .modalHeader{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .modalTitle{font-size:22px;font-weight:700;color:#0078d7}
  #modalClose{font-size:28px;line-height:1;background:none;color:#555;padding:0;border:none}
  .modalBody{padding:20px}
  .modalContent{display:flex;gap:25px}
  .modalDetails{flex-grow:1}
  .modalDescription{margin-top:10px;font-size:15px;color:#333;line-height:1.6;border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px}
  .detailsGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
  .detailsItem strong{display:block;font-size:13px;color:#888;margin-bottom:5px}
  .detailsItem div{font-size:16px;font-weight:600;color:#0b1320}
  .modalImage{max-height: 60vh; display: flex; align-items: center; justify-content: center; background: #020617;}
  .modalImage img{max-height: 55vh; width: auto; height: auto; object-fit: contain;}
  .modalFooter{padding:15px;border-top:1px solid #eee;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
  .modalActions{display:flex;gap:10px}
  .small.muted{font-size:11px;color:#999}

  /* ุงูุดุฑูุท ุงููุชุญุฑู (Ticker Tape) */
  .ticker-tape{
    overflow:hidden;
    background:#ffeadf; /* ููู ุฎููู */
    padding:8px 0;
    white-space:nowrap;
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
    margin-bottom:16px;
    display:none; /* ุฅุฎูุงุก ุงูุชุฑุงุถูุงู */
  }
  .ticker-tape.has-messages{
    display:block; /* ุฅุธูุงุฑ ูู ุญุงูุฉ ูุฌูุฏ ุฑุณุงุฆู */
  }
  .ticker-content{
    display:inline-block;
    animation:marquee 30s linear infinite;
    padding-left:100%; /* ูุจุฏุฃ ูู ุฎุงุฑุฌ ุงูุดุงุดุฉ */
  }
  .ticker-item{
    padding:0 30px;
    font-size:14px;
    color:#e65100; /* ููู ุจุฑุชูุงูู ููุชูุจูู */
    font-weight:600;
  }
  @keyframes marquee{
    0%{transform:translateX(0)}
    100%{transform:translateX(-100%)}
  }
  
  /* ุฃูุณุงู ุงููุงุฌูุฉ */
  main > section{display:none}
  main > section.active{display:block}
  .form-group{margin-bottom:12px}
  .error, .success{padding:10px;border-radius:8px;font-weight:700;margin-top:10px;text-align:center}
  .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
  
  /* Media Query for Modal Content on small screens */
  @media (max-width:600px){
    .modalContent{flex-direction:column}
    .modalImage{max-height:40vh;width:100%}
    .modalImage img{max-height:35vh;width:100%;object-fit:contain}
  }

</style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <span class="title">ุงูุฏูุงูุฉ</span>
            <nav aria-label="ูุงุฌูุฉ">
                <button data-target="home" aria-current="true">ุงูุฅุนูุงูุงุช (ุงูุณูู)</button>
                <button data-target="submit">ุงูุดุฑ ุฅุนูุงูู</button>
                <button data-target="about">ูู ูุญู / ุงูุดุฑูุท</button>
            </nav>
        </div>
    </header>

    <div id="tickerTape" class="ticker-tape" role="marquee" aria-live="off">
        <div class="ticker-content">
            <span class="ticker-item"> ุณูุชู ุงูุชูุงุตู ูุน ุงููุฑุดุญูู ุงููุฎุชุงุฑูู ููุท </span>
            <span class="ticker-item"> ุชุฃูุฏ ุฏุงุฆูุงู ูู ุตุญุฉ ุงููุนูููุงุช ุจููุณู ูุจู ุงูุชุนุงูู </span>
            <span class="ticker-item"> ุงูุฏูุงูุฉุ ููุตุฉ ุฅููุชุฑูููุฉ ุชูุฏู ุฅูู ุชุณููู ูุดุฑ ุงูุฅุนูุงูุงุช </span>
        </div>
    </div>

    <main>
        <section id="home" class="active" aria-live="polite">
            <div class="controls">
                <input type="search" id="qEl" placeholder="ุงุจุญุซ ุจุนููุงู ุงูุฅุนูุงู ุฃู ูุตูู..." style="flex-grow: 1;">
                <select id="catFilter" style="width: 200px;">
                    <option value="">ุฌููุน ุงููุฆุงุช</option>
                    </select>
                <button id="refresh" class="btn" style="background: #ffc107; color: #333;">ุชุญุฏูุซ</button>
            </div>
            
            <div id="grid" class="grid">
                <div class="count-bar" style="grid-column: 1 / -1;">ุฌุงุฑู ุชุญููู ุงูุฅุนูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ...</div>
            </div>
            
            <div id="countEl" class="count-bar"></div>
        </section>

        <section id="submit">
            <h3>ุชูุฏูู ุทูุจ ุฅุนูุงู ุฌุฏูุฏ</h3>
            <div id="messageStatus" class="small muted" style="text-align: right; margin-bottom: 15px;">
                ุณูุชู ูุฑุงุฌุนุฉ ุฅุนูุงูู ูู ูุจู ูุฑูู ุงูุฅุฏุงุฑุฉ ูุจู ุงููุดุฑ.
            </div>

            <form id="adForm">
                <div class="form-group">
                    <label for="name">ุนููุงู ุงูุฅุนูุงู (ูุฎุชุตุฑ)</label>
                    <input type="text" id="name" name="name" required placeholder="ูุซู: ุบุฑูุฉ ููู ููุฏุฑูุ ุดูุฉ ููุงูุฌุงุฑ ุจุจุญุฑู">
                </div>
                
                <div class="form-group">
                    <label for="description">ูุตู ูุงูู ูููุตู</label>
                    <textarea id="description" name="description" required placeholder="ุงุฐูุฑ ุฌููุน ุงูุชูุงุตูู ูุงูููุฒุงุช ูุงูุนููุจ ุฅู ูุฌุฏุช."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="category">ุงููุฆุฉ</label>
                    <input type="text" id="category" name="category" required placeholder="ูุซู: ุนูุงุฑุงุชุ ุณูุงุฑุงุชุ ุฃุซุงุซ">
                </div>
                
                <div class="form-group">
                    <label for="location">ุงููููุน</label>
                    <input type="text" id="location" name="location" required placeholder="ุงููุฏููุฉ ูุงูุญู/ุงูููุทูุฉ">
                </div>
                
                <div class="form-group">
                    <label for="price">ุงูุณุนุฑ</label>
                    <input type="text" id="price" name="price" required placeholder="ูุซู: 500,000 ุฌูููุ ุฃู ุชูุงูุถ">
                </div>
                
                <div class="form-group">
                    <label for="contact">ุฑูู ุงูุชูุงุตู (WhatsApp)</label>
                    <input type="text" id="contact" name="contact" required placeholder="ูุซุงู: 0912345678">
                </div>
                
                <div class="form-group">
                    <label for="image_file">ููู ุงูุตูุฑุฉ (ูุทููุจ - ุณูุชู ูุนุงูุฌุชู ูุฑูุนู)</label>
                    <input type="file" id="image_file" name="image_file" accept="image/*" required>
                </div>

                <div class="form-group">
                    <div id="status" class="small muted"></div>
                </div>

                <button type="submit" id="submitBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px;">ุฅุฑุณุงู ุทูุจ ุงูุฅุนูุงู</button>
            </form>
        </section>

        <section id="about">
            <h3>ูู ูุญูุ</h3>
            <p>ููุตุฉ ุงูุฏูุงูุฉ ูู ุณูู ุฅููุชุฑููู ููุฏู ุฅูู ุชุณููู ุนูููุฉ ุงูุจูุน ูุงูุดุฑุงุก ููุดุฑ ุงูุฅุนูุงูุงุช ุงููุจูุจุฉ ุฏุงุฎู ุงูุณูุฏุงู. ูุญู ูููุฑ ูุงุฌูุฉ ุจุณูุทุฉ ูุณููุฉ ูููุณุชุฎุฏููู ููุชูุงุตู ุงููุจุงุดุฑ ุนุจุฑ ุงููุงุชุณุงุจ.</p>
            
            <h3>ุดุฑูุท ุงูุงุณุชุฎุฏุงู ุงูุฃุณุงุณูุฉ:</h3>
            <ul>
                <li><strong>ุงููุณุคูููุฉ ุงูุดุฎุตูุฉ:</strong> ููุน ุงูุชุนุงูู ุจูู ุงููุนูู ูุงููุดุชุฑู ุฃู ุงูุฃุทุฑุงู ุงูุซุงูุซุฉ ุนูู ูุณุคูููุฉ ุงููุณุชุฎุฏู ุงูุดุฎุตูุฉ ุจุงููุงูู.</li>
                <li><strong>ุฅุฎูุงุก ุงููุณุคูููุฉ:</strong> ูุง ูุชุญูู ุงููููุน ุฃู ูุณุคูููุฉ ูุงููููุฉ ุฃู ูุงููุฉ ุฃู ุชุนููุถูุฉ ุชุชุนูู ุจูุชุงุฆุฌ ุงูุชุนุงููุงุชุ ุงูุฎุณุงุฆุฑ ุฃู ุงูุฃุถุฑุงุฑุ ุงูุงุญุชูุงู ุฃู ุงูุชุถูููุ ุณูุก ุงูุงุณุชุฎุฏุงูุ ุฃู ุฃู ูุฒุงุนุงุช ุฃู ูุทุงูุจุงุช ุชูุดุฃ ุจูู ุงููุณุชุฎุฏููู ุฃู ุงููุนูููู.</li>
                <li><strong>ุงูุงูุชุฒุงูุงุช:</strong> ูุชุนูุฏ ุงููุณุชุฎุฏู ุจุงูุงูุชุฒุงู ุจุงุณุชุฎุฏุงู ุงููููุน ููููุง ููููุงููู ูุงูุฃูุธูุฉ ุงูุณุงุฑูุฉ ูุนุฏู ูุดุฑ ุฃู ูุญุชูู ูุณูุก ุฃู ูุฎุงูู ุฃู ูุถูู.</li>
            </ul>
        </section>

    </main>
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalCard">
        <div class="modalHeader">
            <h3 id="modalTitle" class="modalTitle">ุนููุงู ุงูุฅุนูุงู</h3>
            <button id="modalClose" class="btn alt" type="button" aria-label="ุฅุบูุงู">&times;</button>
        </div>
        <div class="modalBody">
            <div class="modalContent">
                <div id="modalImage" class="modalImage">
                    </div>
                <div class="modalDetails">
                    <p id="modalMeta" class="small muted" style="text-align: left;"></p>
                    <p id="modalDescription" class="modalDescription"></p>
                    
                    <div class="detailsGrid">
                        <div class="detailsItem">
                            <strong>ุงููุฆุฉ</strong>
                            <div id="modalCat"></div>
                        </div>
                        <div class="detailsItem">
                            <strong>ุงููููุน</strong>
                            <div id="modalLoc"></div>
                        </div>
                        <div class="detailsItem">
                            <strong>ุงูุณุนุฑ</strong>
                            <div id="modalPrice" class="price"></div>
                        </div>
                        <div class="detailsItem">
                            <strong>ุงูุชูุงุตู</strong>
                            <div id="modalContact" class="muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modalFooter">
            <div class="modalActions">
                <button id="modalShare" class="btn" type="button" style="background:#5271ff;">ูุดุงุฑูุฉ ูุน ุตุฏูู</button>
                <a id="modalWhats" class="btn" target="_blank" rel="noopener">ุชูุงุตู (WhatsApp)</a>
                <a id="modalCall" class="btn alt" style="display:none" href="#">ุงุชุตุงู ูุงุชูู</a>
            </div>
            <div class="small muted">ููุงุญุธุฉ: ุชุฃูุฏ ูู ุตุญุฉ ุงููุนูููุงุช ุจููุณู ูุจู ุงูุชุนุงูู.</div>
        </div>
    </div>
</div>

<script defer>
    /* ========================================================== */
    /* ๐ ุงูุชูููู (Configuration) ๐ */
    /* ========================================================== */
    const ADMIN_WHATSAPP_NUMBER = '249998615193'; // ุฑูู ุงููุงุชุณุงุจ ุงูุฎุงุต ุจู
    // โ๏ธ ุชู ูุถุน ุฑุงุจุท ุงููุดุฑ ุงูุฌุฏูุฏ ููุง:
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyFxIpZWjJAAf1tSJGEtUuR8cG7UR4lUIZPhcA42cgddRvKGwX5_xf7Cwt_ehBSU4pa/exec'; 

    /* ========================================================== */
    /* ๐ ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ูุนูุงุตุฑ DOM ๐ */
    /* ========================================================== */
    let allAds = []; // ูุงุฆูุฉ ูุชุฎุฒูู ุฌููุน ุงูุฅุนูุงูุงุช
    let isDataLoaded = false;
    
    // ุนูุงุตุฑ ุงููุงุฌูุฉ
    const grid = document.getElementById('grid');
    const countEl = document.getElementById('countEl');
    const qEl = document.getElementById('qEl');
    const catFilter = document.getElementById('catFilter');

    // ุนูุงุตุฑ ุงูู Modal
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalMeta = document.getElementById('modalMeta');
    const modalDescription = document.getElementById('modalDescription');
    const modalLoc = document.getElementById('modalLoc');
    const modalCat = document.getElementById('modalCat');
    const modalPrice = document.getElementById('modalPrice');
    const modalContact = document.getElementById('modalContact');
    const modalImageContainer = document.getElementById('modalImage');
    const modalWhats = document.getElementById('modalWhats');
    const modalShare = document.getElementById('modalShare');


    /* ========================================================== */
    /* 1. ูุธุงุฆู ุงููุณุงุนุฏุฉ (Helpers) */
    /* ========================================================== */

    function escapeHtml(str) {
        if (typeof str !== 'string' && typeof str !== 'number') return '';
        return String(str).replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    function displayDate(dateString) {
        const date = new Date(dateString);
        if (isNaN(date)) return 'ุชุงุฑูุฎ ุบูุฑ ูุนุฑูู';
        const now = new Date();
        const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

        if (diffInDays === 0) return 'ุงูููู';
        if (diffInDays === 1) return 'ุฃูุณ';
        if (diffInDays < 7) return `${diffInDays} ุฃูุงู ูุถุช`;
        
        return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function displayMessage(type, message) {
        const statusElement = document.getElementById('status');
        if (statusElement) {
            statusElement.className = `small ${type}`;
            statusElement.textContent = message;
        }
    }
    
    // ๐ก ูุธููุฉ ุฌุฏูุฏุฉ: ุงูุญุตูู ุนูู ุฑุงุจุท ุตูุฑุฉ ููุญุณููู
    function getOptimizedImageUrl(originalUrl, size = 'w400') {
        if (!originalUrl || !originalUrl.startsWith('http')) {
            return 'https://via.placeholder.com/400x300?text=ุตูุฑุฉ+ุบูุฑ+ูุชููุฑุฉ';
        }
        
        // ** ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฑูุงุจุท Google Drive ูุชุญุณูู ุงูุนุฑุถ ูุงูุชุญููู **
        if (originalUrl.includes('drive.google.com') || originalUrl.includes('googleusercontent.com')) {
            // ุงุณุชุฎูุงุต ูุนุฑู ุงูููู (File ID) ูู ุงูุฑุงุจุท
            const fileIdMatch = originalUrl.match(/id=([a-zA-Z0-9_-]+)|d\/([a-zA-Z0-9_-]+)/);
            let fileId = null;
            if (fileIdMatch) {
                fileId = fileIdMatch[1] || fileIdMatch[2];
            }
            
            if (fileId) {
                // ุงุณุชุฎุฏุงู ุฑุงุจุท ุงูู Thumbnail ูู Google Drive ูุชูููู ุญุฌู ุงูุตูุฑุฉ
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=${size}`;
            }
        }

        // ุงุณุชุฎุฏุงู ุงูุฑุงุจุท ุงูุฃุตูู ุฅุฐุง ูู ููู ุฑุงุจุท Google Drive
        return originalUrl;
    }


    /* ========================================================== */
    /* 2. ูุธุงุฆู ุงูุชุญููู ูุงูุชุตููู (Loading & Categorization) */
    /* ========================================================== */
    
    /**
     * ๐ ุงููุธููุฉ ุงูุฌุฏูุฏุฉ: ุชุญููู ุงูุฅุนูุงูุงุช ูู Apps Script
     */
    async function loadAdsFromGoogleSheet() {
        if (!grid) return;
        grid.innerHTML = '<div class="count-bar" style="grid-column: 1 / -1;">ุฌุงุฑู ุชุญููู ุงูุฅุนูุงูุงุช...</div>';
        isDataLoaded = false;
        
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'GET',
                redirect: 'follow',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // ุชุฎุฒูู ุงูุจูุงูุงุช
            allAds = data; 
            isDataLoaded = true;

            // ููุก ุฎูุงุฑุงุช ุงููุฆุงุช
            populateCategories(allAds);
            
            // ุชุทุจูู ุงูููุงุชุฑ ูุนุฑุถ ุงูุฅุนูุงูุงุช (ูุฃููุง ูุฑูุฏ ุนุฑุถ ุงููู ูู ุงูุจุฏุงูุฉ)
            applyFiltersAndRender(); 
            
        } catch (error) {
            console.error('Error loading ads from Google Sheet:', error);
            grid.innerHTML = '<div class="error-message" style="grid-column: 1 / -1;">โ ูุดู ุชุญููู ุงูุฅุนูุงูุงุช. ูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู Apps Script ูุนูู ุจุตูุงุญูุฉ (Anyone).</div>';
        }
    }

    // ููุก ูุงุฆูุฉ ุงููุฆุงุช ุงูููุณุฏูุฉ
    function populateCategories(ads) {
        const categories = new Set();
        ads.forEach(ad => {
            if (ad.Category) {
                categories.add(ad.Category);
            }
        });

        catFilter.innerHTML = '<option value="">ุฌููุน ุงููุฆุงุช</option>';
        Array.from(categories).sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            catFilter.appendChild(option);
        });
    }


    /* ========================================================== */
    /* 3. ูุธุงุฆู ุงูููุชุฑุฉ ูุงูุนุฑุถ (Filtering & Rendering) */
    /* ========================================================== */

    // ุฏุงูุฉ ุชุทุจูู ุงูููุงุชุฑ ูุนุฑุถ ุงููุชุงุฆุฌ
    function applyFiltersAndRender() {
        if (!isDataLoaded) return; // ูุง ุชุนุฑุถ ุฃู ุดูุก ุญุชู ูุชู ุชุญููู ุงูุจูุงูุงุช
        const q = (qEl && qEl.value || '').trim().toLowerCase();
        const cat = (catFilter && catFilter.value || '').trim();
        let out = allAds.slice();

        // ููุชุฑุฉ ุจุงูุจุญุซ ุงููุตู (ุงูุนููุงูุ ุงููุตูุ ุงููููุน)
        if (q) {
            out = out.filter(a => 
                (a.Name && a.Name.toLowerCase().includes(q)) ||
                (a.Description && a.Description.toLowerCase().includes(q)) ||
                (a.Location && a.Location.toLowerCase().includes(q))
            );
        }

        // ููุชุฑุฉ ุจุงูุชุตููู
        if (cat) {
            out = out.filter(a => a.Category === cat);
        }

        renderAds(out);
    }
    
    // ุฏุงูุฉ ุนุฑุถ ุงูุฅุนูุงูุงุช ูู ุงูุดุจูุฉ (Grid)
    function renderAds(list) {
        grid.innerHTML = ''; 
        if (list.length === 0) {
            grid.innerHTML = `<div class="count-bar" style="grid-column: 1 / -1;">ูุง ุชูุฌุฏ ุฅุนูุงูุงุช ูุทุงุจูุฉ ูุนูููุฉ ุงูุจุญุซ.</div>`;
            countEl.textContent = '0 ุฅุนูุงู';
            return;
        }

        list.forEach(a => {
            const el = document.createElement('div');
            el.className = 'card';
            
            // ๐ก ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ููุญุตูู ุนูู ุฑุงุจุท ุตูุฑุฉ ูุญุณูู ููุจุทุงูุฉ
            const imageSrc = getOptimizedImageUrl(a.Image_URL, 'w400');
            
            // ุชุญุฏูุฏ ูุญุชูู ุงูุตูุฑุฉ (ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ุนุจุงุฑุฉ ุนู ููุฏ Base64)
            // ๐ก ุงุณุชุฎุฏุงู ูุณู <picture> ูุทูุจ WebP ูุฃููููุฉ ูููุชุตูุญุงุช ุงูุฏุงุนูุฉ
            const mediaHtml = a.Image_URL && a.Image_URL.startsWith('data:image/') ? 
                                `<img src="${a.Image_URL}" alt="${escapeHtml(a.Name || '')}" loading="lazy">` :
                                `<picture>
                                    <source srcset="${imageSrc}" type="image/webp">
                                    <img src="${imageSrc}" alt="${escapeHtml(a.Name || '')}" loading="lazy">
                                </picture>`;

            el.innerHTML = `
                <div class="media">${mediaHtml}</div>
                <div class="body">
                    <div class="title">${escapeHtml(a.Name || '')}</div>
                    <div class="desc">${escapeHtml(a.Description || '')}</div>
                    <div class="meta">
                        <div class="badge">${escapeHtml(a.Category || 'ุนุงู')}</div>
                        <div class="price">${escapeHtml(a.Price || '')}</div>
                    </div>
                    <div class="meta">
                        <div class="small">${escapeHtml(a.Location || '')}</div>
                        <div class="small">(${displayDate(a.Date || '')})</div>
                    </div>
                </div>
            `;
            
            // ุฑุจุท ุญุฏุซ ุงูููุฑ ููุชุญ ุงูุชูุงุตูู
            el.addEventListener('click', () => {
                window.location.hash = a.ref_code || '';
                openDetails(a);
            });
            grid.appendChild(el);
        });

        countEl.textContent = list.length + ' ุฅุนูุงู';
    }


    /* ========================================================== */
    /* 4. ูุธุงุฆู ุงูููุฏุงู (Modal & Deep Linking) */
    /* ========================================================== */

    // ุฏุงูุฉ ููุชุญ ูุงูุฐุฉ ุงูุชูุงุตูู
    function openDetails(ad) {
        // ููุก ุงูุจูุงูุงุช
        modalTitle.textContent = escapeHtml(ad.Name || 'ุฅุนูุงู ุบูุฑ ูุญุฏุฏ');
        modalDescription.textContent = escapeHtml(ad.Description || 'ูุง ููุฌุฏ ูุตู ูุชุงุญ.');
        modalCat.textContent = escapeHtml(ad.Category || 'ุนุงู');
        modalLoc.textContent = escapeHtml(ad.Location || 'ุบูุฑ ูุญุฏุฏ');
        modalPrice.textContent = escapeHtml(ad.Price || 'N/A');
        modalContact.textContent = escapeHtml(ad.Contact || 'N/A');
        
        const refCode = ad.ref_code || '';
        const adDate = displayDate(ad.Date || '');
        modalMeta.textContent = `ุงูููุฏ ุงููุฑุฌุนู: ${refCode} | ุชุงุฑูุฎ ุงููุดุฑ: ${adDate}`;
        
        // ๐ก ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ููุญุตูู ุนูู ุฑุงุจุท ุตูุฑุฉ ูุญุณูู ููุชูุงุตูู (ุญุฌู ุฃูุจุฑ)
        const imageSrc = getOptimizedImageUrl(ad.Image_URL, 'w800');
        
        // ๐ก ุงุณุชุฎุฏุงู ูุณู <picture> ูุทูุจ WebP ูุฃููููุฉ ูููุชุตูุญุงุช ุงูุฏุงุนูุฉ
        modalImageContainer.innerHTML = `
            <picture>
                <source srcset="${imageSrc}" type="image/webp">
                <img id="modalMainImg" src="${imageSrc}" alt="${escapeHtml(ad.Name || '')}" loading="lazy">
            </picture>
        `;

        // ุฑูุงุจุท ุงูุชูุงุตู
        const whatsMessage = `ูุฑุญุจุงูุ ุฃูุง ููุชู ุจุงูุฅุนูุงู ุฑูู ${refCode} ( ุจุนููุงู: ${ad.Name} ). ูู ุงูุฅุนูุงู ูุชุงุญ ุจุนุฏุ`;
        modalWhats.href = `https://wa.me/${escapeHtml(ad.Contact || '')}?text=${encodeURIComponent(whatsMessage)}`;
        
        // ุฑุงุจุท ุงููุดุงุฑูุฉ (ูุณุชุฎุฏู Web Share API)
        modalShare.onclick = () => {
            const shareMessage = `ุดุงูุฏ ูุฐุง ุงูุฅุนูุงู ุนูู ุงูุฏูุงูุฉ: ${ad.Name}\n${window.location.href}`;
             if (navigator.share) {
                navigator.share({
                    title: ad.Name,
                    text: shareMessage,
                    url: window.location.href,
                }).catch(error => console.error('Error sharing:', error));
            } else {
                // Fallback to WhatsApp link (URL encoded)
                window.open(`https://wa.me/?text=${encodeURIComponent(shareMessage)}`, '_blank');
            }
        };

        modal.setAttribute('aria-hidden', 'false');
    }

    // ุฏุงูุฉ ูุฅุบูุงู ูุงูุฐุฉ ุงูุชูุงุตูู
    function closeModal() {
        window.history.replaceState(null, null, window.location.pathname + window.location.search);
        modal.setAttribute('aria-hidden', 'true');
    }
    
    // ุฏุงูุฉ ููุชุญ ุงูุฅุนูุงู ูุจุงุดุฑุฉ ูู ุฑุงุจุท ูุญุชูู ุนูู ูุงุด (#ref_code)
    function openAdFromHash() {
        const hash = window.location.hash.substring(1);
        if (hash) {
            const ad = allAds.find(a => a.ref_code === hash);
            if (ad) {
                openDetails(ad);
            }
        }
    }


    /* ========================================================== */
    /* 5. ูุธุงุฆู ุงูุชููู (Navigation) */
    /* ========================================================== */

    // ุฏุงูุฉ ุงูุชุจุฏูู ุจูู ุงูุฃูุณุงู
    function setupNavigation(targetId = 'home') {
        const navButtons = document.querySelectorAll('nav[aria-label="ูุงุฌูุฉ"] button');
        const sections = document.querySelectorAll('main > section');

        // ุฏุงูุฉ ุงูุชุจุฏูู ุงููุนููุฉ
        const switchSection = (target) => {
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === target) {
                    section.classList.add('active');
                }
            });
            navButtons.forEach(btn => {
                const isActive = btn.getAttribute('data-target') === target;
                btn.setAttribute('aria-current', isActive ? 'true' : 'false');
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        // ุฑุจุท ุงูุฃุญุฏุงุซ ุจุงูุฃุฒุฑุงุฑ
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchSection(button.getAttribute('data-target'));
            });
        });
        
        // ุชูุนูู ุงููุณู ุงูุฃููู
        switchSection(targetId);
    }
    
    // ุฏุงูุฉ ููุชุญูู ูู ูุฌูุฏ ุฑุณุงุฆู ูู ุงูุดุฑูุท ุงููุชุญุฑู ูุฅุธูุงุฑู
    function checkAndToggleVisibility() {
        const tickerTape = document.getElementById('tickerTape');
        const tickerItems = tickerTape ? tickerTape.querySelectorAll('.ticker-item') : null;
        
        if (tickerTape && tickerItems && tickerItems.length > 0) {
            tickerTape.classList.add('has-messages');
        }
    }


    /* -------------------------------------------------------------------------- */
    /* 6. ููุทู ุฅุฑุณุงู ุงูุฅุนูุงูุงุช (Form Submission Logic) - ๐ก ุฑูุน ุงูุตูุฑ ูุจุงุดุฑุฉ */
    /* -------------------------------------------------------------------------- */
    (function() {
        const adForm = document.getElementById('adForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusElement = document.getElementById('status');

        if (!adForm || !submitBtn) return; 

        adForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitBtn.disabled = true;
            statusElement.textContent = 'ุฌุงุฑู ุชุญุถูุฑ ูุฑูุน ุงูุตูุฑุฉ...';
            statusElement.className = 'small muted';

            const formData = new FormData(adForm);
            const adData = {};
            for (let [key, value] of formData.entries()) {
                adData[key] = value.trim();
            }
            
            // 1. ุงูุญุตูู ุนูู ููู ุงูุตูุฑุฉ
            const fileInput = document.getElementById('image_file');
            const file = fileInput.files[0];
            
            if (!file) {
                displayMessage('error', 'โ ูุฑุฌู ุงุฎุชูุงุฑ ููู ุตูุฑุฉ.');
                submitBtn.disabled = false;
                return;
            }

            // 2. ูุฑุงุกุฉ ุงูููู ูู Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = async function() {
                // ุฅุฒุงูุฉ ุฑุฃุณ ุงูุจูุงูุงุช (data:image/jpeg;base64,) ููุญุตูู ุนูู Base64 ุงูููู
                const base64Data = reader.result.split(',')[1]; 
                const mimeType = file.type;
                
                // 3. ุชุญุถูุฑ Payload ููุฅุฑุณุงู ุนุจุฑ POST ุฅูู Apps Script
                const finalPayload = {
                    action: 'submitAd', 
                    data: {
                        Name: adData.name,
                        Description: adData.description,
                        Category: adData.category,
                        Location: adData.location,
                        Price: adData.price,
                        Contact: adData.contact,
                        ImageBase64: base64Data, // ุฅุฑุณุงู ุจูุงูุงุช ุงูุตูุฑุฉ
                        MimeType: mimeType, // ุฅุฑุณุงู ููุน ุงูุตูุฑุฉ
                        ref_code: 'AD' + Date.now().toString().slice(-6),
                        Date: new Date().toISOString(),
                        Status: 'Pending'
                    }
                };

                statusElement.textContent = 'ุฌุงุฑู ุฅุฑุณุงู ุงูุฅุนูุงู ูุญูุธู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...';

                try {
                    // 4. ุฅุฑุณุงู ุงูุจูุงูุงุช ุนุจุฑ POST ุฅูู Apps Script
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST', 
                        mode: 'cors', 
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded', 
                        },
                        // ูุชู ุฅุฑุณุงู ุงููุงุฆู ูู JSON ููุชููู Apps Script ูู ูุฑุงุกุชู ุนุจุฑ e.postData.contents
                        body: JSON.stringify(finalPayload) 
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        displayMessage('success', 'โ ุชู ุงุณุชูุงู ุฅุนูุงูู ูููุฑุงุฌุนุฉ ุจูุฌุงุญ! ุณูุธูุฑ ูู ููุญุฉ ุงูุชุญูู ุฎูุงู ูุญุธุงุช.');
                        adForm.reset();
                    } else {
                        // Apps Script returned an error
                        displayMessage('error', `โ ูุดู ุงูุฅุฑุณุงู: ${result.message || 'ุญุฏุซ ุฎุทุฃ ูู ุฌูุฉ ุงูุฎุงุฏู. (ุฑุงุฌุน Console)'}`);
                    }

                } catch (error) {
                    console.error('Network Submission Error:', error);
                    displayMessage('error', 'โ ูุดู ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูุชุฃูุฏ ุฃู ุฑุงุจุท Apps Script ูุนูู.');
                } finally {
                    submitBtn.disabled = false;
                }
            };

            reader.onerror = function() {
                displayMessage('error', 'โ ูุดู ูู ูุฑุงุกุฉ ููู ุงูุตูุฑุฉ.');
                submitBtn.disabled = false;
            };
        });
    })();
    /* -------------------------------------------------------------------------- */
    /* END ADS SUBMISSION LOGIC */
    /* -------------------------------------------------------------------------- */


    // --- ุฅุนุฏุงุฏ ุงูุฃุญุฏุงุซ ุงูุนุงูุฉ ---
    if(qEl){
      qEl.addEventListener('input', debounce(applyFiltersAndRender, 300));
    }

    if(catFilter){
      catFilter.addEventListener('change', applyFiltersAndRender);
    }

    const refreshBtn = document.getElementById('refresh');
    if(refreshBtn){
      refreshBtn.addEventListener('click', loadAdsFromGoogleSheet);
    }
    
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { // ุฅุบูุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌ ุงูู ModalCard
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Initial load handler
    window.addEventListener('load', async ()=>{ 
      // 1. Setup section switching 
      setupNavigation(); 
      
      // 2. Load and render initial data
      await loadAdsFromGoogleSheet(); // ูุณุชุฎุฏู await ูุถูุงู ุชุญููู ุงูุจูุงูุงุช ูุจู ุงูุชุญูู ูู ุงููุงุด
      
      // 3. Check for hash in URL and open the ad modal if found
      openAdFromHash(); 
      checkAndToggleVisibility();
    });

</script>

</body>
</html>
