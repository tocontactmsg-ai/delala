<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© | Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</title>
<link rel="icon" type="image/png" href="/favicon.ico">

<meta name="description" content="Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ù…Ø¹Ø±Ø¶ ÙˆØ³ÙˆÙ‚ Ù…ØªÙ…ÙŠØ² Ù„Ù†Ø´Ø± ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙˆØ¨Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆÙŠØ³Ø± ÙÙŠ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† . Ø§Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø©." />
<link rel="canonical" href="https://eldelala.com/" />
<link rel="icon" type="image/png" href="/favicon.ico">

<meta property="og:type" content="website" />
<meta property="og:title" content="Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø§Ø¹Ù„Ù† Ø¨Ø¨Ø³Ø§Ø·Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©" />
<meta property="og:description" content="Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† â€“ Ø§Ù„Ø¯Ù„Ø§Ù„Ø©..." />
<meta property="og:image" content="https://eldelala.com/og-image.jpg" />

<style>
/* CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
body { font-family: 'Arial', sans-serif; }
.ad-card { position: relative; } /* Ù…Ù‡Ù… Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ */
.admin-status-banner {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 5px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    color: white;
    z-index: 10;
    border-radius: 5px 5px 0 0;
}
.status-pending {
    background-color: #f59e0b; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
}
.status-approved {
    background-color: #10b981; /* Ø£Ø®Ø¶Ø± */
}
/* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
#admin-logout-btn { display: none; }
</style>
</head>
<body>

  <nav class="nav-bar">
    <div class="nav-links">
      <a href="#home" class="nav-link active" data-target="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (<span id="countEl">0</span>)</a>
      <a href="#submit-ad" class="nav-link" data-target="submit-ad">Ø£Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ</a>
    </div>
  </nav>

  <div id="home" class="page-view active">
    <h2 id="home-title">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>
    
    <div id="search-filter-area" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <input type="search" id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." style="width: 70%; padding: 8px;">
        <select id="catFilter" style="width: 25%; padding: 8px;">
            <option value="">ÙƒÙ„ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…</option>
        </select>
        <button id="refresh" style="padding: 8px 15px;">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <p id="noitems" style="display: none; text-align: center;"></p>
    <div id="ads-container" class="row">
        </div>
  </div>

  <div id="submit-ad" class="page-view">
    <h2>Ø£Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
    <div id="msgContainer"></div>
    <form id="ad-form">
      <input type="text" id="f_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ù…Ø·Ù„ÙˆØ¨)" required>
      <input type="text" id="f_price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <textarea id="f_desc" placeholder="ÙˆØµÙ Ù…ÙØµÙ„ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†"></textarea>
      <input type="text" id="f_loc" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
      <input type="text" id="f_contact" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ (ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ù‡Ø§ØªÙ)">
      <select id="f_cat">
        <option value="Ø¹Ø§Ù…">ØªØµÙ†ÙŠÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</option>
        <option value="Ø¹Ù‚Ø§Ø±Ø§Øª">Ø¹Ù‚Ø§Ø±Ø§Øª</option>
        <option value="Ù…Ø±ÙƒØ¨Ø§Øª">Ù…Ø±ÙƒØ¨Ø§Øª</option>
        <option value="Ø£Ø«Ø§Ø«">Ø£Ø«Ø§Ø«</option>
        </select>
      <label for="f_file">ØµÙˆØ±Ø© Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø£Ù‚Ù„ Ù…Ù† 5 Ù…ÙŠØºØ§Ø¨Ø§ÙŠØª)</label>
      <input type="file" id="f_file" accept="image/*">
      
      <div style="margin-top: 15px;">
        <input type="checkbox" id="agree" required>
        <label for="agree">Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ù†Ø´Ø±.</label>
      </div>

      <button type="button" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    </form>
    <div id="afterSubmit" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ccc;">
      <p>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù…Ø² Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <span id="refCode"></span></p>
      <p id="submitStatus" style="font-weight: bold;"></p>
      </div>
  </div>

  <div id="adModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAdModal()">&times;</span>
        <div id="modal-ad-content"></div>
    </div>
  </div>
  
  <div id="admin-controls" style="position: fixed; bottom: 10px; right: 10px; z-index: 100;">
    <button onclick="toggleAdminView()" id="admin-login-btn" style="padding: 10px; background-color: #f00; color: white; border: none; cursor: pointer; border-radius: 5px;">
        ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    </button>
    <button onclick="logoutAdmin()" id="admin-logout-btn" style="padding: 10px; background-color: #555; color: white; border: none; cursor: pointer; border-radius: 5px; display: none;">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø³Ø¤ÙˆÙ„)
    </button>
  </div>


<script defer>

/* === Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª === */
// ğŸš¨ 1. ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨ Apps Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ğŸš¨
const GOOGLE_SHEET_API_URL = 'YOUR_APPS_SCRIPT_URL_HERE'; 

// ğŸ’¡ NEW: Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
function getAdminToken(){
  return localStorage.getItem('ELDELALA_ADMIN_TOKEN');
}

let isAdminView = !!getAdminToken(); // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ù…Ø²
let ads = [];
const adsContainer = document.getElementById('ads-container');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const countEl = document.getElementById('countEl');
const msgContainer = document.getElementById('msgContainer');
// ... (Ø¨Ù‚ÙŠØ© ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±)


/* === Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© === */

function debounce(func, timeout = 300) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return unsafe.toString()
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function genRef(){
    return 'AD' + (new Date().getTime().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase());
}

function displayMessage(type, message){
    const div = document.createElement('div');
    div.className = `alert alert-${type}`;
    div.innerHTML = `<button onclick="this.parentElement.remove()">Ã—</button> ${message}`;
    msgContainer.appendChild(div);
}

function showStatus(msg, isError=false){
    const submitStatus = document.getElementById('submitStatus');
    if(submitStatus) {
        submitStatus.textContent = msg;
        submitStatus.style.color = isError ? '#b45309' : '#0b84ff';
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Base64
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Ø¯Ø§Ù„Ø© ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function openAdModal(ref) {
    const ad = ads.find(a => a.ref_code === ref);
    if (!ad) return;

    const modalContent = document.getElementById('modal-ad-content');
    modalContent.innerHTML = `
        <h3>${escapeHtml(ad.name)}</h3>
        <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${escapeHtml(ad.price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</p>
        ${ad.image ? `<img src="${ad.image}" alt="${escapeHtml(ad.name)}" style="max-width: 100%; height: auto; margin-bottom: 15px;">` : ''}
        <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${escapeHtml(ad.description)}</p>
        <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${escapeHtml(ad.location)}</p>
        <p><strong>Ø§Ù„ØªÙˆØ§ØµÙ„:</strong> ${escapeHtml(ad.contact)}</p>
        <p><strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${escapeHtml(ad.category)}</p>
        <p style="font-size: 0.8em; color: #999;">Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ${escapeHtml(ad.ref_code)}</p>
        ${isAdminView ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${escapeHtml(ad.status)}</p><p style="color: red;">Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ù‚Ù… Ø¨Ø°Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Google Sheet.</p>` : ''}
    `;
    document.getElementById('adModal').style.display = 'block';
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡Ø§Ø´ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
    history.pushState(null, null, `#ad=${ref}`);
}

function closeAdModal() {
    document.getElementById('adModal').style.display = 'none';
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ø´ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    history.pushState(null, null, ' ');
}

function openAdFromHash(){
    const hash = window.location.hash.substring(1);
    const match = hash.match(/^ad=(.*)$/);
    if (match && ads.length > 0) {
        openAdModal(match[1]);
    }
}


/* === Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± === */

function renderAds(filteredAds) {
    if (countEl) countEl.textContent = filteredAds.length;

    if (filteredAds.length === 0) {
        adsContainer.innerHTML = `<div style="text-align: center; width: 100%;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        return;
    }

    const html = filteredAds.map((ad)=>{
        let adminBanner = '';
        // ğŸ›‘ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
        if(isAdminView){
            let statusClass = ad.status && ad.status.toLowerCase() === 'pending' ? 'status-pending' : 'status-approved';
            adminBanner = `<div class="admin-status-banner ${statusClass}">Ø§Ù„Ø­Ø§Ù„Ø©: ${ad.status} (${ad.ref_code})</div>`;
        }

        const searchStr = `${ad.name} ${ad.description} ${ad.location} ${ad.category} ${ad.price}`.toLowerCase();
        
        return `
            <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 card-col" data-cat="${escapeHtml(ad.category)}" data-search="${searchStr}">
                <div class="ad-card" data-ref="${escapeHtml(ad.ref_code)}" onclick="openAdModal('${escapeHtml(ad.ref_code)}')">
                    ${adminBanner} 
                    <div class="card-image-container">
                        ${ad.image ? `<img src="${ad.image}" alt="${escapeHtml(ad.name)}" class="card-image" loading="lazy" onerror="this.onerror=null; this.src='assets/placeholder.webp';" />` : `<div class="card-image-placeholder">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>`}
                    </div>
                    <div class="card-details">
                        <div class="card-title">${escapeHtml(ad.name)}</div>
                        <div class="card-price">${escapeHtml(ad.price || 'Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
                        <div class="card-location">${escapeHtml(ad.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    adsContainer.innerHTML = html;
}

function applyFiltersAndRender(){
    let filtered = ads;
    const query = qEl.value.toLowerCase().trim();
    const category = catFilter.value;

    if (query) {
        filtered = filtered.filter(ad => 
            (ad.name && ad.name.toLowerCase().includes(query)) ||
            (ad.description && ad.description.toLowerCase().includes(query)) ||
            (ad.location && ad.location.toLowerCase().includes(query))
        );
    }

    if (category) {
        filtered = filtered.filter(ad => ad.category === category);
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ¹Ù„Ø§Ù‹ØŒ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ØªØµÙÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
    if (isAdminView && query.toLowerCase() === 'pending') {
         filtered = filtered.filter(ad => ad.status && ad.status.toLowerCase() === 'pending');
    }

    renderAds(filtered);
}


/* === Ù…Ù†Ø·Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Apps Script === */
async function loadAdsFromGithub(){ 
    const noItemsEl = document.getElementById('noitems');
    // ... (ØªØ­Ø¯ÙŠØ¯ loaderEl)
    
    if(noItemsEl){
        noItemsEl.style.display = 'block';
        noItemsEl.innerHTML = isAdminView 
                            ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ù…Ø¹Ù„Ù‚Ø© ÙˆÙ…Ø¹ØªÙ…Ø¯Ø©)...'
                            : 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©...';
    }
    if(countEl) countEl.textContent = 'ØªØ­Ù…ÙŠÙ„...';
    
    try{
        if (GOOGLE_SHEET_API_URL.includes('YOUR_APPS_SCRIPT_URL_HERE')) {
             throw new Error("âŒ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø±Ø§Ø¨Ø· Google Apps Script. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« GOOGLE_SHEET_API_URL.");
        }
        
        let url = GOOGLE_SHEET_API_URL;
        
        // ğŸ›‘ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…Ø² Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø®Ø²Ù†
        const token = getAdminToken();
        isAdminView = !!token; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ù…Ø²
        
        if (isAdminView) {
            url += `?sessionToken=${token}`; // Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙØ®Ø²Ù‘Ù†
        }

        const res = await fetch(url, { method: 'GET' });

        if(!res.ok){
            throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheet API');
        }
        
        const jsonAds = await res.json();
        
        if (jsonAds.success === false) throw new Error(jsonAds.error);

        ads = jsonAds.map(item => ({
            ref_code: item.ref_code || '',
            name: item.name || '',
            price: item.price || '',
            description: item.description || '',
            location: item.location || '',
            contact: item.contact || '',
            category: item.category || 'Ø¹Ø§Ù…',
            image: item.image || '', 
            status: item.status || 'N/A' // Ø§Ù„Ø­Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†
        }));
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        const cats = [...new Set(ads.map(a=>a.category||'Ø¹Ø§Ù…'))];
        cats.sort((a,b)=> a.toString().localeCompare(b.toString(), 'ar'));
        if(catFilter){
            catFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…</option>' + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }
        
        applyFiltersAndRender();
        noItemsEl.style.display = 'none';

    }catch(err){
        console.error('Failed to load ads from Google Sheet:', err);
        if(noItemsEl){
            noItemsEl.innerHTML = 'âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. <br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Apps Script Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.';
        }
        if(countEl) countEl.textContent = '0 Ø¥Ø¹Ù„Ø§Ù†';
        ads = [];
    }
}


/* === Ù…Ù†Ø·Ù‚ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† === */
(function(){
  const submitBtn = document.getElementById('submitBtn');
  const f_name = document.getElementById('f_name');
  const f_price = document.getElementById('f_price');
  const f_desc = document.getElementById('f_desc');
  const f_loc = document.getElementById('f_loc');
  const f_contact = document.getElementById('f_contact');
  const f_cat = document.getElementById('f_cat');
  const f_file = document.getElementById('f_file');
  const agree = document.getElementById('agree');
  const refCodeEl = document.getElementById('refCode');
  
  submitBtn && submitBtn.addEventListener('click', async ()=>{
    try{
      msgContainer.innerHTML = '';
      checkAndToggleVisibility();
      
      const name = f_name.value.trim();
      if(!name || name.length < 2){
        displayMessage('error', 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ§Ø¶Ø­ ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
        return;
      }
      if(!agree.checked){
        displayMessage('error', 'ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ù†Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
        return;
      }
      if (GOOGLE_SHEET_API_URL.includes('YOUR_APPS_SCRIPT_URL_HERE')) {
         throw new Error("âŒ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø±Ø§Ø¨Ø· Google Apps Script. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† GOOGLE_SHEET_API_URL.");
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = '...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      showStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...');
      
      let imageBase64 = null;
      let mimeType = null;
      const ref = genRef(); 
      
      if(f_file.files && f_file.files[0]){
        showStatus('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...');
        const file = f_file.files[0];
        const dataUrl = await fileToDataUrl(file);
        
        const parts = dataUrl.split(';');
        mimeType = parts[0].split(':')[1];
        imageBase64 = parts[1].split(',')[1];
      }
      
      const payload = {
        ref_code: ref,
        name: name,
        price: f_price.value.trim(),
        description: f_desc.value.trim(),
        location: f_loc.value.trim(),
        contact: f_contact.value.trim(),
        category: f_cat.value.trim(),
        image: imageBase64, // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Base64
        mime: mimeType
      };

      const response = await fetch(GOOGLE_SHEET_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      
      if(response.ok && result.success){
        refCodeEl.textContent = result.ref_code;
        document.getElementById('afterSubmit').style.display = 'block';

        displayMessage('success', `âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù…Ø² Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: ${result.ref_code}. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‚Ø±ÙŠØ¨Ø§Ù‹.`);
        showStatus('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­.', false);
        
        // Clear form
        document.getElementById('ad-form').reset();

      } else {
        throw new Error(result.error || 'ÙØ´Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Apps Script.');
      }

    }catch(err){
      console.error(err);
      const errorMsg = err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.';
      displayMessage('error', 'ğŸš« ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + errorMsg);
      showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ù†Ø¸Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.', true);
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    }
  });
})(); 


/* === Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ÙˆÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© === */

function checkAndToggleVisibility() {
    const homeEl = document.getElementById('home');
    const submitEl = document.getElementById('submit-ad');
    const loginBtn = document.getElementById('admin-login-btn');
    const logoutBtn = document.getElementById('admin-logout-btn');
    const homeTitle = document.getElementById('home-title');
    const searchFilterArea = document.getElementById('search-filter-area');

    if (homeEl.classList.contains('active')) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ¹Ù„Ø§Ù‹ØŒ ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        if(searchFilterArea) searchFilterArea.style.display = isAdminView ? 'none' : 'flex';
        
        // ØªØ¨Ø¯ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
        if (isAdminView) {
            if(loginBtn) loginBtn.style.display = 'none';
            if(logoutBtn) logoutBtn.style.display = 'inline-block';
            if(homeTitle) homeTitle.textContent = 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)';
        } else {
            if(loginBtn) loginBtn.style.display = 'inline-block';
            if(logoutBtn) logoutBtn.style.display = 'none';
            if(homeTitle) homeTitle.textContent = 'Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©';
        }
    }
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯)
async function toggleAdminView() {
    const adminPass = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:");
    
    if (adminPass === null || adminPass === "") return;

    try {
        // Ù†Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Apps Script Ù„Ù„ØªØ­Ù‚Ù‚
        const url = `${GOOGLE_SHEET_API_URL}?p=${encodeURIComponent(adminPass)}`;
        
        const response = await fetch(url, { method: 'GET' });
        const result = await response.json();
        
        if (result.success && result.token) {
            // Ø§Ù„Ù†Ø¬Ø§Ø­: Ù†Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„Ù‡ Ù„Ù†Ø§ Apps Script
            localStorage.setItem('ELDELALA_ADMIN_TOKEN', result.token);
            isAdminView = true;
            
            alert("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.");
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            document.getElementById('home').classList.add('active');
            document.getElementById('submit-ad').classList.remove('active');
            
            checkAndToggleVisibility(); 
            loadAdsFromGithub(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯
        } else {
            alert(result.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.");
        }
    } catch(e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    }
}

function logoutAdmin() {
    localStorage.removeItem('ELDELALA_ADMIN_TOKEN');
    isAdminView = false;
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„. Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø·.");
    checkAndToggleVisibility();
    loadAdsFromGithub();
}


/* === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« === */
const refreshBtn = document.getElementById('refresh');
if(refreshBtn){
  refreshBtn.addEventListener('click', loadAdsFromGithub);
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØµÙØ­Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = e.target.getAttribute('data-target');

        document.querySelectorAll('.page-view').forEach(page => {
            page.classList.remove('active');
        });
        document.querySelectorAll('.nav-link').forEach(nav => {
            nav.classList.remove('active');
        });

        document.getElementById(targetId).classList.add('active');
        e.target.classList.add('active');
        checkAndToggleVisibility(); // Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    });
});


window.addEventListener('load', async ()=>{ 
    await loadAdsFromGithub(); 
    openAdFromHash(); 
    checkAndToggleVisibility();
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
    if(qEl) qEl.addEventListener('input', debounce(applyFiltersAndRender, 300));
    if(catFilter) catFilter.addEventListener('change', applyFiltersAndRender);
});

window.addEventListener('hashchange', openAdFromHash);

</script>
</body>
</html>
