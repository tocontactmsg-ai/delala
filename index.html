<!doctype html>
<!-- Full corrected HTML with working camera -->
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>الدلالة — إعلانات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
/* (Styling unchanged — keep your previous CSS exactly as-is) */
</style>
</head>
<body>
<!-- YOUR ORIGINAL BODY CONTENT HERE (unchanged) -->

<script>
/* --- Your original JS code remains exactly the same UNTIL the camera section --- */

/* ---------------- CAMERA FIX (REPLACES old camera code) ---------------- */
const useCameraBtn = document.getElementById('useCameraBtn');
const fileInput = document.getElementById('f_file');

async function stopStream(stream){ if(stream) stream.getTracks().forEach(t=>t.stop()); }

function createOverlay(){
  const overlay = document.createElement('div');
  overlay.id = 'cameraOverlay';
  overlay.style = `position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:2000;`;

  const card = document.createElement('div');
  card.style = `width:95%;max-width:420px;background:#fff;border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;`;

  const video = document.createElement('video');
  video.autoplay = true;
  video.playsInline = true;
  video.style = `width:100%;border-radius:8px;background:#000;`;

  const info = document.createElement('div');
  info.className = 'small muted';
  info.style.textAlign = 'center';
  info.textContent = 'انتظر فتح الكاميرا...';

  const row = document.createElement('div');
  row.style = `display:flex;gap:8px;justify-content:space-between;`;

  const flipBtn = document.createElement('button');
  flipBtn.className = 'btn alt';
  flipBtn.textContent = 'تبديل الكاميرا';
  flipBtn.style.display = 'none';

  const captureBtn = document.createElement('button');
  captureBtn.className = 'btn';
  captureBtn.textContent = 'التقاط';

  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn alt';
  cancelBtn.textContent = 'إلغاء';

  row.append(flipBtn, captureBtn, cancelBtn);
  card.append(video, info, row);
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  return { overlay, video, captureBtn, cancelBtn, flipBtn, info };
}

useCameraBtn.addEventListener('click', async () => {
  useCameraBtn.disabled = true;
  let stream = null;
  let devices = [];
  let currentDeviceId = null;

  try { devices = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput'); } catch {}
  const ui = createOverlay();
  const { overlay, video, captureBtn, cancelBtn, flipBtn, info } = ui;

  if(devices.length > 1) flipBtn.style.display = 'inline-block';

  async function start(deviceId){
    try{
      await stopStream(stream);
      stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: deviceId ? undefined : 'environment', width:{ideal:1280}, height:{ideal:720} },
        audio:false
      });
      video.srcObject = stream;
      info.textContent = 'اضغط "التقاط" لالتقاط الصورة';
      const track = stream.getVideoTracks()[0];
      currentDeviceId = track.getSettings().deviceId;
    }catch(e){ alert('تعذر تشغيل الكاميرا'); cleanup(); }
  }

  function cleanup(){ stopStream(stream); overlay.remove(); useCameraBtn.disabled = false; }

  flipBtn.onclick = async ()=>{
    if(devices.length < 2) return;
    const ids = devices.map(d=>d.deviceId);
    let i = ids.indexOf(currentDeviceId);
    i = (i+1)%ids.length;
    start(ids[i]);
  };

  cancelBtn.onclick = cleanup;

  captureBtn.onclick = ()=>{
    const c = document.createElement('canvas');
    c.width = video.videoWidth; c.height = video.videoHeight;
    c.getContext('2d').drawImage(video,0,0,c.width,c.height);
    c.toBlob(blob=>{
      const f = new File([blob], `camera-${Date.now()}.png`, {type:'image/png'});
      const dt = new DataTransfer(); dt.items.add(f);
      fileInput.files = dt.files;
      cleanup();
    }, 'image/png');
  };

  if(devices.length) start(devices[0].deviceId); else start();
});

</script>
</body>
</html>
