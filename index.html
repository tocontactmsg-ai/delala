<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø¯Ù„Ø§Ù„Ø© â€” Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Admin compatible)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  /* (styles same as before + admin button) */
  *{box-sizing:border-box;font-family:"Tajawal",sans-serif}
  body{margin:0;background:#f7fbff;color:#0b1320;line-height:1.4}
  .container{max-width:1100px;margin:16px auto;padding:12px}
  header{background:#0078d7;color:#fff;padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
  .brand{display:flex;flex-direction:column}
  .brand .title{font-size:20px;font-weight:900;letter-spacing:0.5px}
  .brand .tagline{font-size:13px;opacity:0.95}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button[aria-current="true"]{background:#fff;color:#0078d7;border:0}

  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;align-items:center}
  .controls .search{flex:1;min-width:180px}
  input[type="text"], input[type="search"], select, textarea{padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;font-size:15px;background:#fff}
  .btn{background:#0078d7;color:#fff;padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn.alt{background:#6b7280}
  .small{font-size:13px;color:#333}

  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
  @media (min-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 8px 26px rgba(11,19,32,0.06);display:flex;flex-direction:column;height:100%;transition:transform .12s,box-shadow .12s}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(11,19,32,0.09)}
  .media{height:180px;background:#f0f4f8;display:flex;align-items:center;justify-content:center;cursor:zoom-in;position:relative}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .media .noimg{padding:12px;color:#7b8794}
  .body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:700;font-size:17px;line-height:1.15}
  .desc{color:#334155;font-size:14px;max-height:3.2em;overflow:hidden;text-overflow:ellipsis}
  .meta{display:flex;gap:8px;align-items:center;margin-top:auto;flex-wrap:wrap}
  .badge{background:#eef8ff;color:#0078d7;padding:6px 8px;border-radius:999px;font-weight:700;direction:ltr}
  .muted{color:#6b7280;font-size:13px}
  .actions{display:flex;gap:8px}
  .link-like{background:transparent;border:0;color:#0078d7;cursor:pointer;padding:6px}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:999}
  .modal.open{display:flex}
  .modalCard{background:#fff;border-radius:12px;max-width:920px;width:96%;max-height:92vh;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
  .modalTop{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
  .modalMedia{width:320px;max-width:42%;min-width:220px;background:#f4f6f9;border-radius:10px;overflow:hidden}
  .modalMedia img{width:100%;height:100%;object-fit:cover;display:block}
  .modalBody{flex:1;display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px}
  .fullDesc{white-space:pre-wrap;background:#fbfdff;padding:10px;border-radius:8px}
  .modalFooter{display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .copyBtn{background:#eef6ff;border:1px solid #cfe9ff;padding:8px;border-radius:8px;color:#0078d7;cursor:pointer}

  @media (max-width:600px){ .modalTop{flex-direction:column} .modalMedia{width:100%;max-width:100%} }

  .loadMore{display:block;margin:14px auto;padding:10px 14px;border-radius:10px;border:1px solid #e6eef8;background:#fff;cursor:pointer}
  .skeleton{background:linear-gradient(90deg,#f2f6fb,#eef5ff,#f2f6fb);background-size:200% 100%;animation:shimmer 1.6s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .refBox{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .refCode{background:#f0f9ff;padding:6px 12px;border-radius:10px;color:#0078d7;font-weight:800;letter-spacing:0.8px}

  /* Admin floating button & panel */
  .adminBtn{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;z-index:1200}
  .adminPanel{position:fixed;right:18px;bottom:70px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.15);z-index:1200;width:320px;max-width:calc(100% - 40px);display:none}
  .adminPanel.open{display:block}
  .adminPanel input, .adminPanel select{width:100%;margin-bottom:8px}
  .adminRow{display:flex;gap:8px}
  .adminNote{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div class="brand">
      <div class="title">Ø§Ù„Ø¯Ù„Ø§Ù„Ø©</div>
      <div class="tagline small">Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨Ø³Ø·Ø© â€” Ø§Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø£Ùˆ ØªØµÙÙ‘Ø­ Ù…Ø§ Ø£Ø±Ø³Ù„Ù‡ Ø§Ù„Ø²ÙˆØ§Ø±</div>
    </div>

    <nav aria-label="ÙˆØ§Ø¬Ù‡Ø©">
      <button data-target="home" class="nav-btn" aria-current="true">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button data-target="send" class="nav-btn">Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</button>
      <button data-target="policy" class="nav-btn">Ø§Ù„Ø´Ø±ÙˆØ·</button>
    </nav>
  </header>

  <div class="controls" role="search" aria-label="Ø¨Ø­Ø« ÙˆØªØ­ÙƒÙ…">
    <div class="search" style="min-width:160px">
      <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹">
    </div>
    <div style="width:200px">
      <select id="catFilter"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refresh" class="btn alt">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
      <div id="count" class="small" aria-live="polite">ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <main>
    <section id="home" aria-live="polite">
      <div id="grid" class="grid" role="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª"></div>
      <div id="noitems" style="display:none;text-align:center;margin-top:12px" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
      <button id="loadMore" class="loadMore" style="display:none">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
    </section>

    <section id="send" style="display:none">
      <div class="panel">
        <h3>Ø£Ø±Ø³Ù„ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</h3>
        <div style="display:grid;gap:8px">
          <input id="f_name" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
          <textarea id="f_desc" placeholder="ÙˆØµÙ" rows="4"></textarea>
          <input id="f_loc" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <input id="f_contact" placeholder="ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„">
          <input id="f_cat" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø§Øª, Ø¹Ù‚Ø§Ø±...)">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="f_file" type="file" accept="image/*">
            <button id="useCameraBtn" class="btn">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="submitBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
            <div id="submitStatus" class="small"></div>
          </div>

          <div id="afterSubmit" style="display:none;margin-top:8px">
            <div>Ø±Ù…Ø² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</div>
            <div class="refBox" style="margin-top:6px">
              <div id="refCode" class="refCode"></div>
              <button id="copyRef" class="copyBtn">Ù†Ø³Ø®</button>
              <a id="openWa" class="small" target="_blank" style="margin-left:8px;color:#0078d7"></a>
            </div>
          </div>

          <div id="fallbackJson" style="display:none;margin-top:8px">
            <div class="small">Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø±Ø³Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ±:</div>
            <pre id="fallbackArea"></pre>
          </div>
        </div>
      </div>
    </section>

    <section id="policy" style="display:none">
      <div class="panel">
        <h3>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3>
        <p class="small">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø§Ù„Ù Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡.</p>
      </div>
    </section>
  </main>
</div>

<!-- details modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard" role="document" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div id="modalTitle" style="font-weight:800;font-size:18px"></div>
        <div id="modalMeta" class="small muted" style="margin-top:6px"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="refBox">
          <div id="modalRef" class="refCode"></div>
          <button id="modalCopy" class="copyBtn">Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²</button>
        </div>
        <button id="modalClose" class="btn alt">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="modalTop">
      <div class="modalMedia" id="modalMedia"><div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div></div>

      <div class="modalBody">
        <div id="modalDescription" class="fullDesc"></div>
        <div class="row">
          <div class="field"><div class="small">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div id="modalLoc" class="muted"></div></div>
          <div class="field"><div class="small">Ø§Ù„ØªØµÙ†ÙŠÙ</div><div id="modalCat" class="badge"></div></div>
        </div>
        <div class="row">
          <div class="field"><div class="small">Ø§Ù„ØªÙˆØ§ØµÙ„</div><div id="modalContact" class="muted"></div></div>
          <div class="field"><div class="small">Ù…Ø±Ø³Ù„ Ø¨ØªØ§Ø±ÙŠØ®</div><div id="modalCreated" class="muted"></div></div>
        </div>

        <div id="adminEditHint" style="display:none;margin-top:8px" class="small muted"></div>
      </div>
    </div>

    <div class="modalFooter">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <a id="modalWhats" class="btn" target="_blank">Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± WhatsApp</a>
        <button id="modalEdit" class="btn" style="display:none">ØªØ­Ø±ÙŠØ± (Ù…Ø³Ø¤ÙˆÙ„)</button>
        <button id="modalFallback" class="btn alt" style="display:none">Ø¹Ø±Ø¶ JSON Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·</button>
      </div>
      <div class="small muted">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ† Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª ÙˆØ¥Ø¯Ø§Ø±ØªÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</div>
    </div>
  </div>
</div>

<!-- admin floating button + panel -->
<button id="adminBtn" class="adminBtn">ğŸ”§ Admin</button>
<div id="adminPanel" class="adminPanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø¨ÙŠÙ†Ø©)</strong>
    <button id="closeAdmin" class="btn alt" style="padding:6px 8px">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <input id="admin_repo" placeholder="owner/repo (Ù…Ø«Ø§Ù„: user/repo)">
  <input id="admin_branch" placeholder="branch (main)" value="main">
  <input id="admin_session_pat" placeholder="Session PAT (ÙŠÙØ­ÙØ¸ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙ‚Ø·)">
  <div class="adminRow"><button id="setSessionPat" class="btn">ØªØ¹ÙŠÙŠÙ† PAT Ù…Ø¤Ù‚Øª</button><button id="clearSessionPat" class="btn alt">Ù…Ø³Ø­ PAT</button></div>
  <label style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="allowPublic" type="checkbox"> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…</label>
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="saveAdminCfg" class="btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¨Ø¯ÙˆÙ† PAT)</button>
    <button id="revokeNote" class="btn alt">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¨Ø·Ø§Ù„</button>
  </div>
  <div class="adminNote">Ù…Ù„Ø§Ø­Ø¸Ø©: PAT Ø§Ù„Ù…Ø¤Ù‚Øª ÙŠÙØ®Ø²Ù‘Ù† ÙÙŠ Session Storage ÙÙ‚Ø·â€”Ø³ÙŠÙÙÙ‚Ø¯ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨. Ù„Ø§ ØªØ­ÙØ¸ ØªÙˆÙƒÙ† ÙÙŠ localStorage.</div>
</div>

<script>
/* ---------------------- Utilities ---------------------- */
const CFG_KEY = 'static_ads_cfg_v1';
const CACHE_KEY = 'static_ads_cache_v1';
const WA_NUMBER = '249964147954';
const PAGE_SIZE = 12;
const OPT_FULL = { maxWidth:1600, maxHeight:1200, quality:0.78, outputType:'image/webp' };
const OPT_THUMB = { maxWidth:600, maxHeight:400, quality:0.65, outputType:'image/webp' };

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c)); }
function debounce(fn,t=300){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a),t); }; }
function genRef(){ return 'R' + Date.now().toString(36).slice(-6).toUpperCase(); }
function readCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)||'{}') }catch(e){ return {} } }
function saveCfg(cfg){ const c=Object.assign({},cfg); delete c.session_pat; delete c.pat; localStorage.setItem(CFG_KEY, JSON.stringify(c)); }

/* session PAT helpers (sessionStorage only) */
function setSessionPat(v){ if(v){ sessionStorage.setItem('static_session_pat', v); } else { sessionStorage.removeItem('static_session_pat'); } updateAdminUi(); }
function getSessionPat(){ return sessionStorage.getItem('static_session_pat') || null; }
function clearSessionPat(){ setSessionPat(null); }

/* admin availability check */
function adminAvailable(){ const cfg = readCfg(); return !!((cfg.repo && cfg.branch) && (cfg.pat || getSessionPat())); }

/* ------------------ Robust ghPut (retries + merge) ------------------ */
/*
  ghPut: puts JSON content to a repo path (contents API) with retries on SHA mismatches.
  - pat: token string
  - repo: owner/repo
  - path: path in repo
  - base64content: string (base64 content, not data: prefix)
  - message: commit message
  - branch: branch name
*/
async function ghPut(pat, repo, path, base64content, message, branch='main', maxRetries=4){
  if(!pat) throw new Error('PAT required for write');
  const [owner, repoName] = (repo||'').split('/');
  if(!owner || !repoName) throw new Error('invalid repo');

  const apiBase = `https://api.github.com/repos/${owner}/${repoName}/contents/${encodeURIComponent(path)}`;
  const headers = { Authorization: 'token ' + pat, Accept: 'application/vnd.github.v3+json' };

  for(let attempt=1; attempt<=maxRetries; attempt++){
    // fetch metadata to get current sha
    let sha = undefined;
    try{
      const metaResp = await fetch(apiBase + `?ref=${encodeURIComponent(branch)}`, { headers });
      if(metaResp.status === 200){
        const metaJson = await metaResp.json();
        sha = metaJson.sha;
      } else if(metaResp.status === 404){
        sha = undefined; // create new
      } else if(metaResp.status === 401 || metaResp.status === 403){
        throw new Error('PAT invalid or missing permission');
      }
    }catch(e){
      // if cannot fetch meta, allow attempt to try (maybe creating new); but if last attempt, throw
      if(attempt === maxRetries) throw e;
    }

    // prepare body
    const body = { message, content: base64content, branch };
    if(sha) body.sha = sha;

    const putResp = await fetch(apiBase, { method: 'PUT', headers, body: JSON.stringify(body) });
    const text = await putResp.text();
    let parsed = null;
    try{ parsed = JSON.parse(text); }catch(e){ parsed = null; }

    if(putResp.ok){
      return parsed;
    }

    const errMsg = (parsed && parsed.message) ? parsed.message.toLowerCase() : text.toLowerCase();
    // If conflict or sha mismatch, attempt to refetch and retry
    if((putResp.status === 409 || putResp.status === 422 || errMsg.includes('does not match') || errMsg.includes('sha')) && attempt < maxRetries){
      // small backoff
      await new Promise(r => setTimeout(r, 250 * attempt));
      // continue to next attempt which refetches sha
      continue;
    }

    // auth errors
    if(putResp.status === 401 || putResp.status === 403){
      throw new Error('PUT failed: PAT invalid or missing permission: ' + (parsed && parsed.message ? parsed.message : putResp.status));
    }

    // other fatal error
    throw new Error('PUT failed: ' + (parsed && parsed.message ? parsed.message : text));
  }
}

/* helper to get raw JSON from repo path (tries common locations) */
async function fetchAdsJsonFromRepo(repo, branch='main'){
  const [owner, repoName] = (repo||'').split('/');
  const candidates = [
    `https://raw.githubusercontent.com/${owner}/${repoName}/${branch}/static/ads.json`,
    `https://raw.githubusercontent.com/${owner}/${repoName}/${branch}/ads.json`
  ];
  for(const u of candidates){
    try{
      const r = await fetch(u, { cache: 'no-cache' });
      if(!r.ok) continue;
      return await r.json();
    }catch(e){ continue; }
  }
  return null;
}

/* ------------------ Public UI: load/render ads ------------------ */
let ads = [];
const grid = document.getElementById('grid');
const qEl = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const countEl = document.getElementById('count');
const loadMoreBtn = document.getElementById('loadMore');

let showing = 0;

function showSkeleton(){
  grid.innerHTML = '';
  for(let i=0;i<6;i++){
    const sk=document.createElement('div'); sk.className='card';
    sk.innerHTML = `<div class="media skeleton"></div><div class="body"><div class="skeleton" style="height:18px;width:60%;border-radius:6px"></div><div style="height:12px"></div><div class="skeleton" style="height:12px;width:100%;border-radius:6px"></div></div>`;
    grid.appendChild(sk);
  }
}

async function loadAds(){
  try{
    showSkeleton();
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
    if(cached && (Date.now() - cached.t < 30_000) && cached.data){ ads = cached.data; renderGrid(ads); buildCategories(); countEl.textContent = `${ads.length} Ø¥Ø¹Ù„Ø§Ù†`; return; }

    // try relative paths (static hosting)
    const paths = ['./static/ads.json','./ads.json','/static/ads.json'];
    let items = null;
    for(const p of paths){
      try{ const res = await fetch(p, { cache: 'no-cache' }); if(!res.ok) continue; items = await res.json(); break; }catch(e){ continue; }
    }
    if(!items){ grid.innerHTML = '<div style="padding:16px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>'; countEl.textContent='0 Ø¥Ø¹Ù„Ø§Ù†'; return; }
    ads = Array.isArray(items) ? items : [];
    ads.sort((a,b)=> (new Date(b.created_at||0)) - (new Date(a.created_at||0)));
    localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), data: ads }));
    renderGrid(ads); buildCategories(); countEl.textContent = `${ads.length} Ø¥Ø¹Ù„Ø§Ù†`;
  }catch(e){
    console.error(e);
    grid.innerHTML = '<div style="padding:16px">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>';
  }
}

function renderGrid(list){
  grid.innerHTML = '';
  showing = Math.min(PAGE_SIZE, list.length);
  if(!list.length){ document.getElementById('noitems').style.display='block'; loadMoreBtn.style.display='none'; countEl.textContent='0 Ø¥Ø¹Ù„Ø§Ù†'; return; }
  document.getElementById('noitems').style.display='none';
  appendCards(list.slice(0, showing));
  loadMoreBtn.style.display = list.length > showing ? 'block' : 'none';
}

function appendCards(chunk){
  const frag = document.createDocumentFragment();
  chunk.forEach(a=>{
    const el = document.createElement('div'); el.className='card'; el.setAttribute('role','listitem');
    const thumb = (a.thumb || a.image || '').replace(/^\//,'');
    const mediaHtml = thumb ? `<img src="${escapeHtml(thumb)}" loading="lazy" alt="${escapeHtml(a.name||'')}" />` : `<div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div>`;
    const cat = a.category || 'Ø¹Ø§Ù…';
    const ref = escapeHtml(a.ref_code||a.code||'');
    el.innerHTML = `<div class="media">${mediaHtml}</div>
      <div class="body"><div class="title">${escapeHtml(a.name||'')}</div>
      <div class="desc">${escapeHtml(a.description||'')}</div>
      <div class="meta"><div class="badge">${escapeHtml(cat)}</div><div class="muted">ğŸ“ ${escapeHtml(a.location||'')}</div><div style="margin-left:auto" class="muted">${ref}</div></div></div>`;
    frag.appendChild(el);
    el.addEventListener('click', ()=> openDetails(a));
    const img = el.querySelector('img'); if(img) img.addEventListener('error', ()=> img.style.display='none');
  });
  grid.appendChild(frag);
}

loadMoreBtn.addEventListener('click', ()=> {
  const remaining = ads.slice(showing, showing + PAGE_SIZE);
  appendCards(remaining);
  showing += remaining.length;
  loadMoreBtn.style.display = showing < ads.length ? 'block' : 'none';
});

function buildCategories(){
  const s = new Set(); ads.forEach(a=> a.category && s.add(a.category));
  catFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
  Array.from(s).sort().forEach(c=> { const o = document.createElement('option'); o.value=c; o.innerText=c; catFilter.appendChild(o); });
}

document.getElementById('refresh').addEventListener('click', ()=> { localStorage.removeItem(CACHE_KEY); loadAds(); });
document.getElementById('q').addEventListener('input', debounce(()=> filterList(), 250));
catFilter.addEventListener('change', ()=> filterList());

function filterList(){
  const q = qEl.value.trim().toLowerCase();
  const cat = catFilter.value;
  let filtered = ads.filter(a=> {
    if(cat && a.category !== cat) return false;
    if(!q) return true;
    return (a.name||'').toLowerCase().includes(q) || (a.ref_code||a.code||'').toLowerCase().includes(q) || (a.location||'').toLowerCase().includes(q) || (a.description||'').toLowerCase().includes(q);
  });
  renderGrid(filtered);
  countEl.textContent = `${filtered.length} Ø¥Ø¹Ù„Ø§Ù†`;
}

/* ---------------- Details modal & edit (uses ghPut) ---------------- */
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalMeta=document.getElementById('modalMeta');
const modalMedia=document.getElementById('modalMedia');
const modalDescription=document.getElementById('modalDescription');
const modalLoc=document.getElementById('modalLoc');
const modalCat=document.getElementById('modalCat');
const modalContact=document.getElementById('modalContact');
const modalCreated=document.getElementById('modalCreated');
const modalRef=document.getElementById('modalRef');
const modalCopy=document.getElementById('modalCopy');
const modalWhats=document.getElementById('modalWhats');
const modalEdit=document.getElementById('modalEdit');
const modalFallback=document.getElementById('modalFallback');
const adminEditHint=document.getElementById('adminEditHint');

let currentItem=null;

function openDetails(item){
  currentItem=item;
  modalTitle.textContent=item.name||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  modalMeta.textContent=`Ø±Ù…Ø²: ${item.ref_code||item.code||''}`;
  modalRef.textContent=item.ref_code||item.code||'';
  modalDescription.textContent=item.description||'-';
  modalLoc.textContent=item.location||'-';
  modalCat.textContent=item.category||'Ø¹Ø§Ù…';
  modalContact.textContent=item.contact||'-';
  modalCreated.textContent=item.created_at? new Date(item.created_at).toLocaleString(): '-';
  modalMedia.innerHTML='';
  const imgPath=item.image||item.thumb||'';
  if(imgPath){
    const img=document.createElement('img'); img.src=imgPath.replace(/^\//,''); img.alt=item.name||'';
    img.addEventListener('error', ()=> modalMedia.innerHTML='<div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div>');
    img.addEventListener('click', ()=> window.open(img.src,'_blank'));
    modalMedia.appendChild(img);
  } else modalMedia.innerHTML='<div class="noimg small">Ù„Ø§ ØµÙˆØ±Ø©</div>';
  modalWhats.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ù…Ø² ${modalRef.textContent}`)}`;
  modalCopy.onclick = ()=> navigator.clipboard?.writeText(modalRef.textContent).then(()=> alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®'));
  if(adminAvailable()){
    modalEdit.style.display='inline-block';
    modalEdit.onclick = ()=> openEditModal(item);
    modalFallback.style.display='inline-block';
    modalFallback.onclick = ()=> alert(JSON.stringify(item,null,2));
    adminEditHint.style.display='none';
  } else {
    modalEdit.style.display='none';
    modalFallback.style.display='none';
    adminEditHint.style.display='block';
    adminEditHint.textContent = 'Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ£Ø¯Ø®Ù„ repo ÙˆPAT Ø§Ù„Ø¬Ù„Ø³Ø©';
  }
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
document.getElementById('modalClose').addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); currentItem=null; }

/* Inline edit modal with safe merge+ghPut */
function openEditModal(item){
  // reuse existing modalBody area to inject a simple form
  const form = document.createElement('div'); form.style.display='flex'; form.style.flexDirection='column'; form.style.gap='8px';
  const name = Object.assign(document.createElement('input'),{value:item.name||''});
  const desc = Object.assign(document.createElement('textarea'),{rows:4,value:item.description||''});
  const loc = Object.assign(document.createElement('input'),{value:item.location||''});
  const contact = Object.assign(document.createElement('input'),{value:item.contact||''});
  const cat = Object.assign(document.createElement('input'),{value:item.category||''});
  const fileInput = Object.assign(document.createElement('input'),{type:'file', accept:'image/*'});
  const saveBtn = Object.assign(document.createElement('button'),{className:'btn',textContent:'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'});
  const cancelBtn = Object.assign(document.createElement('button'),{className:'btn alt',textContent:'Ø¥Ù„ØºØ§Ø¡'});
  const status = Object.assign(document.createElement('div'),{className:'small muted'});

  form.appendChild(Object.assign(document.createElement('label'),{textContent:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'})); form.appendChild(name);
  form.appendChild(Object.assign(document.createElement('label'),{textContent:'Ø§Ù„ÙˆØµÙ'})); form.appendChild(desc);
  form.appendChild(Object.assign(document.createElement('label'),{textContent:'Ø§Ù„Ù…ÙˆÙ‚Ø¹'})); form.appendChild(loc);
  form.appendChild(Object.assign(document.createElement('label'),{textContent:'Ø§Ù„ØªÙˆØ§ØµÙ„'})); form.appendChild(contact);
  form.appendChild(Object.assign(document.createElement('label'),{textContent:'Ø§Ù„ØªØµÙ†ÙŠÙ'})); form.appendChild(cat);
  form.appendChild(Object.assign(document.createElement('label'),{textContent:'ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'})); form.appendChild(fileInput);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
  actions.appendChild(saveBtn); actions.appendChild(cancelBtn); form.appendChild(actions); form.appendChild(status);
  modalDescription.parentNode.insertBefore(form, modalDescription.nextSibling);
  modalDescription.style.display='none';

  cancelBtn.onclick = ()=>{ form.remove(); modalDescription.style.display='block'; };

  saveBtn.onclick = async ()=>{
    const cfg = readCfg();
    const pat = cfg.pat || getSessionPat();
    if(!pat || !cfg.repo){ status.textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ PAT Ø£Ùˆ repo Ù…ÙØ¹Ø¯Ù‘'; return; }
    try{
      saveBtn.disabled = true; status.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      const updated = Object.assign({}, item);
      updated.name = name.value.trim();
      updated.description = desc.value.trim();
      updated.location = loc.value.trim();
      updated.contact = contact.value.trim();
      updated.category = cat.value.trim();
      // image upload first (if any)
      const f = fileInput.files[0];
      if(f){
        const safe = (f.name||'').replace(/[^a-z0-9.\-_]/ig,'_').slice(0,120);
        const fullName = `${(updated.ref_code||updated.code||genRef())}-${safe}`;
        const thumbName = `${(updated.ref_code||updated.code||genRef())}-thumb-${safe}`;
        const optFull = await optimizeImageFile(f, OPT_FULL);
        await ghPut(pat, cfg.repo, `static/images/${fullName}`, optFull.base64, `upload ${fullName}`, cfg.branch || 'main');
        const optThumb = await optimizeImageFile(f, OPT_THUMB);
        await ghPut(pat, cfg.repo, `static/images/thumbs/${thumbName}`, optThumb.base64, `upload ${thumbName}`, cfg.branch || 'main');
        updated.image = `static/images/${fullName}`;
        updated.thumb = `static/images/thumbs/${thumbName}`;
      }
      // Now merge into latest ads.json fetched from repo (if available), else fallback to cached path
      let latestAds = null;
      try{
        latestAds = await fetchAdsJsonFromRepo(cfg.repo, cfg.branch||'main');
      }catch(e){ latestAds = null; }
      if(!Array.isArray(latestAds)){
        // fallback to local cached or current ads
        latestAds = ads.slice();
      }
      // replace or unshift
      const key = updated.ref_code || updated.code;
      const idx = latestAds.findIndex(x => (x.ref_code||x.code) && (x.ref_code===key || x.code===key));
      if(idx >= 0) latestAds[idx] = updated; else latestAds.unshift(updated);
      // commit using ghPut with retries
      const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(latestAds))));
      await ghPut(pat, cfg.repo, 'static/ads.json', base64, `edit ad ${key}`, cfg.branch || 'main');
      status.textContent='ØªÙ… Ø§Ù„Ø­ÙØ¸';
      localStorage.removeItem(CACHE_KEY);
      loadAds();
      form.remove(); modalDescription.style.display='block';
    }catch(err){
      console.error(err);
      status.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (err.message || err);
    } finally { saveBtn.disabled = false; }
  };
}

/* ---------------- Submission flow ---------------- */
const submitBtn = document.getElementById('submitBtn');
const submitStatus = document.getElementById('submitStatus');
const afterSubmit = document.getElementById('afterSubmit');
const refCodeEl = document.getElementById('refCode');
const fallbackArea = document.getElementById('fallbackArea');
const fallbackBox = document.getElementById('fallbackJson');
const openWa = document.getElementById('openWa');

async function uploadProposalToRepo(cfg, payload, file){
  const branch = cfg.branch || 'main';
  if(file){
    const safe = file.name.replace(/[^a-z0-9.\-_]/ig,'_');
    const fullName = `${payload.ref_code}-${safe}`;
    const thumbName = `${payload.ref_code}-thumb-${safe}`;
    const optFull = await optimizeImageFile(file, OPT_FULL);
    await ghPut(cfg.pat, cfg.repo, `static/images/${fullName}`, optFull.base64, `upload ${fullName}`, branch);
    const optThumb = await optimizeImageFile(file, OPT_THUMB);
    await ghPut(cfg.pat, cfg.repo, `static/images/thumbs/${thumbName}`, optThumb.base64, `upload ${thumbName}`, branch);
    payload.image = `static/images/${fullName}`;
    payload.thumb = `static/images/thumbs/${thumbName}`;
  }
  const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  await ghPut(cfg.pat, cfg.repo, `static/proposals/${payload.ref_code}.json`, base64, `proposal ${payload.ref_code}`, branch);
}

submitBtn.addEventListener('click', async ()=>{
  submitBtn.disabled=true; submitStatus.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯...';
  const ref = genRef();
  const data = {
    ref_code: ref,
    name: document.getElementById('f_name').value.trim(),
    description: document.getElementById('f_desc').value.trim(),
    location: document.getElementById('f_loc').value.trim(),
    contact: document.getElementById('f_contact').value.trim(),
    category: document.getElementById('f_cat').value.trim(),
    created_at: new Date().toISOString()
  };
  refCodeEl.textContent = data.ref_code; afterSubmit.style.display='block';
  const file = document.getElementById('f_file').files[0];
  let cfg = {};
  try { cfg = JSON.parse(localStorage.getItem(CFG_KEY) || '{}'); } catch(e){ cfg = {}; }
  // allow session PAT too (sessionStorage)
  if((cfg.pat || sessionStorage.getItem('static_session_pat')) && cfg.repo && cfg.allow_public_submissions){
    submitStatus.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹...';
    try{
      const writeCfg = Object.assign({}, cfg);
      if(!writeCfg.pat) writeCfg.pat = sessionStorage.getItem('static_session_pat');
      await uploadProposalToRepo(writeCfg, data, file);
      submitStatus.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      fallbackBox.style.display='none';
      localStorage.removeItem(CACHE_KEY);
      loadAds();
    }catch(err){
      console.error(err);
      submitStatus.textContent = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
      fallbackBox.style.display='block';
      fallbackArea.textContent = JSON.stringify(data,null,2);
    } finally { submitBtn.disabled=false; }
  } else {
    submitStatus.textContent='Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„';
    fallbackBox.style.display='block';
    fallbackArea.textContent = JSON.stringify(data,null,2);
    submitBtn.disabled=false;
  }
  // WhatsApp
  try{
    const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ÙˆØµÙ„Ù†ÙŠ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ù…Ø²: ${data.ref_code}\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${data.name||'-'}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${data.location||'-'}`;
    const waUrl = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(message)}`;
    openWa.href = waUrl; openWa.textContent = 'ÙØªØ­ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
    window.open(waUrl,'_blank');
  }catch(e){ console.warn('wa error', e); }
});

/* ---------------- Admin panel (session PAT) ---------------- */
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const closeAdmin = document.getElementById('closeAdmin');
const admin_repo = document.getElementById('admin_repo');
const admin_branch = document.getElementById('admin_branch');
const admin_session_pat = document.getElementById('admin_session_pat');
const setSessionPatBtn = document.getElementById('setSessionPat');
const clearSessionPatBtn = document.getElementById('clearSessionPat');
const allowPublicEl = document.getElementById('allowPublic');
const saveAdminCfgBtn = document.getElementById('saveAdminCfg');
const revokeNoteBtn = document.getElementById('revokeNote');

adminBtn.addEventListener('click', ()=>{ adminPanel.classList.toggle('open'); adminPanel.setAttribute('aria-hidden', adminPanel.classList.contains('open') ? 'false' : 'true'); loadAdminUi(); });
closeAdmin.addEventListener('click', ()=>{ adminPanel.classList.remove('open'); adminPanel.setAttribute('aria-hidden','true'); });

function loadAdminUi(){
  const cfg = readCfg();
  admin_repo.value = cfg.repo || '';
  admin_branch.value = cfg.branch || 'main';
  allowPublicEl.checked = !!cfg.allow_public_submissions;
  admin_session_pat.value = sessionStorage.getItem('static_session_pat') || '';
  updateAdminUi();
}

function updateAdminUi(){
  const hasPat = !!sessionStorage.getItem('static_session_pat') || !!readCfg().pat;
  setSessionPatBtn.disabled = false;
  clearSessionPatBtn.disabled = !hasPat;
}

setSessionPatBtn.addEventListener('click', ()=>{ const v = admin_session_pat.value.trim(); if(!v) return alert('Ø£Ù„ØµÙ‚ PAT'); setSessionPat(v); alert('ØªÙ… ØªØ¹ÙŠÙŠÙ† PAT Ù…Ø¤Ù‚ØªØ§Ù‹ (Ø¬Ù„Ø³Ø©)'); updateAdminUi(); });
clearSessionPatBtn.addEventListener('click', ()=>{ if(!confirm('Ù…Ø³Ø­ PAT Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¢Ù†ØŸ')) return; clearSessionPat(); admin_session_pat.value=''; updateAdminUi(); alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); });
saveAdminCfgBtn.addEventListener('click', ()=>{ const repo = admin_repo.value.trim(); const branch = admin_branch.value.trim() || 'main'; const allow = allowPublicEl.checked; if(!repo) return alert('Ø£Ø¯Ø®Ù„ owner/repo'); saveCfg({ repo, branch, allow_public_submissions: allow }); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¨Ø¯ÙˆÙ† PAT)'); loadAdminUi(); loadAds(); });
revokeNoteBtn.addEventListener('click', ()=>{ alert('Ù„Ø¥Ø¨Ø·Ø§Ù„ PAT: Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ GitHub > Settings > Developer settings > Personal access tokensØŒ ÙˆØ§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ£Ø¨Ø·Ù„Ù‡.'); });

/* ---------------- Init ---------------- */
(async function init(){ loadAdminUi(); loadAds(); })();
</script>
</body>
</html>
